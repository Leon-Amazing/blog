<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.34">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="logo.png"><title>WebGL | 数据可视化</title><meta name="description" content="Leon's library">
    <link rel="modulepreload" href="/visual/assets/app.1a1d05a4.js"><link rel="modulepreload" href="/visual/assets/WebGL.html.abd463e0.js"><link rel="modulepreload" href="/visual/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/visual/assets/WebGL.html.300dd381.js">
    <link rel="stylesheet" href="/visual/assets/style.59d3f416.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/visual/" class=""><img class="logo" src="/visual/logo.png" alt="数据可视化"><span class="site-name can-hide">数据可视化</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>WebGL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a aria-current="page" href="/visual/webgl/WebGL.html" class="router-link-active router-link-exact-active router-link-active" aria-label="WebGL"><!--[--><!--]--> WebGL <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>GLSL ES</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-basic.md" class="" aria-label="GLSL ES基础"><!--[--><!--]--> GLSL ES基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-practice.md" class="" aria-label="GLSL ES实践"><!--[--><!--]--> GLSL ES实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>WebGL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a aria-current="page" href="/visual/webgl/WebGL.html" class="router-link-active router-link-exact-active router-link-active" aria-label="WebGL"><!--[--><!--]--> WebGL <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>GLSL ES</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-basic.md" class="" aria-label="GLSL ES基础"><!--[--><!--]--> GLSL ES基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-practice.md" class="" aria-label="GLSL ES实践"><!--[--><!--]--> GLSL ES实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">WebGL <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#一、webgl-介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、WebGL-介绍"><!--[--><!--]--> 一、WebGL-介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#二、webgl-基础知识" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、webgl 基础知识"><!--[--><!--]--> 二、webgl 基础知识 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-刷底色" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.刷底色"><!--[--><!--]--> 1.刷底色 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-webgl-坐标系" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.webgl 坐标系"><!--[--><!--]--> 2.webgl 坐标系 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-webgl-画一个点" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.webgl 画一个点"><!--[--><!--]--> 3.webgl 画一个点 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#三、js-与着色器间的数据传输" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、js 与着色器间的数据传输"><!--[--><!--]--> 三、js 与着色器间的数据传输 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-js-控制顶点位置" class="router-link-active router-link-exact-active sidebar-item" aria-label="1. js 控制顶点位置"><!--[--><!--]--> 1. js 控制顶点位置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-鼠标控制点位" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. 鼠标控制点位"><!--[--><!--]--> 2. 鼠标控制点位 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-js-控制顶点尺寸" class="router-link-active router-link-exact-active sidebar-item" aria-label="3. js 控制顶点尺寸"><!--[--><!--]--> 3. js 控制顶点尺寸 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-js-控制顶点的颜色" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. js 控制顶点的颜色"><!--[--><!--]--> 4. js 控制顶点的颜色 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#四、绘制图形" class="router-link-active router-link-exact-active sidebar-item" aria-label="四、绘制图形"><!--[--><!--]--> 四、绘制图形 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-webgl-的绘图方式" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.webgl 的绘图方式"><!--[--><!--]--> 1.webgl 的绘图方式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-绘制多点" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. 绘制多点"><!--[--><!--]--> 2. 绘制多点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-绘制图形" class="router-link-active router-link-exact-active sidebar-item" aria-label="3. 绘制图形"><!--[--><!--]--> 3. 绘制图形 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-绘制矩形" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. 绘制矩形"><!--[--><!--]--> 4. 绘制矩形 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_5-异步绘制多点" class="router-link-active router-link-exact-active sidebar-item" aria-label="5. 异步绘制多点"><!--[--><!--]--> 5. 异步绘制多点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_6-图形转面" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.图形转面"><!--[--><!--]--> 6.图形转面 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#五、矩阵变换" class="router-link-active router-link-exact-active sidebar-item" aria-label="五、矩阵变换"><!--[--><!--]--> 五、矩阵变换 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-平移" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.平移"><!--[--><!--]--> 1.平移 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.旋转"><!--[--><!--]--> 2.旋转 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-缩放" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.缩放"><!--[--><!--]--> 3.缩放 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.矩阵"><!--[--><!--]--> 4.矩阵 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#六、-矩阵复合变换" class="router-link-active router-link-exact-active sidebar-item" aria-label="六、 矩阵复合变换"><!--[--><!--]--> 六、 矩阵复合变换 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-矩阵相乘" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.矩阵相乘"><!--[--><!--]--> 1.矩阵相乘 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-变换规律" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.变换规律"><!--[--><!--]--> 2.变换规律 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-视图矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.视图矩阵"><!--[--><!--]--> 3.视图矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-模型矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.模型矩阵"><!--[--><!--]--> 4.模型矩阵 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#七、颜色与纹理" class="router-link-active router-link-exact-active sidebar-item" aria-label="七、颜色与纹理"><!--[--><!--]--> 七、颜色与纹理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-多-attribute-变量" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.多 attribute 变量"><!--[--><!--]--> 1.多 attribute 变量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-彩色三角形" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.彩色三角形"><!--[--><!--]--> 2.彩色三角形 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-纹理" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.纹理"><!--[--><!--]--> 3.纹理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-纹理合成" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.纹理合成"><!--[--><!--]--> 4.纹理合成 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_5-跨域图像做贴图" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.跨域图像做贴图"><!--[--><!--]--> 5.跨域图像做贴图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_6-视频贴图" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.视频贴图"><!--[--><!--]--> 6.视频贴图 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#八、世界坐标和本地坐标" class="router-link-active router-link-exact-active sidebar-item" aria-label="八、世界坐标和本地坐标"><!--[--><!--]--> 八、世界坐标和本地坐标 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-基本概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-基本概念"><!--[--><!--]--> 1-基本概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-认识世界坐标系、本地坐标系中的点位关系" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-认识世界坐标系、本地坐标系中的点位关系"><!--[--><!--]--> 2-认识世界坐标系、本地坐标系中的点位关系 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#九、深入认知三维世界" class="router-link-active router-link-exact-active sidebar-item" aria-label="九、深入认知三维世界"><!--[--><!--]--> 九、深入认知三维世界 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-用位移矩阵做实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-用位移矩阵做实验"><!--[--><!--]--> 1-用位移矩阵做实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-位移法则" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-位移法则"><!--[--><!--]--> 2-位移法则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-缩放法则" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-缩放法则"><!--[--><!--]--> 3-缩放法则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-旋转法则" class="router-link-active router-link-exact-active sidebar-item" aria-label="4-旋转法则"><!--[--><!--]--> 4-旋转法则 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十、旋转法则之深度探索" class="router-link-active router-link-exact-active sidebar-item" aria-label="十、旋转法则之深度探索"><!--[--><!--]--> 十、旋转法则之深度探索 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-顶点绕单轴逆时针旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-顶点绕单轴逆时针旋转"><!--[--><!--]--> 1-顶点绕单轴逆时针旋转 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-欧拉旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-欧拉旋转"><!--[--><!--]--> 2-欧拉旋转 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-四元数" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-四元数"><!--[--><!--]--> 3-四元数 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十一、正交投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="十一、正交投影矩阵"><!--[--><!--]--> 十一、正交投影矩阵 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-裁剪空间" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-裁剪空间"><!--[--><!--]--> 1-裁剪空间 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-正交投影矩阵的实现原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-正交投影矩阵的实现原理"><!--[--><!--]--> 2-正交投影矩阵的实现原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-正交投影矩阵的代码实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-正交投影矩阵的代码实现"><!--[--><!--]--> 3-正交投影矩阵的代码实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-使用正交投影矩阵解决-webgl-图形拉伸问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="4-使用正交投影矩阵解决 webgl 图形拉伸问题"><!--[--><!--]--> 4-使用正交投影矩阵解决 webgl 图形拉伸问题 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十二、视图矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="十二、视图矩阵"><!--[--><!--]--> 十二、视图矩阵 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-视图位移" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-视图位移"><!--[--><!--]--> 1-视图位移 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#扩展-matrixworld-详解" class="router-link-active router-link-exact-active sidebar-item" aria-label="扩展-matrixWorld 详解"><!--[--><!--]--> 扩展-matrixWorld 详解 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#扩展-逆矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="扩展-逆矩阵"><!--[--><!--]--> 扩展-逆矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-视图旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-视图旋转"><!--[--><!--]--> 2-视图旋转 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十三、透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="十三、透视投影矩阵"><!--[--><!--]--> 十三、透视投影矩阵 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-基础知识" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-基础知识"><!--[--><!--]--> 1-基础知识 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-认识透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-认识透视投影矩阵"><!--[--><!--]--> 2-认识透视投影矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-计算透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-计算透视投影矩阵"><!--[--><!--]--> 3-计算透视投影矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-three-js-里的透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="4-three.js 里的透视投影矩阵"><!--[--><!--]--> 4-three.js 里的透视投影矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_5-透视投影矩阵牛刀小试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5-透视投影矩阵牛刀小试"><!--[--><!--]--> 5-透视投影矩阵牛刀小试 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十四、投影矩阵、视图矩阵、模型矩阵共冶一炉" class="router-link-active router-link-exact-active sidebar-item" aria-label="十四、投影矩阵、视图矩阵、模型矩阵共冶一炉"><!--[--><!--]--> 十四、投影矩阵、视图矩阵、模型矩阵共冶一炉 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-投影视图矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-投影视图矩阵"><!--[--><!--]--> 1-投影视图矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-投影视图矩阵乘以模型矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-投影视图矩阵乘以模型矩阵"><!--[--><!--]--> 2-投影视图矩阵乘以模型矩阵 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十五、正交相机轨道控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="十五、正交相机轨道控制器"><!--[--><!--]--> 十五、正交相机轨道控制器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-正交相机的位移轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-正交相机的位移轨道"><!--[--><!--]--> 1-正交相机的位移轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-正交相机的缩放轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-正交相机的缩放轨道"><!--[--><!--]--> 2-正交相机的缩放轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-正交相机的旋转轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-正交相机的旋转轨道"><!--[--><!--]--> 3-正交相机的旋转轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_4-轨迹球旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="4-轨迹球旋转"><!--[--><!--]--> 4-轨迹球旋转 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十六、透视相机轨道控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="十六、透视相机轨道控制器"><!--[--><!--]--> 十六、透视相机轨道控制器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-透视相机的位移轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-透视相机的位移轨道"><!--[--><!--]--> 1-透视相机的位移轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-透视相机的缩放轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-透视相机的缩放轨道"><!--[--><!--]--> 2-透视相机的缩放轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_3-透视相机的旋转轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-透视相机的旋转轨道"><!--[--><!--]--> 3-透视相机的旋转轨道 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十七、封装相机轨道对象" class="router-link-active router-link-exact-active sidebar-item" aria-label="十七、封装相机轨道对象"><!--[--><!--]--> 十七、封装相机轨道对象 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-轨道控制器的封装" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-轨道控制器的封装"><!--[--><!--]--> 1-轨道控制器的封装 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-轨道控制器的实例化" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-轨道控制器的实例化"><!--[--><!--]--> 2-轨道控制器的实例化 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十八、顶点索引" class="router-link-active router-link-exact-active sidebar-item" aria-label="十八、顶点索引"><!--[--><!--]--> 十八、顶点索引 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-顶点索引概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-顶点索引概念"><!--[--><!--]--> 1-顶点索引概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-彩色立方体" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-彩色立方体"><!--[--><!--]--> 2-彩色立方体 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#十九、多着色器" class="router-link-active router-link-exact-active sidebar-item" aria-label="十九、多着色器"><!--[--><!--]--> 十九、多着色器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL.html#_1-多着色器绘图" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-多着色器绘图"><!--[--><!--]--> 1-多着色器绘图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL.html#_2-多着色器动画" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-多着色器动画"><!--[--><!--]--> 2-多着色器动画 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="webgl" tabindex="-1"><a class="header-anchor" href="#webgl" aria-hidden="true">#</a> WebGL</h1><h2 id="一、webgl-介绍" tabindex="-1"><a class="header-anchor" href="#一、webgl-介绍" aria-hidden="true">#</a> 一、WebGL-介绍</h2><blockquote><p>WebGL（全写 Web Graphics Library）是一种 3D 绘图协议，这种绘图技术标准允许把 JavaScript 和 OpenGL ES 2.0 结合在一起，通过增加 OpenGL ES 2.0 的一个 JavaScript 绑定，WebGL 可以为 HTML5 Canvas 提供硬件 3D 加速渲染，这样 Web 开发人员就可以借助系统显卡来在浏览器里更流畅地展示 3D 场景和模型了，还能创建复杂的导航和数据视觉化。显然，WebGL 技术标准免去了开发网页专用渲染插件的麻烦，可被用于创建具有复杂 3D 结构的网站页面，甚至可以用来设计 3D 网页游戏等等</p></blockquote><p><img src="/visual/webgl/1.png" alt=""></p><h2 id="二、webgl-基础知识" tabindex="-1"><a class="header-anchor" href="#二、webgl-基础知识" aria-hidden="true">#</a> 二、webgl 基础知识</h2><h3 id="_1-刷底色" tabindex="-1"><a class="header-anchor" href="#_1-刷底色" aria-hidden="true">#</a> 1.刷底色</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在js中获取canvas画布</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token comment">// 使用canvas 获取webgl 绘图上下文</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 指定将要用来清空绘图区的颜色 rgba</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 刷底色</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>注：clearColor(r,g,b,a) 中的参数是红、绿、蓝、透明度，其定义域是[0,1]</strong></p><h3 id="_2-webgl-坐标系" tabindex="-1"><a class="header-anchor" href="#_2-webgl-坐标系" aria-hidden="true">#</a> 2.webgl 坐标系</h3><blockquote><p>canvas 2d 画布的坐标系<br> canvas 2d 坐标系的原点在左上角<br> canvas 2d 坐标系的 y 轴方向是朝下的<br> canvas 2d 坐标系的坐标基底有两个分量，分别是一个像素的宽和一个像素的高，即 1 个单位的宽便是 1 个像素的宽，1 个单位的高便是一个像素的高</p></blockquote><p><img src="/visual/webgl/2.png" alt=""></p><blockquote><p>webgl 的坐标系<br> webgl 坐标系的坐标原点在画布中心<br> webgl 坐标系的 y 轴方向是朝上的<br> webgl 坐标基底中的两个分量分别是半个 canvas 的宽和 canvas 的高，即 1 个单位的宽便是半个个 canvas 的宽，1 个单位的高便是半个 canvas 的高</p></blockquote><p><img src="/visual/webgl/3.png" alt=""></p><h3 id="_3-webgl-画一个点" tabindex="-1"><a class="header-anchor" href="#_3-webgl-画一个点" aria-hidden="true">#</a> 3.webgl 画一个点</h3><h4 id="_1-绘图的基本步骤" tabindex="-1"><a class="header-anchor" href="#_1-绘图的基本步骤" aria-hidden="true">#</a> 1) 绘图的基本步骤</h4><ol><li><p>找一张画布</p></li><li><p>找一支画笔</p></li><li><p>开始画画</p></li></ol><p><strong>canvas 2d 的绘图逻辑就是如此</strong></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//canvas画布</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//二维画笔</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置画笔的颜色</span>
ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//用画笔画一个矩形</span>
ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_2-canvas-2d-和-webgl-绘图的差异" tabindex="-1"><a class="header-anchor" href="#_2-canvas-2d-和-webgl-绘图的差异" aria-hidden="true">#</a> 2) canvas 2d 和 webgl 绘图的差异</h4><blockquote><p>浏览器有三大线程： js 引擎线程、GUI 渲染线程、浏览器事件触发线程<br> GUI 渲染线程就是用于渲图，，在这个渲染线程里，有负责不同渲染工作的工人。比如有负责渲染 HTML+css 的工人，有负责渲染二维图形的工人，有负责渲染三维图形的工人<br> 渲染二维图形的工人说的是 js 语言<br> 渲染三维图形的工人说的是 GLSL ES 语言<br> GLSL ES &lt;=&gt; 程序对象 &lt;=&gt; js</p></blockquote><h4 id="_3-webgl-的绘图思路步骤" tabindex="-1"><a class="header-anchor" href="#_3-webgl-的绘图思路步骤" aria-hidden="true">#</a> 3) webgl 的绘图思路步骤</h4><ol><li>找一台电脑 - 浏览器里内置的 webgl 渲染引擎，负责渲染 webgl 图形，只认 GLSL ES 语言</li><li>找一块手绘板 - 程序对象，承载 GLSL ES 语言，翻译 GLSL ES 语言和 js 语言，使两者可以相互通信</li><li>找一支触控笔 - 通过 canvas 获取的 webgl 类型的上下文对象，可以向手绘板传递绘图命令，并接收手绘板的状态信息</li><li>开始画画 - 通过 webgl 类型的上下文对象，用 js 画画</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//点位</span>
    gl_Position<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//尺寸</span>
    gl_PointSize<span class="token operator">=</span><span class="token number">50.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 片元的颜色</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// canvas 画布</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token comment">//功能：解析着色器文本，整合到程序对象里，关联webgl上下文对象，实现两种语言的相互通信</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">initShaders</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建程序对象</span>
    <span class="token keyword">const</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//建立着色对象</span>
    <span class="token keyword">const</span> vertexShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fragmentShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把顶点着色对象装进程序对象中</span>
    gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把片元着色对象装进程序对象中</span>
    gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//连接webgl上下文对象和程序对象</span>
    gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//启动程序对象</span>
    gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将程序对象挂到上下文对象上</span>
    gl<span class="token punctuation">.</span>program <span class="token operator">=</span> program<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">loadShader</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> type<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//根据着色类型，建立着色器对象</span>
    <span class="token keyword">const</span> shader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将着色器源文件传入着色器对象中</span>
    gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//编译着色器对象</span>
    gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回着色器对象</span>
    <span class="token keyword">return</span> shader<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h4 id="_4-webgl-着色器" tabindex="-1"><a class="header-anchor" href="#_4-webgl-着色器" aria-hidden="true">#</a> 4) webgl 着色器</h4><p>webgl 绘图需要两种着色器：</p><ul><li>顶点着色器（Vertex shader）：描述顶点的特征，如位置、颜色等</li><li>片元着色器（Fragment shader）：进行逐片元处理，如光照 <blockquote><p>两点决定一条直线，顶点着色器里的顶点就是决定这一条直线的两个点，片元着色器里的片元就是把直线画到画布上后，这两个点之间构成直线的每个像素</p></blockquote></li></ul><h2 id="三、js-与着色器间的数据传输" tabindex="-1"><a class="header-anchor" href="#三、js-与着色器间的数据传输" aria-hidden="true">#</a> 三、js 与着色器间的数据传输</h2><h3 id="_1-js-控制顶点位置" tabindex="-1"><a class="header-anchor" href="#_1-js-控制顶点位置" aria-hidden="true">#</a> 1. js 控制顶点位置</h3><blockquote><p>attribute 变量是只有顶点着色器才能使用它的<br> js 可以通过 attribute 变量向顶点着色器传递与顶点相关的数据</p></blockquote><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize <span class="token operator">=</span> <span class="token number">50.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//片元的颜色</span>
      gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * 获取attribute 变量
   * gl.getAttribLocation() 是获取着色器中attribute 变量的方法
   * gl.program 是初始化着色器时，在上下文对象上挂载的程序对象
   * &#39;a_Position&#39; 是着色器暴露出的变量名
   */</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttrib3f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// gl.vertexAttrib2f(a_Position, 0.5, 0.5);</span>
  <span class="token comment">// gl.vertexAttrib1f(a_Position, 0.1);</span>

  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="_2-鼠标控制点位" tabindex="-1"><a class="header-anchor" href="#_2-鼠标控制点位" aria-hidden="true">#</a> 2. 鼠标控制点位</h3><ol><li>canvas 坐标系转 webgl 坐标系</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>cssX<span class="token punctuation">,</span> cssY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>clientX <span class="token operator">-</span> left<span class="token punctuation">,</span> clientY <span class="token operator">-</span> top<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">//解决坐标原点位置的差异</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>halfWidth<span class="token punctuation">,</span> halfHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>xBaseCenter<span class="token punctuation">,</span> yBaseCenter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>cssX <span class="token operator">-</span> halfWidth<span class="token punctuation">,</span> cssY <span class="token operator">-</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 解决y 方向的差异</span>
  <span class="token keyword">const</span> yBaseCenterTop <span class="token operator">=</span> <span class="token operator">-</span>yBaseCenter<span class="token punctuation">;</span>
  <span class="token comment">//解决坐标基底的差异</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xBaseCenter <span class="token operator">/</span> halfWidth<span class="token punctuation">,</span> yBaseCenterTop <span class="token operator">/</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>修改 attribute 变量 <ol><li>获取 attribute 变量</li><li>在获取鼠标在 webgl 画布中的位置的时候，修改 attribute 变量</li><li>清理画布</li><li>绘图</li></ol></li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>webgl 的同步绘图原理 <blockquote><p>gl.drawArrays(gl.POINTS, 0, 1) 方法和 canvas 2d 里的 ctx.draw() 方法是不一样的，ctx.draw() 真的像画画一样，一层一层的覆盖图像<br> gl.drawArrays() 方法只会同步绘图，走完了 js 主线程后，再次绘图时，就会从头再来。也就说，异步执行的 drawArrays() 方法会把画布上的图像都刷掉：<br> 原理 =&gt; webgl 绘图的时候，是先在颜色缓冲区中画出来，颜色缓冲区中存储的图像，只在当前线程有效。比如我们先在 js 主线程中绘图，主线程结束后，会再去执行信息队列里的异步线程。在执行异步线程时，颜色缓冲区就会被 webgl 系统重置</p></blockquote></li></ol><p><strong>鼠标绘制多个点</strong></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> g_points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>cssX<span class="token punctuation">,</span> cssY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>clientX <span class="token operator">-</span> left<span class="token punctuation">,</span> clientY <span class="token operator">-</span> top<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>halfWidth<span class="token punctuation">,</span> halfHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>xBaseCenter<span class="token punctuation">,</span> yBaseCenter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>cssX <span class="token operator">-</span> halfWidth<span class="token punctuation">,</span> cssY <span class="token operator">-</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> yBaseCenterTop <span class="token operator">=</span> <span class="token operator">-</span>yBaseCenter<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xBaseCenter <span class="token operator">/</span> halfWidth<span class="token punctuation">,</span> yBaseCenterTop <span class="token operator">/</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>

  g_points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  g_points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_3-js-控制顶点尺寸" tabindex="-1"><a class="header-anchor" href="#_3-js-控制顶点尺寸" aria-hidden="true">#</a> 3. js 控制顶点尺寸</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute float a_PointSize<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize<span class="token operator">=</span>a_PointSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a_PointSize <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_PointSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttrib1f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttrib1f</span><span class="token punctuation">(</span>a_PointSize<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><strong>鼠标随机改变顶点大小</strong></p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute float a_PointSize<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize<span class="token operator">=</span>a_PointSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取attribute 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a_PointSize <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_PointSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 顶点</span>
  <span class="token keyword">const</span> a_points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 鼠标点击事件</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>cssX<span class="token punctuation">,</span> cssY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>clientX <span class="token operator">-</span> left<span class="token punctuation">,</span> clientY <span class="token operator">-</span> top<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//解决坐标原点位置的差异</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>halfWidth<span class="token punctuation">,</span> halfHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>xBaseCenter<span class="token punctuation">,</span> yBaseCenter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>cssX <span class="token operator">-</span> halfWidth<span class="token punctuation">,</span> cssY <span class="token operator">-</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 解决y 方向的差异</span>
    <span class="token keyword">const</span> yBaseCenterTop <span class="token operator">=</span> <span class="token operator">-</span>yBaseCenter<span class="token punctuation">;</span>
    <span class="token comment">//解决坐标基底的差异</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xBaseCenter <span class="token operator">/</span> halfWidth<span class="token punctuation">,</span> yBaseCenterTop <span class="token operator">/</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> size <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
    a_points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渲染方法</span>
  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a_points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gl<span class="token punctuation">.</span><span class="token function">vertexAttrib1f</span><span class="token punctuation">(</span>a_PointSize<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><h3 id="_4-js-控制顶点的颜色" tabindex="-1"><a class="header-anchor" href="#_4-js-控制顶点的颜色" aria-hidden="true">#</a> 4. js 控制顶点的颜色</h3><p><strong>限定颜色变量的限定符叫 uniform</strong></p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize<span class="token operator">=</span><span class="token number">50.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_FragColor<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span>u_FragColor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//获取uniform 变量</span>
  <span class="token keyword">const</span> u_FragColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_FragColor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttrib1f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//修改uniform 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform4f</span><span class="token punctuation">(</span>u_FragColor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p><strong>鼠标随机改变顶点颜色</strong></p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute float a_PointSize<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize<span class="token operator">=</span>a_PointSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_FragColor<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span>u_FragColor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//获取attribute 和 uniform 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a_PointSize <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_PointSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_FragColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_FragColor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> a_points <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">r</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 鼠标点击事件</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>cssX<span class="token punctuation">,</span> cssY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>clientX <span class="token operator">-</span> left<span class="token punctuation">,</span> clientY <span class="token operator">-</span> top<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//解决坐标原点位置的差异</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>halfWidth<span class="token punctuation">,</span> halfHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>xBaseCenter<span class="token punctuation">,</span> yBaseCenter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>cssX <span class="token operator">-</span> halfWidth<span class="token punctuation">,</span> cssY <span class="token operator">-</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 解决y 方向的差异</span>
    <span class="token keyword">const</span> yBaseCenterTop <span class="token operator">=</span> <span class="token operator">-</span>yBaseCenter<span class="token punctuation">;</span>
    <span class="token comment">//解决坐标基底的差异</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xBaseCenter <span class="token operator">/</span> halfWidth<span class="token punctuation">,</span> yBaseCenterTop <span class="token operator">/</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> size <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> n <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">r</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    a_points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size<span class="token punctuation">,</span> color <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渲染方法</span>
  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a_points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">{</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gl<span class="token punctuation">.</span><span class="token function">vertexAttrib1f</span><span class="token punctuation">(</span>a_PointSize<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// gl.uniform4f(u_FragColor, r, g, b, a);</span>
      <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Float32Array 是一种32 位的浮点型数组，它在浏览器中的运行效率要比普通的Array 高很多</span>
      gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>u_FragColor<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><h2 id="四、绘制图形" tabindex="-1"><a class="header-anchor" href="#四、绘制图形" aria-hidden="true">#</a> 四、绘制图形</h2><p><strong>三角形是一个最简单、最稳定的面，webgl 中的三维模型都是由三角面组成的</strong></p><h3 id="_1-webgl-的绘图方式" tabindex="-1"><a class="header-anchor" href="#_1-webgl-的绘图方式" aria-hidden="true">#</a> 1.webgl 的绘图方式</h3><ul><li><p>绘制多点<br><img src="/visual/webgl/4.png" alt=""></p></li><li><p>如果是线，就连点成线<br><img src="/visual/webgl/5.png" alt=""></p></li><li><p>如果是面，那就在图形内部，逐片元填色<br><img src="/visual/webgl/6.png" alt=""></p></li></ul><h3 id="_2-绘制多点" tabindex="-1"><a class="header-anchor" href="#_2-绘制多点" aria-hidden="true">#</a> 2. 绘制多点</h3><blockquote><p>在 js 中建立顶点数据，着色器肯定是拿不到的，这是语言不通导致的，为了解决这个问题，webgl 系统就建立了一个能翻译双方语言的缓冲区<br> js 可以用特定的方法把数据存在这个缓冲区中，着色器可以从缓冲区中拿到相应的数据</p></blockquote><ol><li>建立顶点数据，两个浮点数构成一个顶点，分别代表 x、y 值</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">//x    y</span>
  <span class="token number">0.0</span><span class="token punctuation">,</span>
  <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">//顶点</span>
  <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">//顶点</span>
  <span class="token number">0.1</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">//顶点</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这些顶点数据是存储在js 缓存里的，着色器拿不到，所以需要建立一个着色器和js 都能进入的公共区</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="2"><li>建立缓冲对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 上面的这个缓冲区是独立存在的，它只是一个空着的仓库，和谁都没有关系。接下就让其和着色器建立连接</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li>绑定缓冲对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// gl.bindBuffer(target,buffer)   绑定缓冲区</span>
<span class="token comment">// - target  要把缓冲区放在webgl 系统中的什么位置</span>
<span class="token comment">// - buffer 缓冲区</span>

<span class="token comment">// 着色器对象在执行initShaders() 初始化方法的时候，已经被写入webgl 上下文对象gl 中了。</span>
<span class="token comment">// 当缓冲区和着色器建立了绑定关系，我们就可以往这块空间写入数据了</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="4"><li>往缓冲区对象中写入数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bufferData(target, data, usage) 将数据写入缓冲区</span>
<span class="token comment">// - target 要把缓冲区放在webgl 系统中的什么位置</span>
<span class="token comment">// - data  数据</span>
<span class="token comment">// - usage 向缓冲区写入数据的方式，咱们在这里先知道 gl.STATIC_DRAW 方式即可，</span>
<span class="token comment">//它是向缓冲区中一次性写入数据，着色器会绘制多次。</span>

<span class="token comment">// 现在着色器虽然绑定了缓冲区，可以访问里面的数据了，但是我们还得让着色器知道这个仓库是给哪个变量的，</span>
<span class="token comment">//比如咱们这里用于控制点位的attribute 变量。这样做是为了提高绘图效率。</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="5"><li>将缓冲区对象分配给 attribute 变量</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// gl.vertexAttribPointer(local,size,type,normalized,stride,offset)   将缓冲区对象分配给attribute 变量</span>

<span class="token comment">// - local  attribute变量</span>
<span class="token comment">// - size 顶点分量的个数，比如我们的vertices 数组中，两个数据表示一个顶点，那咱们就写2</span>
<span class="token comment">// - type 数据类型，比如 gl.FLOAT 浮点型</span>
<span class="token comment">// - normalized 是否将顶点数据归一</span>
<span class="token comment">// - stride 相邻两个顶点间的字节数，我的例子里写的是0，那就是顶点之间是紧挨着的</span>
<span class="token comment">// - offset 从缓冲区的什么位置开始存储变量，我的例子里写的是0，那就是从头开始存储变量</span>

<span class="token comment">// 到了这里，着色就知道缓冲区的数据是给谁的了。因为缓冲区里的顶点数据是数组，里面有多个顶点。</span>
<span class="token comment">//所以得开启一个让着色器批量处理顶点数据的属性。默认着色器只会一个一个的接收顶点数据，然后一个一个的绘制顶点。</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol start="6"><li>开启顶点数据的批处理功能</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// - location attribute变量</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="7"><li>绘图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// drawArrays(mode,first,count)</span>

<span class="token comment">// - mode 绘图模式，比如 gl.POINTS 画点</span>
<span class="token comment">// - first 从哪个顶点开始绘制</span>
<span class="token comment">// - count 要画多少个顶点</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>整体代码</strong></p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize<span class="token operator">=</span><span class="token number">50.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//如何向attribute 变量中写入多点，并绘制多点</span>
  <span class="token comment">//顶点数据</span>
  <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//缓冲对象</span>
  <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绑定缓冲对象</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//写入数据</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//赋能-批处理</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="_3-绘制图形" tabindex="-1"><a class="header-anchor" href="#_3-绘制图形" aria-hidden="true">#</a> 3. 绘制图形</h3><ol><li>绘制三角面</li></ol><ul><li>顶点着色器中的 gl_PointSize = 20.0 不要，因为这个属性是控制顶点大小的，咱们已经不需要显示顶点了。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
        <span class="token comment">//gl_PointSize = 20.0;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>在 js 中修改绘图方式</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// gl.drawArrays(gl.POINTS, 0, 3);</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>gl.TRIANGLES 就是绘制三角面</strong></p><p><img src="/visual/webgl/7.png" alt=""></p><ol start="2"><li>基本图形</li></ol><p>gl.drawArrays(mode,first,count) 方法可以绘制一下图形：</p><ul><li><p>POINTS 可视的点</p></li><li><p>LINES 单独线段</p></li><li><p>LINE_STRIP 线条</p></li><li><p>LINE_LOOP 闭合线条</p></li><li><p>TRIANGLES 单独三角形</p></li><li><p>TRIANGLE_STRIP 三角带</p></li><li><p>TRIANGLE_FAN 三角扇</p><p><strong>2.1 点的绘制</strong><br> POINTS 可视的点</p><p><img src="/visual/webgl/8.png" alt=""></p><p>上面六个点的绘制顺序是：v0, v1, v2, v3, v4, v5</p><p><strong>2.2 线的绘制</strong></p><ol><li>LINES 单独线段</li></ol><p><img src="/visual/webgl/9.png" alt=""></p><p>上面三条有向线段的绘制顺序是：<br> ​ v0&gt;v1<br> ​ v2&gt;v3<br> ​ v4&gt;v5</p><ol start="2"><li>LINE_STRIP 线条</li></ol><p><img src="/visual/webgl/10.png" alt=""></p><p>上面线条的绘制顺序是：v0&gt;v1&gt;v2&gt;v3&gt;v4&gt;v5</p><ol start="3"><li>LINE_LOOP 闭合线条</li></ol><p><img src="/visual/webgl/11.png" alt=""></p><p>上面线条的绘制顺序是：v0&gt;v1&gt;v2&gt;v3&gt;v4&gt;v5&gt;v0</p><p><strong>2.3 面的绘制</strong></p><p>对于面的绘制，我们首先要知道一个原理：</p><ul><li>面有正反两面。</li><li>面向我们的面，如果是正面，那它必然是逆时针绘制的；</li><li>面向我们的面，如果是反面，那它必然是顺时针绘制的；</li></ul><p>接下来，看下面的三种绘制方式：</p><ol><li>TRIANGLES 单独三角形</li></ol><p><img src="/visual/webgl/12.png" alt=""></p><p>上面两个面的绘制顺序是：​<br> ​ v0&gt;v1&gt;v2<br> ​ v3&gt;v4&gt;v5</p><ol start="2"><li>TRIANGLE_STRIP 三角带</li></ol><p><img src="/visual/webgl/13.png" alt=""></p><p>上面四个面的绘制顺序是：<br> v0&gt;v1&gt;v2<br> 以上一个三角形的第二条边+下一个点为基础，以和第二条边相反的方向绘制三角形<br> v2&gt;v1&gt;v3<br> 以上一个三角形的第三条边+下一个点为基础，以和第三条边相反的方向绘制三角形<br> v2&gt;v3&gt;v4<br> 以上一个三角形的第二条边+下一个点为基础，以和第二条边相反的方向绘制三角形<br> v4&gt;v3&gt;v5</p><p>规律：<br> 第一个三角形：v0&gt;v1&gt;v2<br> 第偶数个三角形：以上一个三角形的第二条边+下一个点为基础，以和第二条边相反的方向绘制三角形<br> 第奇数个三角形：以上一个三角形的第三条边+下一个点为基础，以和第三条边相反的方向绘制三角形</p><ol start="3"><li>TRIANGLE_FAN 三角扇</li></ol><p><img src="/visual/webgl/14.png" alt=""></p><p>上面四个面的绘制顺序是：<br> ​ v0&gt;v1&gt;v2<br> 以上一个三角形的第三条边+下一个点为基础，按照和第三条边相反的顺序，绘制三角形<br> ​ v0&gt;v2&gt;v3<br> 以上一个三角形的第三条边+下一个点为基础，按照和第三条边相反的顺序，绘制三角形<br> ​ v0&gt;v3&gt;v4<br> 以上一个三角形的第三条边+下一个点为基础，按照和第三条边相反的顺序，绘制三角形<br> ​ v0&gt;v4&gt;v5</p></li></ul><h3 id="_4-绘制矩形" tabindex="-1"><a class="header-anchor" href="#_4-绘制矩形" aria-hidden="true">#</a> 4. 绘制矩形</h3><p>首先，webgl 可以绘制的面只有三角面，所以要绘制矩形面的话，只能用两个三角形去拼。</p><ol><li>TRIANGLE_STRIP 三角带拼矩形</li></ol><p><img src="/visual/webgl/15.png" alt=""></p><p>上面的两个三角形分别是：<br> v0&gt;v1&gt;v2<br> v2&gt;v1&gt;v3</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 1.建立顶点数据(下面两个浮点代表一个顶点，依次是v0、v1、v2、v3，如上图所示)</span>
<span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2.绘图</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl/16.png" alt=""></p><h3 id="_5-异步绘制多点" tabindex="-1"><a class="header-anchor" href="#_5-异步绘制多点" aria-hidden="true">#</a> 5. 异步绘制多点</h3><blockquote><p>当缓冲区被绑定在了 webgl 上下文对象上后，我们在异步方法里直接对其进行修改即可，顶点着色器在绘图的时候会自动从其中调用数据。<br> WebGLBuffer 缓冲区中的数据在异步方法里不会被重新置空。</p></blockquote><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      gl_PointSize<span class="token operator">=</span><span class="token number">20.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

  <span class="token comment">// 获取着色器文本</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

  <span class="token comment">//三维画笔</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//初始化着色器</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//顶点数据</span>
  <span class="token keyword">let</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">//缓冲对象</span>
  <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绑定缓冲对象</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//写入数据</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//赋能-批处理</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//声明颜色 rgba</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><h3 id="_6-图形转面" tabindex="-1"><a class="header-anchor" href="#_6-图形转面" aria-hidden="true">#</a> 6.图形转面</h3><p><strong>“砍角”，其原理就是从起点将多边形中符合特定条件的角逐个砍掉，然后保存到一个集合里，直到把多边形砍得只剩下一个三角形为止。这时候集合里的所有三角形就是想要的独立三角形</strong></p><h2 id="五、矩阵变换" tabindex="-1"><a class="header-anchor" href="#五、矩阵变换" aria-hidden="true">#</a> 五、矩阵变换</h2><p>变换有三种状态：平移、旋转、缩放。</p><p>当变换一个图形时，实际上就是在移动这个图形的所有顶点。</p><h3 id="_1-平移" tabindex="-1"><a class="header-anchor" href="#_1-平移" aria-hidden="true">#</a> 1.平移</h3><p>对图形的平移就是对图形所有顶点的平移</p><p><img src="/visual/webgl/17.png" alt=""></p><p>在实际代码中，要有一个向量的概念，比如 (x,y,z) ，我们既可以说它是一个顶点位置，也可以说它是一个向量，顶点的位移其实就是向量的加法。</p><p>GLSL ES 语言里的向量运算</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>attribute vec4 a_Position<span class="token punctuation">;</span>
vec4 translation<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token operator">+</span>translation<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>a_Position 是原始点位，属于 attribute 变量</li><li>translation 是顶点着色器里的私有变量，没有向外部暴露，属于 4 维向量</li><li>a_Position+translation 便是着色器内的向量加法，这里是对原始点位进行位移</li></ul><h3 id="_2-旋转" tabindex="-1"><a class="header-anchor" href="#_2-旋转" aria-hidden="true">#</a> 2.旋转</h3><p>物体的旋转方向是有正负之分的，在 webgl 中，除裁剪空间之外的大部分功能都使用了右手坐标系。</p><p><img src="/visual/webgl/18.png" alt=""></p><ul><li>当物体绕 z 轴，从 x 轴正半轴向 y 轴正半轴逆时针旋转时，是正向旋转，反之为负。</li><li>当物体绕 x 轴，从 y 轴正半轴向 z 轴正半轴逆时针旋转时，是正向旋转，反之为负。</li><li>当物体绕 y 轴，从 z 轴正半轴向 x 轴正半轴逆时针旋转时，是正向旋转，反之为负。</li></ul><p>旋转公式:</p><p>由一个让顶点围绕 z 轴旋转的例子引出</p><p><img src="/visual/webgl/19.png" alt=""></p><p>已知：</p><ul><li>点 A 的位置是(ax,ay,az)</li><li>点 A 要围绕 z 轴旋转 β 度，转到点 B 的位置</li></ul><p>求：点 A 旋转后的 bx、by 位置</p><p>因为 ∠β 是已知的，∠α 可以通过点 A 得出:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>∠xOB<span class="token operator">=</span>α<span class="token operator">+</span>β
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>三角函数就可以推出 bx、by</p><p>设 ∠xOB=θ，则：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx<span class="token operator">=</span>cosθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
by<span class="token operator">=</span>sinθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>|OA|是点 O 到点 A 的距离，可以直接用点 A 求出:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|=</span>Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>ax<span class="token operator">*</span>ax<span class="token operator">+</span>ay<span class="token operator">*</span>ay<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>只需要知道 cosθ 和 sinθ 的值即可，因为：θ=α+β<br> 所以可以利用和角公式求 cosθ 和 sinθ 的值：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosθ <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>α <span class="token operator">+</span> β<span class="token punctuation">)</span><span class="token punctuation">;</span>
cosθ <span class="token operator">=</span> cosα <span class="token operator">*</span> cosβ <span class="token operator">-</span> sinα <span class="token operator">*</span> sinβ<span class="token punctuation">;</span>

sinθ <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>α <span class="token operator">+</span> β<span class="token punctuation">)</span><span class="token punctuation">;</span>
sinθ <span class="token operator">=</span> cosβ <span class="token operator">*</span> sinα <span class="token operator">+</span> sinβ <span class="token operator">*</span> cosα<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx<span class="token operator">=</span>cosθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
bx<span class="token operator">=</span><span class="token punctuation">(</span>cosα<span class="token operator">*</span>cosβ<span class="token operator">-</span>sinα<span class="token operator">*</span>sinβ<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
bx<span class="token operator">=</span>cosα<span class="token operator">*</span>cosβ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span><span class="token operator">-</span>sinα<span class="token operator">*</span>sinβ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>

by<span class="token operator">=</span>sinθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
by<span class="token operator">=</span><span class="token punctuation">(</span>cosβ<span class="token operator">*</span>sinα<span class="token operator">+</span>sinβ<span class="token operator">*</span>cosα<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
by<span class="token operator">=</span>cosβ<span class="token operator">*</span>sinα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span><span class="token operator">+</span>sinβ<span class="token operator">*</span>cosα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|=</span>ax
sinα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|=</span>ay
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>简化得到 bx、by 的公式：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx <span class="token operator">=</span> ax <span class="token operator">*</span> cosβ <span class="token operator">-</span> ay <span class="token operator">*</span> sinβ<span class="token punctuation">;</span>
by <span class="token operator">=</span> ay <span class="token operator">*</span> cosβ <span class="token operator">+</span> ax <span class="token operator">*</span> sinβ<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在着色器中旋转</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    float angle<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">80.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float sinB<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float cosB<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        gl_Position<span class="token punctuation">.</span>x<span class="token operator">=</span>a_Position<span class="token punctuation">.</span>x<span class="token operator">*</span>cosB<span class="token operator">-</span>a_Position<span class="token punctuation">.</span>y<span class="token operator">*</span>sinB<span class="token punctuation">;</span>
        gl_Position<span class="token punctuation">.</span>y<span class="token operator">=</span>a_Position<span class="token punctuation">.</span>y<span class="token operator">*</span>cosB<span class="token operator">+</span>a_Position<span class="token punctuation">.</span>x<span class="token operator">*</span>sinB<span class="token punctuation">;</span>
        gl_Position<span class="token punctuation">.</span>z<span class="token operator">=</span>a_Position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
        gl_Position<span class="token punctuation">.</span>w<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>radians(float degree) 将角度转弧度</li><li>sin(float angle) 正弦</li><li>cos(float angle) 余弦</li></ul><h3 id="_3-缩放" tabindex="-1"><a class="header-anchor" href="#_3-缩放" aria-hidden="true">#</a> 3.缩放</h3><p>缩放可以理解为对向量长度的改变，或者对向量坐标分量的同步缩放</p><p><img src="/visual/webgl/20.png" alt=""></p><p>已知：</p><ul><li>点 A 的位置是(ax,ay,az)</li><li>点 A 基于原点內缩了一半</li></ul><p>求：点 A 內缩了一半后的 bx、by、bz 位置</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx <span class="token operator">=</span> ax <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
by <span class="token operator">=</span> ay <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
bz <span class="token operator">=</span> az <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在着色器中缩放</p><p>对 gl_Position 的 x、y、z 依次缩放：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
attribute vec4 a_Position<span class="token punctuation">;</span>
float scale<span class="token operator">=</span><span class="token number">1.2</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	gl_Position<span class="token punctuation">.</span>x<span class="token operator">=</span> a_Position<span class="token punctuation">.</span>x<span class="token operator">*</span>scale<span class="token punctuation">;</span>
	gl_Position<span class="token punctuation">.</span>y<span class="token operator">=</span> a_Position<span class="token punctuation">.</span>y<span class="token operator">*</span>scale<span class="token punctuation">;</span>
	gl_Position<span class="token punctuation">.</span>z<span class="token operator">=</span> a_Position<span class="token punctuation">.</span>z<span class="token operator">*</span>scale<span class="token punctuation">;</span>
	gl_Position<span class="token punctuation">.</span>w<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>a_Position 中抽离出由 x、y、z 组成的三维向量，对其进行一次性缩放：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
attribute vec4 a_Position<span class="token punctuation">;</span>
float scale<span class="token operator">=</span><span class="token number">1.2</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	gl_Position<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token operator">*</span>scale<span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-矩阵" tabindex="-1"><a class="header-anchor" href="#_4-矩阵" aria-hidden="true">#</a> 4.矩阵</h3><p>矩阵（Matrix）是一个按照矩形纵横排列的复数集合</p><p>在矩阵中的每一行，或者每一列数字构成的集合，可以视之为向量</p><ol><li>向量</li></ol><p>向量，又叫矢量，指具有大小（magnitude）和方向的量</p><p>webgl 里的向量有 1 维向量、2 维向量、3 维向量和 4 维向量：</p><ul><li>维向量中有 1 个数字，对应的是单轴坐标系里的点位。</li><li>2 维向量中有 2 个数字，对应的是 2 维坐标系里的点位。</li><li>3 维向量中有 3 个数字，对应的是 3 维坐标系里的点位。</li><li>4 维向量中有 4 个数字，对应的是 3 维坐标系里的点位，外加一个附加数据，至于这个数据是什么，要看项目需求。</li></ul><ol start="2"><li>矩阵和向量的乘法</li></ol><p>矩阵和向量的乘法：</p><p><img src="/visual/webgl/21.png" alt=""></p><p>用专业术语来说：</p><ul><li>横着的两组遵循的规则是行主序，即将矩阵中的一行数据视之为一个向量。</li><li>竖着的两组遵循的规则是列主序，即将矩阵中的一列数据视之为一个向量。</li></ul><p>至于是使用行主序，还是列主序，这就得看规则的定制者了。</p><p>在 webgl 里，矩阵元素的排列规则是列主序。</p><p>数学中常用的写法是行主序</p><p>可以用矩阵乘以向量的方式让点 p 旋转 β 度：</p><p><img src="/visual/webgl/22.png" alt=""></p><ol start="3"><li>在着色器中写矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    float angle<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">40.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float sinB<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float cosB<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mat2 m2<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
      cosB<span class="token punctuation">,</span> sinB<span class="token punctuation">,</span>
      <span class="token operator">-</span>sinB<span class="token punctuation">,</span>cosB
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>
        m2<span class="token operator">*</span><span class="token function">vec2</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">,</span>
        a_Position<span class="token punctuation">.</span>z<span class="token punctuation">,</span>a_Position<span class="token punctuation">.</span>w
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="4"><li>四维矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    float angle<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float cosB<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float sinB<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//列主序</span>
    mat4 m4<span class="token operator">=</span><span class="token function">mat4</span><span class="token punctuation">(</span>
      cosB<span class="token punctuation">,</span> sinB<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token operator">-</span>sinB<span class="token punctuation">,</span>cosB<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> m4<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="5"><li>矩阵平移</li></ol><p>让顶点的 x 移动 0.1，y 移动 0.2，z 移动 0.3：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//列主序</span>
    mat4 m4<span class="token operator">=</span><span class="token function">mat4</span><span class="token punctuation">(</span>
      <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">1.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> m4<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="6"><li>矩阵缩放</li></ol><p>顶点在 x 轴向缩放 2，y 轴向缩放 3，轴向缩放 4：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//列主序</span>
    mat4 m4<span class="token operator">=</span><span class="token function">mat4</span><span class="token punctuation">(</span>
      <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> m4<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="7"><li>矩阵库</li></ol><p>three.js 的 Matrix3 和 Matrix4 对象：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 1.引入Matrix4对象</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Matrix4 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 2.实例化矩阵对象，在其中写入旋转信息</span>
<span class="token keyword">const</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
matrix<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3.基于matrix 对象的elements 属性，修改uniform 变量</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="六、-矩阵复合变换" tabindex="-1"><a class="header-anchor" href="#六、-矩阵复合变换" aria-hidden="true">#</a> 六、 矩阵复合变换</h2><h3 id="_1-矩阵相乘" tabindex="-1"><a class="header-anchor" href="#_1-矩阵相乘" aria-hidden="true">#</a> 1.矩阵相乘</h3><p>矩阵相乘可以实现复合变换，就比如先位移再旋转、先旋转在位移，或着连续位移。</p><p>矩阵乘以矩阵的结果还是矩阵，我们可以通过矩阵库验证一下矩阵相乘的规律。</p><ol><li>使用 three.js 的 Matrix4 对象建立矩阵</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const a=new Matrix4().set(
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span>
)
const b=new Matrix4().set(
    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span>
    <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span>
    <span class="token number">120</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">140</span><span class="token punctuation">,</span><span class="token number">150</span>
)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>注：set()方法里输入的矩阵是行主序的，但 elements 输出的矩阵是列主序的。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const ca=a.elements
console.log(ca);
<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span>  <span class="token number">13</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span>
<span class="token punctuation">]</span>

const cb=b.elements
console.log(cb);
<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span>
    <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">,</span>
    <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span>
    <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">150</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="2"><li>让矩阵 a 乘以矩阵 b</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const c=a.multiply(b)
console.log(c.elements);
<span class="token punctuation">[</span>
    <span class="token number">560</span><span class="token punctuation">,</span> <span class="token number">1520</span><span class="token punctuation">,</span> <span class="token number">2480</span><span class="token punctuation">,</span> <span class="token number">3440</span><span class="token punctuation">,</span>
    <span class="token number">620</span><span class="token punctuation">,</span> <span class="token number">1740</span><span class="token punctuation">,</span> <span class="token number">2860</span><span class="token punctuation">,</span> <span class="token number">3980</span><span class="token punctuation">,</span>
    <span class="token number">680</span><span class="token punctuation">,</span> <span class="token number">1960</span><span class="token punctuation">,</span> <span class="token number">3240</span><span class="token punctuation">,</span> <span class="token number">4520</span><span class="token punctuation">,</span>
    <span class="token number">740</span><span class="token punctuation">,</span> <span class="token number">2180</span><span class="token punctuation">,</span> <span class="token number">3620</span><span class="token punctuation">,</span> <span class="token number">5060</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>分析一下结果</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token number">560</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">0</span> <span class="token operator">+</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">80</span> <span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">120</span>
<span class="token number">620</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">50</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">90</span> <span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">130</span>
<span class="token number">680</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">20</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">140</span>
<span class="token number">740</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">70</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">110</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">150</span>

<span class="token number">1520</span><span class="token operator">=</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">0</span> <span class="token operator">+</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">80</span> <span class="token operator">+</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">120</span>
<span class="token number">1740</span><span class="token operator">=</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">+</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">50</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">90</span> <span class="token operator">+</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">130</span>
……
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>总结出矩阵 a 乘以矩阵 b 规律:</p><p>以列主序的 ca、cb 为例：<br> 先遍历 ca 的每一列，再遍历 cb 的每一行，将 ca 的每一列乘以 cb 的每一行，按照列主序排列后得到的结果。</p><p>以行主序的 ca、cb 为例：<br> 先遍历 ca 的每一行，再遍历 cb 的每一列，将 ca 的每一行乘以 cb 的每一列，按照行主序排列后得到的结果。</p><p>验证一下后者：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const cc=<span class="token punctuation">[</span><span class="token punctuation">]</span>
for(let y=<span class="token number">0</span>;y&lt;<span class="token number">16</span>;y+=<span class="token number">4</span>)<span class="token punctuation">{</span>
    const <span class="token punctuation">[</span>ax<span class="token punctuation">,</span>ay<span class="token punctuation">,</span>az<span class="token punctuation">,</span>aw<span class="token punctuation">]</span>=<span class="token punctuation">[</span>ca<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">,</span>ca<span class="token punctuation">[</span>y+<span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ca<span class="token punctuation">[</span>y+<span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ca<span class="token punctuation">[</span>y+<span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    for (let x=<span class="token number">0</span>;x&lt;<span class="token number">4</span>;x++)<span class="token punctuation">{</span>
        console.log(x);
        const <span class="token punctuation">[</span>bx<span class="token punctuation">,</span>by<span class="token punctuation">,</span>bz<span class="token punctuation">,</span>bw<span class="token punctuation">]</span>=<span class="token punctuation">[</span>cb<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span>cb<span class="token punctuation">[</span>x+<span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>cb<span class="token punctuation">[</span>x+<span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>cb<span class="token punctuation">[</span>x+<span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        cc.push(ax*bx+ay*by+az*bz+aw*bw)
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console.log(cc);
<span class="token punctuation">[</span>
    <span class="token number">560</span><span class="token punctuation">,</span> <span class="token number">1520</span><span class="token punctuation">,</span> <span class="token number">2480</span><span class="token punctuation">,</span> <span class="token number">3440</span><span class="token punctuation">,</span>
    <span class="token number">620</span><span class="token punctuation">,</span> <span class="token number">1740</span><span class="token punctuation">,</span> <span class="token number">2860</span><span class="token punctuation">,</span> <span class="token number">3980</span><span class="token punctuation">,</span>
    <span class="token number">680</span><span class="token punctuation">,</span> <span class="token number">1960</span><span class="token punctuation">,</span> <span class="token number">3240</span><span class="token punctuation">,</span> <span class="token number">4520</span><span class="token punctuation">,</span>
    <span class="token number">740</span><span class="token punctuation">,</span> <span class="token number">2180</span><span class="token punctuation">,</span> <span class="token number">3620</span><span class="token punctuation">,</span> <span class="token number">5060</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_2-变换规律" tabindex="-1"><a class="header-anchor" href="#_2-变换规律" aria-hidden="true">#</a> 2.变换规律</h3><ol><li>位移加位移</li></ol><p>接下来我想让一个物体沿 x 轴位移 ax，沿 y 轴位移 ay 后，再沿 x 轴位移 bx，沿 y 轴位移 by。</p><p>已知：</p><ul><li>初始点位 A(ax,ay,az,1.0)</li><li>初次位移：沿 x 轴位移 bx，沿 y 轴位移 by</li><li>第二次位移：沿 x 轴位移 cx，沿 y 轴位移 cy</li></ul><p>求：变换后的位置 F(fx,fy,fz,fw)</p><p>解：</p><p>1.设初次变换矩阵为 bm(行主序)：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>bm
<span class="token punctuation">[</span>
	<span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>bx<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>by<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>则初次变换后的点 F 为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">F</span> <span class="token operator">=</span> bm <span class="token operator">*</span> <span class="token constant">A</span><span class="token punctuation">;</span>
fx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> ax <span class="token operator">+</span> bx<span class="token punctuation">;</span>
fy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> by<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> ay <span class="token operator">+</span> by<span class="token punctuation">;</span>
fz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> az<span class="token punctuation">;</span>
fw <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2.设第二次变换矩阵为 cm(行主序)：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>cm
<span class="token punctuation">[</span>
	<span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>cx<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>cy<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>则第二次变换后的点 F 为第二次变换矩阵乘以上一次变换后的点 F：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">F</span> <span class="token operator">=</span> cm <span class="token operator">*</span> <span class="token constant">F</span><span class="token punctuation">;</span>
fx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> cx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> fx <span class="token operator">+</span> cx<span class="token punctuation">;</span>
fy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> cy<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> fy <span class="token operator">+</span> cy<span class="token punctuation">;</span>
fz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> fz<span class="token punctuation">;</span>
fw <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以理解最终的点 F：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>fx <span class="token operator">=</span> ax <span class="token operator">+</span> bx <span class="token operator">+</span> cx<span class="token punctuation">;</span>
fy <span class="token operator">=</span> ay <span class="token operator">+</span> by <span class="token operator">+</span> cy<span class="token punctuation">;</span>
fz <span class="token operator">=</span> az<span class="token punctuation">;</span>
fw <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面的点 F 还可以这么理解：（矩阵乘以矩阵）</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">F</span> <span class="token operator">=</span> cm <span class="token operator">*</span> bm <span class="token operator">*</span> <span class="token constant">A</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>设 cm*bm 的结果为矩阵 dm(行主序)，参照 dm 中元素的索引位置：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>cm
<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
	<span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span>
	<span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>则 dm 中的第一行元素为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>dm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
dm<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
dm<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
dm<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> cx <span class="token operator">+</span> bx<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过 dm 矩阵的第一行元素我们就可以得到点 F 的 fx 值了，我们验证一下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>fx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> cx <span class="token operator">+</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> ax <span class="token operator">+</span> cx <span class="token operator">+</span> bx<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这和我们之前两次矩阵乘以向量得到的结果是一样的。</p><ol start="2"><li>先移动后旋转</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mt<span class="token punctuation">.</span><span class="token function">makeTranslation</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> mr<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>mr.multiply(mt) 便是先位移再旋转：<br><img src="/visual/webgl/23.png" alt=""></p><ol start="3"><li>先旋转后移动</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mt<span class="token punctuation">.</span><span class="token function">makeTranslation</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> mt<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>mt.multiply(mr)便是先旋转再位移：<br><img src="/visual/webgl/24.png" alt=""></p><ol start="4"><li>其它变换方式</li></ol><p>1)旋转和缩放</p><ul><li>先旋转后缩放</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>先缩放后旋转</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> matrix <span class="token operator">=</span> mr<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>在此要注意一个性质：当缩放因子一致时，旋转和缩放没有先后之分。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此是下面的两种变换结果都是一样的:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> matrix <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> matrix <span class="token operator">=</span> mr<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2)综合变换</p><p>Matrix4 还有一个 compose 综合变换方法，它可以将所有变换信息都写进去，其变换顺序就是先缩放，再旋转，最后位移。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//位移</span>
<span class="token keyword">const</span> pos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//旋转</span>
<span class="token keyword">const</span> rot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rot<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//缩放</span>
<span class="token keyword">const</span> scale <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
matrix<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> rot<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>compose ( position : Vector3, quaternion : Quaternion, scale : Vector3 )</p><ul><li>position 位置</li><li>quaternion 用四元数存储的旋转数据</li><li>scale 缩放</li></ul><p>compose() 方法分解开来，就是这样的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mt<span class="token punctuation">.</span><span class="token function">makeTranslation</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> mt<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-视图矩阵" tabindex="-1"><a class="header-anchor" href="#_3-视图矩阵" aria-hidden="true">#</a> 3.视图矩阵</h3><p>视图矩阵是用于确定相机角度和位置的矩阵。</p><p>能不能在没有视图矩阵的情况下，看见物体的另一个角度呢？</p><p>答案肯定是可以，我们自己用模型矩阵把物体转一下就可以了。</p><p>因此，视图矩阵的本质是对物体的旋转变换。</p><p>而物体变换的本质则是对物体顶点的位移。</p><h4 id="_1-相机的定义" tabindex="-1"><a class="header-anchor" href="#_1-相机的定义" aria-hidden="true">#</a> 1.相机的定义</h4><p><img src="/visual/webgl/25.png" alt=""></p><ul><li>视点：相机的位置</li><li>视线方向：相机所看的方向</li><li>上方向：相机绕视线转动的方向</li></ul><h4 id="_2-相对运动" tabindex="-1"><a class="header-anchor" href="#_2-相对运动" aria-hidden="true">#</a> 2.相对运动</h4><p>当相机与它所拍摄的物体同时运动的时候，相机所拍摄的画面不会有任何改变</p><p><img src="/visual/webgl/26.png" alt=""></p><p>因此，我们可以默认相机的视点就在零点，相机看向-z 方向，其上方向就是 y 轴。<br> 当我我们改变的相机的视点、视线和上方向的时候，只要相对的去改变场景中的物体即可。<br> 而这个相对的去改变场景中的物体的矩阵，就是视图矩阵。</p><p><img src="/visual/webgl/27.png" alt=""></p><p>通过上面原理可以知道，想要计算视图矩阵，让其满足以下条件即可：</p><ol><li>把视点 e(ex,ey,ez)对齐到 O 点上</li><li>把视线 c(cx,cy,cz) 旋转到-z 轴上</li><li>把上方向 b(bx,by,bz) 旋转到 y 轴上</li><li>把 c 与 b 的垂线 a(ax,ay,az) 旋转到 x 轴上</li></ol><h4 id="_3-正交矩阵的旋转" tabindex="-1"><a class="header-anchor" href="#_3-正交矩阵的旋转" aria-hidden="true">#</a> 3.正交矩阵的旋转</h4><p>为了理解视图矩阵的运算，从几个例题说起。</p><p>题 1<br> 已知：点 A(1,0,0)<br> 求：把点 A 绕 z 轴逆时针旋转 30°，旋转到 B 点的行主序矩阵 m1<br><img src="/visual/webgl/28.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m1<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token constant">B</span><span class="token operator">=</span>m1<span class="token operator">*</span><span class="token constant">A</span>
<span class="token constant">B</span><span class="token punctuation">.</span>x<span class="token operator">=</span><span class="token punctuation">(</span>cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token function">·</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span>cos30°
<span class="token constant">B</span><span class="token punctuation">.</span>y<span class="token operator">=</span><span class="token punctuation">(</span>sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token function">·</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span>sin30°
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>题 2<br> 继题 1 的已知条件<br> 求：把点 B 绕 z 轴逆时针旋转-30°，旋转到 A 点的列行序矩阵 m2</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m2<span class="token operator">=</span><span class="token punctuation">[</span>
	cos<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span><span class="token operator">-</span>sin<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span>cos<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
m2<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span> sin30°<span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token operator">-</span>sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>观察题 1、题 2，我们可以发现两个规律：</p><ul><li>m2 是 m1 的逆矩阵</li><li>m2 也是 m1 的转置矩阵</li></ul><p>由此我们可以得到一个结论：<strong>正交旋转矩阵的逆矩阵就是其转置矩阵</strong>。</p><p>题 3<br> 已知：</p><ul><li><p>三维直角坐标系 m1，其基向量是：</p><ul><li>x(1,0,0)</li><li>y(0,1,0)</li><li>z(0,0,1)</li></ul></li><li><p>三维直角坐标系 m2，其基向量是：</p><ul><li>x(cos30°, sin30°,0)</li><li>y(-sin30°,cos30°,0)</li><li>z(0, 0, 1)</li></ul></li></ul><p>求：将 m1 中的基向量对齐到 m2 的行主序矩阵 m3<br><img src="/visual/webgl/29.png" alt=""></p><p>解：</p><p>将 m2 的基向量 x,y,z 中的 x 分量写入 m3 第 1 行;<br> 将 m2 的基向量 x,y,z 中的 y 分量写入 m3 第 2 行;<br> 将 m2 的基向量 x,y,z 中的 z 分量写入 m3 第 3 行。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m3<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>题 4<br> 继题 3 的已知条件<br> 求：将 m2 中的基向量对齐到 m1 的行主序矩阵 m4</p><p>解：<br> 由题 3 已知：将 m1 中的基向量对齐到 m2 的行主序矩阵是 m3<br> 由题 4 的问题可知：m4 就是 m3 的逆矩阵<br> 因为：正交旋转矩阵的逆矩阵就是其转置矩阵<br> 所以：m4 就是 m3 的转置矩阵</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m3<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
m4<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token operator">-</span>sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_4-计算视图矩阵" tabindex="-1"><a class="header-anchor" href="#_4-计算视图矩阵" aria-hidden="true">#</a> 4.计算视图矩阵</h4><p><img src="/visual/webgl/30.png" alt=""></p><ol><li>先位移：写出把视点 e(ex,ey,ez) 对齐到 O 点上的行主序位移矩阵 mt</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>mt
mt=<span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>-ex<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>-ey<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>-ez<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>写出把{o;x,y,-z} 对齐到{e;a,b,c} 的行主序旋转矩阵 mr1</li></ol><p>把 a,b,-c 的 x 分量写入 mr1 的第 1 行；<br> ​ 把 a,b,-c 的 y 分量写入 mr1 的第 2 行；<br> ​ 把 a,b,-c 的 z 分量写入 mr1 的第 3 行；</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>mr1
mr1=<span class="token punctuation">[</span>
	 ax<span class="token punctuation">,</span> bx<span class="token punctuation">,</span> -cx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 ay<span class="token punctuation">,</span> by<span class="token punctuation">,</span> -cy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 az<span class="token punctuation">,</span> bz<span class="token punctuation">,</span> -cz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>计算 mr1 的逆矩阵 mr2。</li></ol><p>因为正交旋转矩阵的逆矩阵就是其转置矩阵，所以 mr2 就是 mr1 的转置矩阵。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>mr2
mr2=<span class="token punctuation">[</span>
	 ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 bx<span class="token punctuation">,</span> by<span class="token punctuation">,</span> bz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	-cx<span class="token punctuation">,</span>-cy<span class="token punctuation">,</span>-cz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li>视图投影矩阵=mr2*mt</li></ol><h4 id="_5-视图矩阵的代码实现" tabindex="-1"><a class="header-anchor" href="#_5-视图矩阵的代码实现" aria-hidden="true">#</a> 5.视图矩阵的代码实现</h4><p><img src="/visual/webgl/30.png" alt=""></p><p>基于视点、目标点、上方向生成视图矩阵。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>getViewMatrix 相当于 threeJS 的 lookAt 方法
function getViewMatrix(e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> u) <span class="token punctuation">{</span>
  <span class="token comment">//基向量c，视线</span>
  const c = new Vector3().subVectors(e<span class="token punctuation">,</span> t).normalize()
  <span class="token comment">//基向量a，视线和上方向的垂线</span>
  const a = new Vector3().crossVectors(u<span class="token punctuation">,</span> c).normalize()
  <span class="token comment">//基向量b，修正上方向</span>
  const b = new Vector3().crossVectors(c<span class="token punctuation">,</span> a).normalize()
  <span class="token comment">//正交旋转矩阵</span>
  const mr = new Matrix4().set(
    ...a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    ...b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    -c.x<span class="token punctuation">,</span> -c.y<span class="token punctuation">,</span> -c.z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
  )
  <span class="token comment">//位移矩阵</span>
  const mt = new Matrix4().set(
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> -e.x<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> -e.y<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> -e.z<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
  )
  return mr.multiply(mt).elements
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>getViewMatrix 方法就是从一个新的角度去看某一个东西的意思</p><ul><li>e 视点</li><li>t 目标点</li><li>u 上方向</li></ul><p>在其中我借助了 Three.js 的 Vector3 对象</p><ul><li>subVectors(e, t) 向量 e 减向量 t</li><li>normalize() 向量的归一化</li><li>crossVectors(u, d) 向量 u 和向量 d 的叉乘</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">crossVectors</span><span class="token punctuation">(</span> <span class="token parameter">a<span class="token punctuation">,</span> b</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ax <span class="token operator">=</span> a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> ay <span class="token operator">=</span> a<span class="token punctuation">.</span>y<span class="token punctuation">,</span> az <span class="token operator">=</span> a<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token keyword">const</span> bx <span class="token operator">=</span> b<span class="token punctuation">.</span>x<span class="token punctuation">,</span> by <span class="token operator">=</span> b<span class="token punctuation">.</span>y<span class="token punctuation">,</span> bz <span class="token operator">=</span> b<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> ay <span class="token operator">*</span> bz <span class="token operator">-</span> az <span class="token operator">*</span> by<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> az <span class="token operator">*</span> bx <span class="token operator">-</span> ax <span class="token operator">*</span> bz<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">=</span> ax <span class="token operator">*</span> by <span class="token operator">-</span> ay <span class="token operator">*</span> bx<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>解释一下上面基向量 a,b,c 的运算原理，以下图为例：</p><p><img src="/visual/webgl/31.png" alt=""></p><p>视线 c 之所以是视点 e 减目标点 t，是为了取一个正向的基向量。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>c<span class="token operator">=</span><span class="token punctuation">(</span>e<span class="token operator">-</span>t<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">|</span>e<span class="token operator">-</span>t<span class="token operator">|</span>
c<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
c<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>基向量 a 是上方向 u 和向量 c 的叉乘</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>a<span class="token operator">=</span>u<span class="token operator">^</span>c<span class="token operator">/</span><span class="token operator">|</span>u<span class="token operator">^</span>c<span class="token operator">|</span>
a<span class="token operator">=</span><span class="token punctuation">(</span>cos30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span>cos30°
a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>基向量 b 是向量 c 和向量 a 的叉乘，可以理解为把上方向摆正</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>b<span class="token operator">=</span>c<span class="token operator">^</span>a<span class="token operator">/</span><span class="token operator">|</span>c<span class="token operator">^</span>a<span class="token operator">|</span>
b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1</span>
b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_6-测试" tabindex="-1"><a class="header-anchor" href="#_6-测试" aria-hidden="true">#</a> 6.测试</h4><ol><li>顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//视图矩阵</span>
    uniform mat4 u_ViewMatrix<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_ViewMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>建立视图矩阵，并传递给顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token function">getViewMatrix</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注：</p><p>three.js 里的 lookAt() 方法便可以实现矩阵的正交旋转，其参数也是视点、目标点、上方向，它的实现原理上面说的是一样的。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-模型矩阵" tabindex="-1"><a class="header-anchor" href="#_4-模型矩阵" aria-hidden="true">#</a> 4.模型矩阵</h3><p>模型矩阵可以对物体进行位移、旋转、缩放变换，比如我们想让物体沿 z 旋转</p><p>代码实现：</p><ol><li>在顶点着色器中添加一个模型矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//模型矩阵</span>
    uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
    <span class="token comment">//视图矩阵</span>
    uniform mat4 u_ViewMatrix<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_ViewMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="2"><li>在 js 中建立模型矩阵，并传递给顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ModelMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="3"><li>添加一个旋转动画</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> angle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  angle <span class="token operator">+=</span> <span class="token number">0.02</span><span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="4"><li>还可以来个弹性动画</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> angle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> minY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.7</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> maxY <span class="token operator">=</span> <span class="token number">0.7</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> maxY<span class="token punctuation">;</span>
<span class="token keyword">let</span> vy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ay <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.001</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bounce <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  angle <span class="token operator">+=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>
  vy <span class="token operator">+=</span> ay<span class="token punctuation">;</span>
  y <span class="token operator">+=</span> vy<span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> minY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    y <span class="token operator">=</span> minY<span class="token punctuation">;</span>
    vy <span class="token operator">*=</span> <span class="token operator">-</span>bounce<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="七、颜色与纹理" tabindex="-1"><a class="header-anchor" href="#七、颜色与纹理" aria-hidden="true">#</a> 七、颜色与纹理</h2><h3 id="_1-多-attribute-变量" tabindex="-1"><a class="header-anchor" href="#_1-多-attribute-变量" aria-hidden="true">#</a> 1.多 attribute 变量</h3><p>如何一次性绘制三个不同颜色的点？</p><ol><li>多点同色</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize<span class="token operator">=</span><span class="token number">50.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_FragColor<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span>u_FragColor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> u_FragColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_FragColor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform4f</span><span class="token punctuation">(</span>u_FragColor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这种方式只会绘制三个同样颜色的点。<br> 那我们若想给这三个点不同的颜色，就需要再建立一个接收颜色数据的 attribute 变量。</p><ol start="2"><li>多点异色</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>&lt;canvas id=<span class="token string">&quot;canvas&quot;</span>&gt;&lt;/canvas&gt;
&lt;!-- 顶点着色器 --&gt;
&lt;script id=<span class="token string">&quot;vertexShader&quot;</span> type=<span class="token string">&quot;x-shader/x-vertex&quot;</span>&gt;
  attribute vec4 a_Position;
  attribute vec4 a_Color;
  varying vec4 v_Color;
  void main()<span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position=a_Position;
      <span class="token comment">//尺寸</span>
      gl_PointSize=<span class="token number">50.0</span>;
      v_Color=a_Color;
  <span class="token punctuation">}</span>
&lt;/script&gt;
&lt;!-- 片元着色器 --&gt;
&lt;script id=<span class="token string">&quot;fragmentShader&quot;</span> type=<span class="token string">&quot;x-shader/x-fragment&quot;</span>&gt;
  precision mediump float;
  varying vec4 v_Color;
  void main()<span class="token punctuation">{</span>
      gl_FragColor=v_Color;
  <span class="token punctuation">}</span>
&lt;/script&gt;
&lt;script type=<span class="token string">&quot;module&quot;</span>&gt;
  import <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> from <span class="token string">&quot;../jsm/Utils.js&quot;</span>;

  const canvas = document.querySelector(<span class="token string">&quot;#canvas&quot;</span>);
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  <span class="token comment">// 获取着色器文本</span>
  const vsSource = document.querySelector(<span class="token string">&quot;#vertexShader&quot;</span>).innerText;
  const fsSource = document.querySelector(<span class="token string">&quot;#fragmentShader&quot;</span>).innerText;

  <span class="token comment">//三维画笔</span>
  const gl = canvas.getContext(<span class="token string">&quot;webgl&quot;</span>);

  <span class="token comment">//初始化着色器</span>
  initShaders(gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource);
  <span class="token comment">//声明颜色 rgba</span>
  gl.clearColor(<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>);

  <span class="token comment">//如何向attribute 变量中写入多点，并绘制多点</span>
  <span class="token comment">//顶点数据</span>
  const vertices = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    <span class="token number">-0.2</span><span class="token punctuation">,</span> <span class="token number">-0.1</span><span class="token punctuation">,</span>
    <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">-0.1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>);
  <span class="token comment">//缓冲对象</span>
  const vertexBuffer = gl.createBuffer();
  <span class="token comment">//绑定缓冲对象</span>
  gl.bindBuffer(gl.ARRAY_BUFFER<span class="token punctuation">,</span> vertexBuffer);
  <span class="token comment">//写入数据</span>
  gl.bufferData(gl.ARRAY_BUFFER<span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl.STATIC_DRAW)
  <span class="token comment">//获取attribute 变量</span>
  const a_Position = gl.getAttribLocation(gl.program<span class="token punctuation">,</span> &#39;a_Position&#39;)
  <span class="token comment">//修改attribute 变量</span>
  gl.vertexAttribPointer(a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl.FLOAT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>)
  <span class="token comment">//赋能-批处理</span>
  gl.enableVertexAttribArray(a_Position)


  <span class="token comment">//颜色数据</span>
  const colors = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
  <span class="token punctuation">]</span>);
  <span class="token comment">//缓冲对象</span>
  const colorBuffer = gl.createBuffer();
  <span class="token comment">//绑定缓冲对象</span>
  gl.bindBuffer(gl.ARRAY_BUFFER<span class="token punctuation">,</span> colorBuffer);
  <span class="token comment">//写入数据</span>
  gl.bufferData(gl.ARRAY_BUFFER<span class="token punctuation">,</span> colors<span class="token punctuation">,</span> gl.STATIC_DRAW)
  <span class="token comment">//获取attribute 变量</span>
  const a_Color = gl.getAttribLocation(gl.program<span class="token punctuation">,</span> &#39;a_Color&#39;)
  <span class="token comment">//修改attribute 变量</span>
  gl.vertexAttribPointer(a_Color<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> gl.FLOAT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>)
  <span class="token comment">//赋能-批处理</span>
  gl.enableVertexAttribArray(a_Color)

  <span class="token comment">//刷底色</span>
  gl.clear(gl.COLOR_BUFFER_BIT);

  <span class="token comment">//绘制顶点</span>
  gl.drawArrays(gl.POINTS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span>);
&lt;/script&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><p>在上面的案例里，用 js 建立了两份 attribute 数据，一份是顶点位置数据，一份是顶点颜色数据。<br> 然后将两份 attribute 数据放进了了两个缓冲区对象里，后面绘图的时候，顶点着色器就会从这里面找数据。<br> 其实，也可以把数据合一下，把点位数据和颜色数据放进一个集合里，然后让 attribute 变量按照某种规律从其中寻找数据。</p><ol start="3"><li>多 attribute 数据合一</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>&lt;canvas id=<span class="token string">&quot;canvas&quot;</span>&gt;&lt;/canvas&gt;
&lt;!-- 顶点着色器 --&gt;
&lt;script id=<span class="token string">&quot;vertexShader&quot;</span> type=<span class="token string">&quot;x-shader/x-vertex&quot;</span>&gt;
  attribute vec4 a_Position;
  attribute vec4 a_Color;
  varying vec4 v_Color;
  void main()<span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position=a_Position;
      <span class="token comment">//尺寸</span>
      gl_PointSize=<span class="token number">50.0</span>;
      v_Color=a_Color;
  <span class="token punctuation">}</span>
&lt;/script&gt;
&lt;!-- 片元着色器 --&gt;
&lt;script id=<span class="token string">&quot;fragmentShader&quot;</span> type=<span class="token string">&quot;x-shader/x-fragment&quot;</span>&gt;
  precision mediump float;
  varying vec4 v_Color;
  void main()<span class="token punctuation">{</span>
      gl_FragColor=v_Color;
  <span class="token punctuation">}</span>
&lt;/script&gt;
&lt;script type=<span class="token string">&quot;module&quot;</span>&gt;
  import <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> from <span class="token string">&quot;../jsm/Utils.js&quot;</span>;

  const canvas = document.querySelector(<span class="token string">&quot;#canvas&quot;</span>);
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  <span class="token comment">// 获取着色器文本</span>
  const vsSource = document.querySelector(<span class="token string">&quot;#vertexShader&quot;</span>).innerText;
  const fsSource = document.querySelector(<span class="token string">&quot;#fragmentShader&quot;</span>).innerText;

  <span class="token comment">//三维画笔</span>
  const gl = canvas.getContext(<span class="token string">&quot;webgl&quot;</span>);

  <span class="token comment">//初始化着色器</span>
  initShaders(gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource);
  <span class="token comment">//声明颜色 rgba</span>
  gl.clearColor(<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>);

  <span class="token comment">//数据源</span>
  const source = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">-0.2</span><span class="token punctuation">,</span> <span class="token number">-0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">-0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>);
  <span class="token comment">//元素字节数</span>
  const elementBytes = source.BYTES_PER_ELEMENT
  <span class="token comment">//系列尺寸</span>
  const verticeSize = <span class="token number">3</span>
  const colorSize = <span class="token number">4</span>
  <span class="token comment">//类目尺寸</span>
  const categorySize = verticeSize + colorSize
  <span class="token comment">//类目字节数</span>
  const categoryBytes = categorySize * elementBytes
  <span class="token comment">//系列字节索引位置</span>
  const verticeByteIndex = <span class="token number">0</span>
  const colorByteIndex = verticeSize * elementBytes
  <span class="token comment">//顶点总数</span>
  const sourceSize = source.length / categorySize


  <span class="token comment">//缓冲对象</span>
  const sourceBuffer = gl.createBuffer();
  <span class="token comment">//绑定缓冲对象</span>
  gl.bindBuffer(gl.ARRAY_BUFFER<span class="token punctuation">,</span> sourceBuffer);
  <span class="token comment">//写入数据</span>
  gl.bufferData(gl.ARRAY_BUFFER<span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl.STATIC_DRAW)

  <span class="token comment">//获取attribute 变量</span>
  const a_Position = gl.getAttribLocation(gl.program<span class="token punctuation">,</span> &#39;a_Position&#39;)
  <span class="token comment">//修改attribute 变量</span>
  gl.vertexAttribPointer(
    a_Position<span class="token punctuation">,</span>
    verticeSize<span class="token punctuation">,</span>
    gl.FLOAT<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    verticeByteIndex
  )
  <span class="token comment">//赋能-批处理</span>
  gl.enableVertexAttribArray(a_Position)

  <span class="token comment">//获取attribute 变量</span>
  const a_Color = gl.getAttribLocation(gl.program<span class="token punctuation">,</span> &#39;a_Color&#39;)
  <span class="token comment">//修改attribute 变量</span>
  gl.vertexAttribPointer(
    a_Color<span class="token punctuation">,</span>
    colorSize<span class="token punctuation">,</span>
    gl.FLOAT<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    colorByteIndex
  )
  <span class="token comment">//赋能-批处理</span>
  gl.enableVertexAttribArray(a_Color)

  <span class="token comment">//刷底色</span>
  gl.clear(gl.COLOR_BUFFER_BIT);

  <span class="token comment">//绘制顶点</span>
  gl.drawArrays(gl.POINTS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize);
&lt;/script&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br></div></div><p>对应上面的数据，我们要先有以下概念：</p><ul><li>数据源：整个合而为一的数据 source</li><li>元素字节数：32 位浮点集合中每个元素的字节数</li><li>类目：一个顶点对应一个类目，也就是上面 source 中的每一行</li><li>系列：一个类目中所包含的每一种数据，比如顶点位置数据、顶点颜色数据</li><li>系列尺寸：一个系列所对应的向量的分量数目</li><li>类目尺寸：一个类目中所有系列尺寸的总和</li><li>类目字节数：一个类目的所有字节数量</li><li>系列元素索引位置：一个系列在一个类目中，以集合元素为单位的索引位置</li><li>系列字节索引位置：一个系列在一个类目中，以字节为单位的索引位置</li><li>顶点总数：数据源中的顶点总数</li></ul><p>vertexAttribPointer() 方法玩转数据源：</p><ul><li>以前在说 vertexAttribPointer() 的时候，说过它的功能就是让 gl 修改 attribute 上下文对象的。</li><li>其实具体而言，它是在告诉顶点着色器中的 attribute 变量以怎样的方式从顶点着色器中寻找它所需要的数据。</li><li>比如，我想让顶点着色器中，名叫 a_Position 的 attribute 的变量从数据源中，寻找它所需要的数据。</li></ul><p>gl.vertexAttribPointer(index, size, type, normalized, stride, offset)</p><ul><li>index：attribute 变量，具体而言是指向存储 attribute 变量的空间的指针</li><li>size：系列尺寸</li><li>type：元素的数据类型</li><li>normalized：是否归一化</li><li>stride：类目字节数</li><li>offset：系列索引位置</li></ul><h3 id="_2-彩色三角形" tabindex="-1"><a class="header-anchor" href="#_2-彩色三角形" aria-hidden="true">#</a> 2.彩色三角形</h3><p>可以用独立三角形绘图：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourseSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl/32.png" alt=""></p><p>原理：<br> 三角形的三个顶点绑定了三种颜色，在三个点之间做线性补间，将补间得出的颜色填充到三角形所围成的每个片元之中。</p><p><img src="/visual/webgl/33.gif" alt=""></p><h3 id="_3-纹理" tabindex="-1"><a class="header-anchor" href="#_3-纹理" aria-hidden="true">#</a> 3.纹理</h3><p>纹理，通常指的就是二维的栅格图像，可以将其作为 webgl 图形的贴图。</p><p>而在 webgl 里，还有一个纹理对象的概念，它是对图像又做了一层封装。</p><h4 id="_1-基础概念" tabindex="-1"><a class="header-anchor" href="#_1-基础概念" aria-hidden="true">#</a> 1.基础概念</h4><ol><li>栅格系统</li></ol><p>在说图像的时候，往往都是指点阵图、栅格图、位图，而与其相对应的是图形，也做矢量图。</p><p>纹理，就是属于图像，其图像的建立和显示会遵循栅格系统里的规范</p><p>所有图像都是由像素组成的，在 webgl 里我们把像素称为片元，像素是按照相互垂直的行列排列的</p><p>如下图：<br><img src="/visual/webgl/34.png" alt=""></p><p>将其放大后就可以看见其中的栅格：<br><img src="/visual/webgl/35.png" alt=""></p><p>图像中的每个像素都可以通过行数 y 和列数 x 来找到，由(x,y) 构成的点位，就是图像的像素坐标。</p><p>因为 canvas 画布也是一张图像，所以图像的栅格坐标系和我们之前说过的 canvas2d 的坐标系是一样的，我们可以简单回顾一下：</p><p><img src="/visual/webgl/2.png" alt=""></p><p>栅格坐标系的原点在左上角。<br> 栅格坐标系的 y 轴方向是朝下的。<br> 栅格坐标系的坐标基底由两个分量组成，分别是一个像素的宽和一个像素的高。</p><ol start="2"><li>图钉</li></ol><p>图钉是我自己写的概念，源自于 photoshop 中图像的操控变形功能，这种称呼很形象。</p><p><img src="/visual/webgl/36.png" alt=""></p><p>webgl 中，图钉的位置是通过 uv 坐标来控制的，图钉的 uv 坐标和顶点的 webgl 坐标是两种不同的坐标系统，之后会将其相互映射，从而将图像特定的一块区域贴到 webgl 图形中。</p><p>比如将其映射到下面的蓝色三角形中：<br><img src="/visual/webgl/37.png" alt=""></p><p>注：在 webgl 里打图钉的时候不会发生边界线的扭曲，上图重在示意。</p><ol start="3"><li>uv 坐标系</li></ol><p><img src="/visual/webgl/38.png" alt=""></p><p>uv 坐标系，也叫 st 坐标系，坐标原点在图像的左下角，u 轴在右，v 轴在上<br> u 轴上的 1 个单位是图像的宽；<br> v 轴上的一个单位是图像的高。</p><ol start="4"><li>采样器</li></ol><p>采样器是按照图钉位置从图像中获取片元的方式。</p><p>在图像中所打的图钉位置，并不是图像中某一个片元的位置，因为片元位置走的是栅格坐标系。</p><p>所以需要一个采样器去对图钉的 uv 坐标系和像素的栅格坐标系做映射，从而去采集图像中图钉所对应的片元。</p><p>着色器基于一张图像可以建立一个或多个采样器，不同的采样器可以定义不同的规则去获取图像中的片元。</p><p>采样器在着色器中是一种变量类型，写做 sampler2D，它就像我们之前写过的 vec4 类型一样，可以在片元着色器中通过 uniform 变量暴露给 js，让 js 对其进行修改。</p><ol start="5"><li>纹理对象</li></ol><p>着色器使用一个纹理对象，就可以建立一个采样器。</p><p>纹理对象的建立需要一个图像源，比如 Image 对象。</p><p>同时，还需要设置纹理对象和图钉进行数据映射的方式。</p><p>js =&gt; 纹理对象，webgl =&gt; 缓冲区<br> 缓存区用于存放纹理对象的磁盘空间，这块空间可以将纹理对象翻译成着色器可以读懂的数据。<br> 之后会把这个空间的索引位置传给着色器，让着色器基于这个空间的索引位置，找到这个空间，然后再从空间中找到纹理对象，最后通过纹理对象建立采样器。</p><ol start="6"><li>纹理单元</li></ol><p>纹理单元是一种专门用来存放纹理对象的缓冲区，就像我们之前用 createBuffer()方法建立的用于存储数据源的缓冲区一样。</p><p>webgl=&gt; 纹理单元，如 TEXTURE0|1|2|3|4|5|6|7|</p><p>纹理单元虽然无需我们自己建立，但需要我们自己激活，让其进入使用状态</p><h4 id="_2-整体代码" tabindex="-1"><a class="header-anchor" href="#_2-整体代码" aria-hidden="true">#</a> 2.整体代码</h4><ol><li>顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute vec2 a_Pin<span class="token punctuation">;</span>
    varying vec2 v_Pin<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      v_Pin<span class="token operator">=</span>a_Pin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>a_Pin 图钉位置</li></ul><ol start="2"><li>片元着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>
    precision mediump float<span class="token punctuation">;</span>
    uniform sampler2D u_Sampler<span class="token punctuation">;</span>
    varying vec2 v_Pin<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>sampler2D 是 uniform 变量的类型，叫做二维取样器</li><li>texture2D() 基于图钉从取样器中获取片元颜色</li></ul><ol start="3"><li>初始化着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="4"><li>建立数据源，并计算相应尺寸</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">//数据源</span>
const source = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">-0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">-0.5</span><span class="token punctuation">,</span> <span class="token number">-0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">-0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>);
const FSIZE = source.BYTES_PER_ELEMENT;
<span class="token comment">//元素字节数</span>
const elementBytes = source.BYTES_PER_ELEMENT
<span class="token comment">//系列尺寸</span>
const posSize = <span class="token number">2</span>
const PinSize = <span class="token number">2</span>
<span class="token comment">//类目尺寸</span>
const categorySize = posSize + PinSize
<span class="token comment">//类目字节数</span>
const categoryBytes = categorySize * elementBytes
<span class="token comment">//系列字节索引位置</span>
const posByteIndex = <span class="token number">0</span>
const pinByteIndex = posSize * elementBytes
<span class="token comment">//顶点总数</span>
const sourceSize = source.length / categorySize
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>数据源中有两个系列，分别是顶点位置系列和图钉位置系列。</p><ol start="5"><li>将数据源写入到缓冲区，让 attribute 变量从其中寻找数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> sourceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
  a_Position<span class="token punctuation">,</span>
  posSize<span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>
  categoryBytes<span class="token punctuation">,</span>
  posByteIndex
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> a_Pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Pin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
  a_Pin<span class="token punctuation">,</span>
  pinSize<span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>
  categoryBytes<span class="token punctuation">,</span>
  pinByteIndex
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ol start="6"><li>建立 Image 图像作为图像源，当图像源加载成功后再贴图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//对纹理图像垂直翻转</span>
gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//激活0号纹理单元</span>
gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//纹理对象</span>
<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//把纹理对象装进纹理单元里</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//image 对象</span>
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha2.jpg&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">showMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//贴图</span>
<span class="token keyword">function</span> <span class="token function">showMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//配置纹理图像</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//配置纹理参数</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//获取u_Sampler</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//将0号纹理分配给着色器，0 是纹理单元编号</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//渲染</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h4 id="_3-贴图详解" tabindex="-1"><a class="header-anchor" href="#_3-贴图详解" aria-hidden="true">#</a> 3.贴图详解</h4><ol><li>准备三个角色</li></ol><ul><li>Image 图像</li><li>纹理对象</li><li>纹理单元</li></ul><p><img src="/visual/webgl/39.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 激活0号纹理单元</span>
gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//纹理对象</span>
<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//image 对象</span>
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha.jpg&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>把纹理对象装进当前已被激活的纹理单元里</li></ol><p><img src="/visual/webgl/40.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>TEXTURE_2D 纹理对象的类型</li></ul><ol start="3"><li>当 Image 图像加载成功后，把图像装进当前纹理单元的纹理对象里</li></ol><p><img src="/visual/webgl/41.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>texImage2D(type, level, internalformat, format, type, pixels)</p><ul><li>type 纹理类型</li><li>level 基本图像等级</li><li>internalformat 纹理中的颜色组件</li><li>format 纹理数据格式，必须和 internalformat 一样</li><li>type 纹理数据的数据类型 <ul><li>UNSIGNED_BYTE 无符号字节</li></ul></li><li>pixels 图像源</li></ul><ol start="4"><li>纹理对象还有一些相应参数需要设置一下</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>texParameteri(type, pname, param)</p><ul><li>type 纹理类型 <ul><li>TEXTURE_2D 二维纹理</li></ul></li><li>pname 纹理参数的名称 <ul><li>TEXTURE_MIN_FILTER 纹理缩小滤波器</li></ul></li><li>param 与 pname 相对应的纹理参数值 <ul><li>gl.LINEAR 线性</li></ul></li></ul><ol start="5"><li>在 js 中获取采样器对应的 Uniform 变量,告诉片元着色器中的采样器，纹理对象在哪个单元里。之后采样器便会根据单元号去单元对象中寻找纹理对象</li></ol><p><img src="/visual/webgl/42.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="6"><li>渲染</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>效果如下：<br><img src="/visual/webgl/43.png" alt=""><br> 这时候的图像是倒立的，这是由于 Image 对象遵守的是栅格坐标系，栅格坐标系的 y 轴朝下，而 uv 坐标系的 y 朝上，两者相反，所以画出的图形反了。</p><ol start="7"><li>对图像进行预处理，将图像垂直翻转</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>pixelStorei(pname, param) 图像预处理</p><ul><li>pname 参数名 <ul><li>gl.UNPACK_FLIP_Y_WEBGL 是否垂直翻，布尔值，1|0</li></ul></li><li>param 参数值</li></ul><p><img src="/visual/webgl/44.png" alt=""></p><h4 id="_4-纹理容器" tabindex="-1"><a class="header-anchor" href="#_4-纹理容器" aria-hidden="true">#</a> 4.纹理容器</h4><p>在贴图的时候，默认图像源的尺寸只能是 2 的 n 次方，比如 2、4、8、16、……、256、512 等，如果我们把图像的尺寸改成非 2 次幂尺寸，如 300*300，那贴图就无法显示。</p><p>要想解决这种问题，就得设置一下纹理的容器，在图像上打图钉的时候，形成一块 uv 区域，这块区域可以理解为纹理容器。纹理容器可以定义图钉区域的纹理如何显示在 webgl 图形中。通过对纹理容器的设置，我们可以实现以下功能：</p><ul><li>非二次幂图像源的显示</li><li>纹理的复制</li><li>纹理的镜像</li></ul><ol><li>非二次幂图像源的显示</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>TEXTURE_WRAP_S 和 TEXTURE_WRAP_T 就是纹理容器在 s 方向和 t 方向的尺寸，这里的 s、t 就是 st 坐标系里的 s、t，st 坐标系和 uv 坐标系是一回事。</p><p>CLAMP_TO_EDGE 翻译过来就是边缘夹紧的意思，可以理解为任意尺寸的图像源都可以被宽高为 1 的 uv 尺寸夹紧。</p><p>注：只有 CLAMP_TO_EDGE 才能实现非二次幂图像源的显示，其它的参数都不可以。</p><ol start="2"><li>纹理的复制</li></ol><p>uv 坐标系的坐标基底分别是 1 个图片的宽和 1 个图片的高，可是如果我们将 2 个图片的宽高映射到了图形上会是什么结果呢？</p><p>默认是这样的：<br><img src="/visual/webgl/45.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>REPEAT 就是纹理重复的意思</p><ol start="3"><li>纹理的镜像复制 纹理的镜像复制可以实现纹理的水平、垂直翻转和复制。</li></ol><p>效果如下：<br><img src="/visual/webgl/46.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">MIRRORED_REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">MIRRORED_REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>MIRRORED_REPEAT 就是镜像复制的意思。</p><p>也可以通过使用 CLAMP_TO_EDGE 只对某一个方向纹理镜像复制</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">MIRRORED_REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>效果如下：<br><img src="/visual/webgl/47.png" alt=""></p><h4 id="_5-分子贴图" tabindex="-1"><a class="header-anchor" href="#_5-分子贴图" aria-hidden="true">#</a> 5.分子贴图</h4><p>分子贴图 mipmap 是一种纹理映射技术。</p><p>比如：</p><p>webgl 中有一个正方形，它在 canvas 画布中显示的时候，占据了 2*2 个像素，我们要将一个 8*8 的图像源贴上去。</p><p>正方形中肯定不能显示图像源中的所有像素，因为它只有 2*2=4 个像素。</p><p>在 Photoshop 中，会将图像源切割成 2 行、2 列的色块，然后将每个色块的均值交个正方形。</p><p>在 webgl 中也有类似的方法，并且它还有一层渲染性能的优化（Photoshop 底层是否有这层优化我尚且不知）。</p><p>接下来咱们就说一下这层优化优化的是什么。</p><p>先想象一个场景，我要把 1024*1024 的图像源映射到 canvas 画布上 2*2 的正方形中，若把图像源分割求均值会产生庞大的数据运算，我们需要想办法把和正方形相映射的图像源的尺寸降到最小，比如就是 2*2 的。</p><p>因此，我们就需要<a href="https://baike.baidu.com/item/Mipmap/3722136?fr=aladdin" target="_blank" rel="noopener noreferrer">分子贴图<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>了。</p><p>分子贴图是一个基于分辨率等比排列的图像集合，集合中每一项的宽高与其前一项宽高的比值都是 1/2。</p><p>如下图：</p><p><img src="/visual/webgl/48.png" alt=""></p><p>在 webgl 中，我们可以使用 gl.generateMipmap() 方法为图像源创建分子贴图，</p><p>有了分子贴图后，之前 2*2 的正方形便会从分子集合中寻找与其分辨率最接近的分子图像。</p><p>在找到分子图像后，就需要基于 webgl 图形的片元尺寸对其分割取色了。</p><p>对于取色的方法，咱们之前说一个均值算法，其实还有其它算法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//创建分子贴图</span>
gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//定义从分子图像中取色的方法</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>gl.texParameteri()方法中的第 2 个参数和第 3 个参数是键值对的关系。</p><p>TEXTURE_MAG_FILTER 和 TEXTURE_MIN_FILTER，对应的是纹理在 webgl 图形中的缩放情况。</p><ul><li>TEXTURE_MAG_FILTER 纹理放大滤波器，是纹理在 webgl 图形中被放大的情况。</li><li>TEXTURE_MIN_FILTER 纹理缩小滤波器，是纹理在 webgl 图形中被缩小的情况。</li></ul><p>TEXTURE_MAG_FILTER 具备以下参数：</p><ul><li>LINEAR (默认值) ，线性滤镜， 获取纹理坐标点附近 4 个像素的加权平均值，效果平滑</li><li>NEAREST 最近滤镜， 获得最靠近纹理坐标点的像素 ，效果锐利</li></ul><p>TEXTURE_MIN_FILTER 具备以下参数：</p><ul><li>LINEAR 线性滤镜，获取纹理坐标点附近 4 个像素的加权平均值，效果平滑</li><li>NEAREST 最近滤镜， 获得最靠近纹理坐标点的像素，效果锐利</li><li>NEAREST_MIPMAP_NEAREST Select the nearest mip level and perform nearest neighbor filtering .</li><li>NEAREST_MIPMAP_LINEAR (默认值) Perform a linear interpolation between mip levels and perform nearest neighbor filtering within each .</li><li>LINEAR_MIPMAP_NEAREST Select the nearest mip level and perform linear filtering within it .</li><li>LINEAR_MIPMAP_LINEAR Perform a linear interpolation between mip levels and perform linear filtering : also called trilinear filtering .</li></ul><p>注：后面这 4 个与分子贴图相关的参数适合比较大的贴图，若是比较小的贴图，使用 LINEAR 或 NEAREST 就好。</p><p>注：缩小滤波器的默认值取色方法是 NEAREST_MIPMAP_LINEAR ，这个方法会从分子贴图里找分子图像，然后从其中取色，然而当我们没有使用 gl.generateMipmap()方法建立分子贴图的时候，就得给它一个不需要从分子贴图中去色的方法，如 LINEAR 或 NEAREST。</p><h4 id="_6-多纹理模型" tabindex="-1"><a class="header-anchor" href="#_6-多纹理模型" aria-hidden="true">#</a> 6.多纹理模型</h4><p>在实际开发中，经常会遇到一个模型，多个纹理的的情况。</p><p>比如这个魔方：</p><p><img src="/visual/webgl/50.gif" alt=""></p><p>有时候会很自然的想到一个面给它一个贴图，而实际上，最高效的方式是一个物体给它一个贴图，如下图：</p><p><img src="/visual/webgl/50.jpg" alt=""></p><p>这样只需要加载一次图片，建立一个纹理对象，做一次纹理和顶点数据的映射就可以了。</p><p>这里面没有涉及任何新的知识点，但这是一种很重要的项目开发经验。</p><h3 id="_4-纹理合成" tabindex="-1"><a class="header-anchor" href="#_4-纹理合成" aria-hidden="true">#</a> 4.纹理合成</h3><p>纹理合成就是按照某种规则将多张图片合在一起。</p><h4 id="_4-1-多图加载" tabindex="-1"><a class="header-anchor" href="#_4-1-多图加载" aria-hidden="true">#</a> 4-1 多图加载</h4><p>纹理合成是需要多张图像源的，因此我们需要多张图像源都加载成功后，再去合成纹理。</p><ol><li>将图像的加载方法封装进一个 Promise 中，等图像加载成功后，再 resolve。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">imgPromise</span><span class="token punctuation">(</span><span class="token parameter">img</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>建立多个 Image 对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> originImg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
originImg<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/dress.jpg&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pattern<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/pattern1.jpg&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>利用 Promise.all 监听所有图片的记载成功</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">imgPromise</span><span class="token punctuation">(</span>originImg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">imgPromise</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  rect<span class="token punctuation">.</span>maps <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_Sampler</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">image</span><span class="token operator">:</span> originImg <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Pattern</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">image</span><span class="token operator">:</span> pattern <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  rect<span class="token punctuation">.</span><span class="token function">updateMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>等所有的图片都加载成功后，会往 rect 的 maps 集合里写入贴图，然后对其更新和渲染。</p><p>接下来，看一下纹理合成最核心的地方，片元着色器。</p><h4 id="_4-2-在片元着色器中合成纹理" tabindex="-1"><a class="header-anchor" href="#_4-2-在片元着色器中合成纹理" aria-hidden="true">#</a> 4-2 在片元着色器中合成纹理</h4><p>片元着色器：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>  
  precision mediump float<span class="token punctuation">;</span>  
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>  
  uniform sampler2D u_Pattern<span class="token punctuation">;</span>  
  varying vec2 v_Pin<span class="token punctuation">;</span>  
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    
    vec4 o<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    vec4 p<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Pattern<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    gl_FragColor<span class="token operator">=</span>p<span class="token operator">*</span>o<span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>u_Sampler 是原始图片采样器，对应下图：</li></ul><p><img src="/visual/webgl/51.jpg" alt=""></p><ul><li>u_Pattern 是纹理图案采样器，对应下图：</li></ul><p><img src="/visual/webgl/52.jpg" alt=""></p><p>之后，通过采样器找到原始图片和纹理图案的片元后，便可以对其进行运算：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec4 o<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
vec4 p<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Pattern<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl_FragColor<span class="token operator">=</span>p<span class="token operator">*</span>o<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面的 p*o 便是在对片元做分量相乘的运算，这种算法会让原始图片的亮度变暗，有点类似于 ps 里的正片叠底。</p><p><img src="/visual/webgl/53.png" alt=""></p><p>举个例子说一下片元相乘的逻辑。</p><p>已知：</p><ul><li>原始图像片元 o(ox,oy,oz,ow)</li><li>纹理图案片元 p(px,py,pz,pw)</li></ul><p>求：p*o</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>p <span class="token operator">*</span> o <span class="token operator">=</span> <span class="token punctuation">(</span>px <span class="token operator">*</span> ox<span class="token punctuation">,</span> py <span class="token operator">*</span> oy<span class="token punctuation">,</span> pz <span class="token operator">*</span> oz<span class="token punctuation">,</span> pw <span class="token operator">*</span> ow<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>通过此例可知：因为片元分量的值域为[0,1]，所以 p*o 的亮度小于等于 p 和 o</p><ul><li>当 p=(1,1,1,1) 时，p*o=o</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>p <span class="token operator">*</span> o <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> ox<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> oy<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> oz<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> ow<span class="token punctuation">)</span><span class="token punctuation">;</span>
p <span class="token operator">*</span> o <span class="token operator">=</span> <span class="token punctuation">(</span>ox<span class="token punctuation">,</span> oy<span class="token punctuation">,</span> oz<span class="token punctuation">,</span> ow<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>当 p=(0,0,0,0) 时，p*o=(0,0,0,0)</li></ul><h4 id="_4-3-纹理混合" tabindex="-1"><a class="header-anchor" href="#_4-3-纹理混合" aria-hidden="true">#</a> 4-3 纹理混合</h4><p>纹理混合就是按照一定比例，将第一张图像合到另一张图像上，这类似于 ps 里的透明度合成。</p><p>直接看一下纹理在片元着色里的合成方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>  
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  uniform sampler2D u_Pattern<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec4 o<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec4 p<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Pattern<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">mix</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上面的 mix() 方法便是按照比例对两个纹理的合成方法。</p><p>mix() 方法的返回数据类型会因其合成对象的不同而不同。</p><p>其规则如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> m <span class="token operator">+</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> m<span class="token punctuation">)</span> <span class="token operator">*</span> a<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>例 1：</p><ul><li>m=3</li><li>n=5</li><li>a=0.5</li></ul><p>求：mix(m,n,a)</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>例 2：</p><ul><li>m=(1,2,3)</li><li>n=(3,4,5)</li><li>a=0.5</li></ul><p>求：mix(m,n,a)</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>简单总结一下 mix(m,n,a) 方法的特性：</p><ul><li>当 a=0 时，mix(m,n,a)=m</li><li>当 a=1 时，mix(m,n,a)=n</li></ul><p>参考地址：https://www.khronos.org/registry/OpenGL-Refpages/gl4/</p><p>利用纹理混合，我们可以实现转场动画。</p><h3 id="_5-跨域图像做贴图" tabindex="-1"><a class="header-anchor" href="#_5-跨域图像做贴图" aria-hidden="true">#</a> 5.跨域图像做贴图</h3><p>这里要说的跨域图像问题，并不单是 webgl 问题，也是 canvas 2d 里的问题。</p><ol><li>img 标签与跨域图像</li></ol><p>用 img 标签显示跨域图像的时候，只能将图像展示给用户，但并不能获取图像中的数据。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;https://xxx/xxx.png&#39;&quot;</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>不能通过 img 标签获取图像数据，是浏览器出于安全考虑的，因为有的图像里可能会含有验证码、签名、或者其它不可告人的东东，这种数据是不能随意被别人获取的。</p><ol start="2"><li>获取图像数据</li></ol><p>若图像是同域的，下面的方法是没问题的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;https://xxx/xxx.png&quot;</span><span class="token punctuation">;</span>

img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>若图像是跨域的，那就会报错：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Failed to execute <span class="token string">&#39;getImageData&#39;</span> on <span class="token string">&#39;CanvasRenderingContext2D&#39;</span><span class="token operator">:</span> The canvas has been tainted by cross<span class="token operator">-</span>origin data<span class="token punctuation">.</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>用 webgl 获取跨域图像数据时，也会报错：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;https://xxx/xxx.png&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>错误信息：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Failed to execute <span class="token string">&#39;texImage2D&#39;</span> on <span class="token string">&#39;WebGLRenderingContext&#39;</span><span class="token operator">:</span> The image element contains cross<span class="token operator">-</span>origin data<span class="token punctuation">,</span> and may not be loaded<span class="token punctuation">.</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="3"><li>CORS 跨域</li></ol><p>CORS 是 Cross Origin Resource Sharing 的简写，译作跨域资源共享。</p><p>CORS 是一种网页向图像服务器请求使用图像许可的方式。</p><p>CORS 的实现过程如下：</p><p>1.先让服务器向其它域名放权，比如 Apache 服务器需要这样设置：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Header <span class="token keyword">set</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin <span class="token string">&quot;*&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>上面代码的意思就是允许其它域名的网页跨域获取自己服务端的资源。</p><p>上面的* 是允许所有域名获取其服务端资源。</p><p>我们也可以写具体的域名，从而允许特定域名获取其服务端资源。</p><p>2.在网页里，通过特定的方法告诉服务端，我需要跨域获取你的资源。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;https://xxx/xxx.png&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;crossOrigin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>有了上面 crossOrigin 属性的设置，无论是在 canvas 2d 里使用此图像源，还是在 webgl 里使用此图像源，都不会报错。</p><p>crossOrigin 接收的值有三种：</p><ul><li>undefined 是默认值，表示不需要向其它域名的服务器请求资源共享</li><li>anonymous 向其它域名的服务器请求资源共享，但不需要向其发送任何信息</li><li>use-credentials 向其它域名的服务器请求资源共享，并发送 cookies 等信息，服务器会通过这些信息决定是否授权</li></ul><h3 id="_6-视频贴图" tabindex="-1"><a class="header-anchor" href="#_6-视频贴图" aria-hidden="true">#</a> 6.视频贴图</h3><p>之前使用 texImage2D 方法将 Image 图像源装进了纹理对象里：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>也可以把上面的 image 换成 video 对象</p><ol><li>正常建立纹理对象，并设置其相关属性</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="2"><li>获取采样器对应的 uniform 变量，并将纹理单元号赋给它</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li>建立 video 对象，并播放</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://img.yxyy.name/ripples.mp4&quot;</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>autoplay <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>muted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;crossOrigin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;playing&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="4"><li>在 video 对象播放时，向纹理对象连续写入 video</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> video<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="八、世界坐标和本地坐标" tabindex="-1"><a class="header-anchor" href="#八、世界坐标和本地坐标" aria-hidden="true">#</a> 八、世界坐标和本地坐标</h2><h3 id="_1-基本概念" tabindex="-1"><a class="header-anchor" href="#_1-基本概念" aria-hidden="true">#</a> 1-基本概念</h3><p>进入三维世界，必须要先有坐标系的概念，而不要只想着如何让物体飞天遁地。</p><p>坐标系按照层级分为：</p><ul><li>世界坐标系</li><li>本地坐标系</li></ul><p>当然，坐标系还可以按照类型来分，比如：直角坐标系、极坐标系等。</p><p>接下来说说世界坐标系和本地坐标系。</p><p>通过一个神的传说，引出世界坐标系和本地坐标系的概念。</p><p>天地混沌之时，宇宙只是一个蛋。</p><p>这个蛋之所在，就是世界坐标系的原点所在。</p><p>十万八千年后，盘古一斧将蛋劈开，这个蛋没了，宇宙也变得无穷无尽了，其中万物初生，世界坐标系里的坐标轴也应运而生，以此定位万物。</p><p>然则，宇宙之中，无论是日月星辰，还是花鸟鱼虫，它们皆可自成一界，在这一界中，它们都有着自己的坐标系。</p><p>比如：</p><p>北京在东经 116°20′、北纬 39°56′ 上，这个位置就是北京在地球的本地坐标系里的位置。</p><p>那北京在宇宙里的世界坐标位是什么呢？这需要知道宇宙的坐标原点在哪里。</p><p>至于宇宙的坐标原点在哪里，就不再做深度探讨了，不然能扯到释迦摩尼的缘起性空和爱因斯坦的相对论上去。</p><p>接下来拿变换举例子。</p><h3 id="_2-认识世界坐标系、本地坐标系中的点位关系" tabindex="-1"><a class="header-anchor" href="#_2-认识世界坐标系、本地坐标系中的点位关系" aria-hidden="true">#</a> 2-认识世界坐标系、本地坐标系中的点位关系</h3><p>已知：</p><ul><li>世界坐标系[O1;i1,j1,k1]</li><li>点 P</li><li>点 P 所处的本地坐标系是[O2;i2,j2,k2]</li><li>世界坐标系[O1;i1,j1,k1]∋ 本地坐标系[O2;i2,j2,k2]</li></ul><p>解释一下：</p><p>[O;i,j,k]中：</p><ul><li>O 是坐标原点</li><li>i,j,k 是坐标向量</li></ul><p>这是空间直角坐标系的书写方式，可在高中数学的空间几何部分找到。</p><p>初学 three.js ，往往很难玩转其中矩阵变换、欧拉、四元数、世界坐标位、本地坐标位等。</p><p>接下我们继续围绕点 P 来说事。</p><p>提问 1：</p><p>我说点 P 的坐标位是(x,y,z)，可否找到点 P？</p><p>答：不可。</p><p>因为没说(x,y,z) 是在世界坐标系[O1;i1,j1,k1]里的位置，还是在本地坐标系是[O2;i2,j2,k2]里的位置。</p><p>提问 2：</p><p>点 P 的世界坐标位是(x,y,z)，可否找到点 P？</p><p>答：可</p><p>提问 3：</p><p>点 P 的本地坐标位是(x,y,z)，可否找到点 P？若可以，求点 P 的世界位。</p><p>答：可</p><p>解点 P 的世界位：</p><p>根据空间向量分解定理。</p><p>由世界坐标系[O1;i1,j1,k1]可解析出四维矩阵 m1：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	i1.x,j1.x,k1.x,0,
	i1.y,j1.y,k1.y,0,
	i1.z,j1.z,k1.z,0,
	O1.x,O1.y,O1.z,1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>同理，由本地坐标系[O2;i2,j2,k2]可解析出四维矩阵 m2：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	i2.x,j2.x,k2.x,0,
	i2.y,j2.y,k2.y,0,
	i2.z,j2.z,k2.z,0,
	O2.x,O2.y,O2.z,1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>点 P 的世界位是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="九、深入认知三维世界" tabindex="-1"><a class="header-anchor" href="#九、深入认知三维世界" aria-hidden="true">#</a> 九、深入认知三维世界</h2><h3 id="_1-用位移矩阵做实验" tabindex="-1"><a class="header-anchor" href="#_1-用位移矩阵做实验" aria-hidden="true">#</a> 1-用位移矩阵做实验</h3><h4 id="_1-1-示例" tabindex="-1"><a class="header-anchor" href="#_1-1-示例" aria-hidden="true">#</a> 1-1-示例</h4><p>已知：</p><ul><li>宇宙 universe</li><li>宇宙的本地坐标系是[O1;i1,j1,k1] <ul><li>O1(0,0,0)</li><li>i1(1,0,0)</li><li>j1(0,1,0)</li><li>k1(0,0,1)</li></ul></li><li>宇宙包含万物，其本地坐标系就是万物的世界坐标系</li><li>银河系 galaxy</li><li>银河系的本地坐标系是[O2;i2,j2,k2] <ul><li>O2(1,2,3)</li><li>i2(1,0,0)</li><li>j2(0,1,0)</li><li>k2(0,0,1)</li></ul></li><li>太阳 sun</li><li>太阳在银河系内的本地坐标位是 P2(4,5,6)</li><li>太阳 ∈ 银河系 ∈ 宇宙</li></ul><p>求：太阳的世界位 P1</p><p>解：</p><p>由宇宙坐标系[O1;i1,j1,k1]解矩阵 m1：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1,0,0,0,
	0,1,0,0,
	0,0,1,0,
	0,0,0,1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由银河系[O2;i2,j2,k2]解矩阵 m2:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1,0,0,0,
	0,1,0,0,
	0,0,1,0,
	1,2,3,1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>点 P 的世界坐标位是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span> <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来我们拿 three.js 验证一下</p><h4 id="_1-2-验证" tabindex="-1"><a class="header-anchor" href="#_1-2-验证" aria-hidden="true">#</a> 1-2-验证</h4><p>1.从 three.js 中引入我们要用到的方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Group<span class="token punctuation">,</span>
  Matrix4<span class="token punctuation">,</span>
  Object3D<span class="token punctuation">,</span>
  Scene<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>2.基于世界坐标系和本地坐标系构建矩阵</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">//世界坐标系-宇宙</span>
const m1 = new Matrix4()
m1.elements = <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-银河系</span>
const m2 = new Matrix4()
m2.elements = <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>3.声明太阳在银河系内本地坐标 P2</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//本地坐标位-太阳</span>
<span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4.创造一个宇宙</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>applyMatrix4() 通过四维矩阵赋予对象坐标系</p><p>5.同理，创造银河系</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//银河系</span>
<span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>6.创造太阳</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sun<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>太阳的 position 属性便是其在银河系中的相对位</p><p>7.宇宙、银河系和太阳的包含关系：太阳 ∈ 银河系 ∈ 宇宙</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sun<span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>8.计算太阳的在宇宙中的世界位</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sun<span class="token punctuation">.</span><span class="token function">getWorldPosition</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//{x:5,y:7,z:9}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-位移法则" tabindex="-1"><a class="header-anchor" href="#_2-位移法则" aria-hidden="true">#</a> 2-位移法则</h3><p>如果不想求太阳的位置，而是想求太阳系内的地球的位置，那是否还可以按照之前的思路来求解？答案是肯定的。</p><h4 id="_2-1-示例" tabindex="-1"><a class="header-anchor" href="#_2-1-示例" aria-hidden="true">#</a> 2-1-示例</h4><p>调整一下之前的已知条件。</p><ul><li><p>把太阳改成太阳系 solar</p></li><li><p>太阳系的本地坐标系是[O3;i3,j3,k3]</p><ul><li>O3(4,5,6)</li><li>i3(1,0,0)</li><li>j3(0,1,0)</li><li>k3(0,0,1)</li></ul></li><li><p>地球 earth</p></li><li><p>地球在太阳系内的本地坐标位是 P3(7,8,9)</p></li><li><p>地球 ∈ 太阳系 ∈ 银河系 ∈ 宇宙</p></li></ul><p>求：地球的世界坐标位 P1</p><p>解：</p><p>由太阳系的本地坐标系可得矩阵 m3：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1, 0, 0, 0,
    0, 1, 0, 0,
    0, 0, 1, 0,
    4, 5, 6, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>求地球的世界坐标位 P1：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span> <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-2-验证" tabindex="-1"><a class="header-anchor" href="#_2-2-验证" aria-hidden="true">#</a> 2-2-验证</h4><p>按照之前的原理用 three.js 验证一番：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>import <span class="token punctuation">{</span> Group<span class="token punctuation">,</span> Matrix4<span class="token punctuation">,</span> Object3D<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> Vector3<span class="token punctuation">,</span> <span class="token punctuation">}</span> from &#39;https<span class="token operator">:</span><span class="token comment">//unpkg.com/three/build/three.module.js&#39;;</span>

<span class="token comment">//世界坐标系-宇宙</span>
const m1 = new Matrix4()
m1.elements = <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-银河系</span>
const m2 = new Matrix4()
m2.elements = <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-太阳系</span>
const m3 = new Matrix4()
m3.elements = <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标位-地球</span>
const P3 = new Vector3(<span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span>)


<span class="token comment">//宇宙(世界坐标系是宇宙的本地坐标系)</span>
const universe = new Scene()
universe.applyMatrix4(m1)
console.log(universe.position)
console.log(universe.matrix)

<span class="token comment">//银河系</span>
const galaxy = new Group()
galaxy.applyMatrix4(m2)

<span class="token comment">//太阳系</span>
const solar = new Group()
solar.applyMatrix4(m3)

<span class="token comment">//地球</span>
const earth = new Object3D()
earth.position.copy(P3)

<span class="token comment">//包含关系</span>
solar.add(earth)
galaxy.add(solar)
universe.add(galaxy)

<span class="token comment">//点P的世界位</span>
const P1 = new Vector3()
earth.getWorldPosition(P1)
console.log(P1);
<span class="token comment">//{x: 12, y: 15, z: 18}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h4 id="_2-3-推理" tabindex="-1"><a class="header-anchor" href="#_2-3-推理" aria-hidden="true">#</a> 2-3-推理</h4><p>可以从上面的结论中得到一个规律：</p><p>当一点 P 和宇宙之间存在 n 层嵌套</p><p>点 P 的本地坐标位是 Pn</p><p>第 n 层世界的本地坐标系所对应的矩阵是 mn</p><p>则点 P 的世界位 P1 是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span><span class="token operator">=</span>m1<span class="token operator">*</span>m2<span class="token operator">*</span>……<span class="token operator">*</span>mn<span class="token operator">*</span>pn
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>上面的公式，就暂且叫它“<strong>本地坐标转世界坐标公式</strong>”。</p><h3 id="_3-缩放法则" tabindex="-1"><a class="header-anchor" href="#_3-缩放法则" aria-hidden="true">#</a> 3-缩放法则</h3><h4 id="_3-1-示例" tabindex="-1"><a class="header-anchor" href="#_3-1-示例" aria-hidden="true">#</a> 3-1-示例</h4><p>修改之前已知条件：</p><ul><li><p>在银河系的本地坐标系[O2;i2,j2,k2]中，让 j2 是单位向量的 2 倍：</p><ul><li>O2(1,2,3)</li><li>i2(1,0,0)</li><li>j2(0,2,0)</li><li>k2(0,0,1)</li></ul></li><li><p>在太阳系的本地坐标系[O3;i3,j3,k3]，让 k3 是单位向量的 3 倍：</p><ul><li>O3(4,5,6)</li><li>i3(1,0,0)</li><li>j3(0,1,0)</li><li>k3(0,0,3)</li></ul></li></ul><p>求：地球的世界坐标位 P1</p><p>解：</p><p>由银河系的本地坐标系可得矩阵 m2：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1, 0, 0, 0,
   0, 2, 0, 0,
   0, 0, 1, 0,
   1, 2, 3, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由太阳系的本地坐标系可得矩阵 m3：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1, 0, 0, 0,
   0, 1, 0, 0,
   0, 0, 3, 0,
   4, 5, 6, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>求地球的世界坐标位 P1：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span><span class="token operator">=</span>m1<span class="token operator">*</span>m2<span class="token operator">*</span>m3<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
m1<span class="token operator">*</span>m2<span class="token operator">*</span>m3<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span>
    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">0</span>
    <span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">5</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token punctuation">]</span>
m1<span class="token operator">*</span>m2<span class="token operator">*</span>m3<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token punctuation">]</span>
<span class="token constant">P1</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token constant">P1</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_3-2-测试" tabindex="-1"><a class="header-anchor" href="#_3-2-测试" aria-hidden="true">#</a> 3-2-测试</h4><p>基于“位移法则”的 three.js 代码改改：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code> import <span class="token punctuation">{</span> Group<span class="token punctuation">,</span> Matrix4<span class="token punctuation">,</span> Object3D<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> Vector3<span class="token punctuation">,</span> <span class="token punctuation">}</span> from &#39;https<span class="token operator">:</span><span class="token comment">//unpkg.com/three/build/three.module.js&#39;;</span>

<span class="token comment">//世界坐标系-宇宙</span>
const m1 = new Matrix4()
m1.elements = <span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-银河系</span>
const m2 = new Matrix4()
m2.elements = <span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-太阳系</span>
const m3 = new Matrix4()
m3.elements = <span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">//地球在太阳系内的本地坐标位</span>
const P3 = new Vector3(<span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span>)

<span class="token comment">//创造宇宙</span>
const universe = new Scene()
universe.applyMatrix4(m1)

<span class="token comment">//创造银河系</span>
const galaxy = new Group()
galaxy.applyMatrix4(m2)

<span class="token comment">//创造太阳系</span>
const solar = new Group()
solar.applyMatrix4(m3)

<span class="token comment">//创造地球</span>
const earth = new Object3D()
earth.position.copy(P3)

<span class="token comment">//太阳系包含地球</span>
solar.add(earth)

<span class="token comment">//银河系包含太阳</span>
galaxy.add(solar)

<span class="token comment">//宇宙包含银河系</span>
universe.add(galaxy)

<span class="token comment">//求太阳在宇宙中的世界位</span>
const P1 = new Vector3()
earth.getWorldPosition(P1)
console.log(P1);  <span class="token comment">// {x: 12, y: 28, z: 36}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="_4-旋转法则" tabindex="-1"><a class="header-anchor" href="#_4-旋转法则" aria-hidden="true">#</a> 4-旋转法则</h3><h4 id="_4-1-示例" tabindex="-1"><a class="header-anchor" href="#_4-1-示例" aria-hidden="true">#</a> 4-1-示例</h4><p>修改之前已知条件：</p><ul><li><p>让银河系的本地坐标系[O2;i2,j2,k2]绕 j2 轴逆时针旋转 20°。</p><p>设：c2=cos(-20°)，s2=sin(-20°)</p><p>则：</p><ul><li>O2(1,2,3)</li><li>i2(c2,0,-s2)</li><li>j2(0,1,0)</li><li>k2(s2,0,c2)</li></ul></li><li><p>让太阳系的本地坐标系[O3;i3,j3,k3]绕 k3 轴逆时针旋转 30°</p><p>设：c3=cos(30°)，s3=sin(30°)</p><p>则：</p><ul><li>O3(4,5,6)</li><li>i3(c3,-s3,0)</li><li>j3(s3,c3,0)</li><li>k3(0,0,1)</li></ul></li></ul><p>求：地球的世界坐标位 P1</p><p>解：</p><p>由银河系的本地坐标系可得矩阵 m2：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	c2, 0, s2, 0,
    0,  1, 0,  0,
    -s2,0, c2, 0,
    1,  2, 3,  1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由太阳系的本地坐标系可得矩阵 m3：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	c3,  s3, 0, 0,
    -s3, c3, 0, 0,
    0,   0,  1, 0,
    4,   5,  6, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>求地球的世界坐标位 P1：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>P1=m1*m2*m3*(7,8,9)
m1*m2*m3=[
    c2*c3,      s3,   s2*c3,      0,
    -c2*s3,     c3,   -s2*s3,     0,
    -s2,        0,    c2,         0,
    c2*4-s2*6+1,5+2,s2*4+c2*6+3,1
]
P1=(11.826885919330648,17.428203230275507,15.02200238270646)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>注，上式很难像之前那样心算，可以直接用计算机算：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">//让银河系的本地坐标系[O2;i2,j2,k2]绕j2轴逆时针旋转20°</span>
const ang2 = <span class="token number">-20</span> * Math.PI / <span class="token number">180</span>
const c2 = Math.cos(ang2)
const s2 = Math.sin(ang2)

<span class="token comment">//让太阳系的本地坐标系[O3;i3,j3,k3]绕k3轴逆时针旋转30°</span>
const ang3 = <span class="token number">30</span> * Math.PI / <span class="token number">180</span>
const c3 = Math.cos(ang3)
const s3 = Math.sin(ang3)


const m=new Matrix4()
m.elements = <span class="token punctuation">[</span>
    c2 * c3<span class="token punctuation">,</span> s3<span class="token punctuation">,</span> s2 * c3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    -c2 * s3<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> -s2 * s3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    -s2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    c2 * <span class="token number">4</span> - s2 * <span class="token number">6</span> + <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span> + <span class="token number">2</span><span class="token punctuation">,</span> s2 * <span class="token number">4</span> + c2 * <span class="token number">6</span> + <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
const P1 = P3.applyMatrix4(m)
console.log(P1);  <span class="token comment">// {x: 11.826885919330648, y: 17.428203230275507, z: 15.02200238270646}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_4-2-验证" tabindex="-1"><a class="header-anchor" href="#_4-2-验证" aria-hidden="true">#</a> 4-2-验证</h4><p>基于“位移法则”的 three.js 代码改改：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Group<span class="token punctuation">,</span>
  Matrix4<span class="token punctuation">,</span>
  Object3D<span class="token punctuation">,</span>
  Scene<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//世界坐标系-宇宙</span>
<span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m1<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//本地坐标系-银河系</span>
<span class="token keyword">const</span> ang2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m2<span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>ang2<span class="token punctuation">)</span><span class="token punctuation">;</span>
m2<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m2<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//本地坐标系-太阳系</span>
<span class="token keyword">const</span> ang3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m3<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>ang3<span class="token punctuation">)</span><span class="token punctuation">;</span>
m3<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//地球在太阳系内的本地坐标位</span>
<span class="token keyword">const</span> <span class="token constant">P3</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造宇宙</span>
<span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造银河系</span>
<span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造太阳系</span>
<span class="token keyword">const</span> solar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
solar<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造地球</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
earth<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//太阳系包含地球</span>
solar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>earth<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//银河系包含太阳</span>
galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>solar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//宇宙包含银河系</span>
universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//求太阳在宇宙中的世界位</span>
<span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
earth<span class="token punctuation">.</span><span class="token function">getWorldPosition</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {x: 11.826885919330648, y: 17.428203230275507, z: 15.02200238270646}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="十、旋转法则之深度探索" tabindex="-1"><a class="header-anchor" href="#十、旋转法则之深度探索" aria-hidden="true">#</a> 十、旋转法则之深度探索</h2><p>首先要知道，物体旋转的复杂程度是位移和缩放的 n 多倍。</p><p>以前在旋转物体时，只是让其绕坐标轴 x|y|z 旋转。</p><p>然而，在实际项目开发中，会有其它的旋转需求。</p><p>比如：</p><ul><li><p>欧拉 Euler：让物体基于世界坐标系绕 x 轴旋转 a°，然后绕本地坐标系 y 轴旋转 b°，最后绕本地坐标系 z 轴旋转 c°。</p></li><li><p>四元数 Quaternion：让物体绕任意一轴旋转 a°。</p></li></ul><p>在说复杂旋转之前，需要对旋转的方向有一个透彻的认知，所以先说一下单轴逆时针旋转。</p><h3 id="_1-顶点绕单轴逆时针旋转" tabindex="-1"><a class="header-anchor" href="#_1-顶点绕单轴逆时针旋转" aria-hidden="true">#</a> 1-顶点绕单轴逆时针旋转</h3><p>在右手坐标系的逆时针旋转里，绕 y 轴的逆时针旋转有点特别。</p><p>绕 y 轴旋转时，x 轴正半轴是起始轴，即 x 轴正半轴的弧度为 0。</p><p>一顶点绕 y 轴逆时针旋转时，旋转量越大，弧度值越小。</p><p>而绕其它两个轴旋转时，则与其相反：</p><p>一顶点绕 x 轴或 z 轴逆时针旋转时，旋转量越大，弧度值越大。</p><p>这就是为什么我让银河系的本地坐标系[O2;i2,j2,k2]绕 j2 轴逆时针旋转 20° 时，是通过-20° 取的 sin 值和 cos 值。</p><p>这个推理，可以通过 three.js 的 Matrix4 对象的 makeRotationX()、makeRotationY()、makeRotationZ() 来核对一下。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">//30°</span>
const ang = <span class="token number">30</span> * Math.PI / <span class="token number">180</span>
<span class="token comment">//three.js四维矩阵对象</span>
const m = new Matrix4()

<span class="token comment">//绕x轴逆时针旋转30°</span>
<span class="token punctuation">{</span>
    <span class="token comment">//three.js 旋转</span>
    m.makeRotationX(ang)
    console.log(...m.elements);

    <span class="token comment">//手动旋转</span>
    const c = Math.cos(ang)
    const s = Math.sin(ang)
    console.log(
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> -s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    );
<span class="token punctuation">}</span>

<span class="token comment">//绕y轴逆时针旋转30°</span>
<span class="token punctuation">{</span>
    <span class="token comment">//three.js 旋转</span>
    m.makeRotationY(ang)
    console.log(...m.elements);

    <span class="token comment">//手动旋转</span>
    const c = Math.cos(-ang)
    const s = Math.sin(-ang)
    console.log(
        c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        -s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    );
<span class="token punctuation">}</span>

<span class="token comment">//绕z轴逆时针旋转30°</span>
<span class="token punctuation">{</span>
    <span class="token comment">//three.js 旋转</span>
    m.makeRotationZ(ang)
    console.log(...m.elements);

    <span class="token comment">//手动旋转</span>
    const c = Math.cos(ang)
    const s = Math.sin(ang)
    console.log(
        c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        -s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    );
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h3 id="_2-欧拉旋转" tabindex="-1"><a class="header-anchor" href="#_2-欧拉旋转" aria-hidden="true">#</a> 2-欧拉旋转</h3><p>欧拉旋转就是绕单轴多次逆时针旋转，第一次是绕世界坐标系的单轴逆时针旋转，之后则是绕本地坐标系的单轴逆时针旋转。</p><h4 id="_2-1-示例-1" tabindex="-1"><a class="header-anchor" href="#_2-1-示例-1" aria-hidden="true">#</a> 2-1-示例</h4><p>已知：</p><p>世界坐标系 m1</p><p>点 P 在世界坐标系内</p><p>点 P 的世界坐标位 P1(x,y,z)</p><p>求：</p><p>点 P 绕世界坐标系的 x 轴逆时针旋转 angX 度，</p><p>绕本地坐标系的 y 轴逆时针旋转 angY 度，</p><p>绕本地坐标系的 z 轴逆时针旋转 angZ 度后的世界位 P2。</p><p>解：</p><p>分别基于 angX,angY,angZ 建立三个矩阵 mx,my,mz</p><p>点 P 的世界位是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P2</span> <span class="token operator">=</span> mx <span class="token operator">*</span> my <span class="token operator">*</span> mz <span class="token operator">*</span> <span class="token constant">P1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h4 id="_2-3-验证" tabindex="-1"><a class="header-anchor" href="#_2-3-验证" aria-hidden="true">#</a> 2-3-验证</h4><p>我可以在 three.js 里验证一下。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Group<span class="token punctuation">,</span>
  Matrix4<span class="token punctuation">,</span>
  Object3D<span class="token punctuation">,</span>
  Scene<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  Euler<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>angX<span class="token punctuation">,</span> angY<span class="token punctuation">,</span> angZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//用矩阵乘法实现顶点绕单轴多次逆时针旋转</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span>angX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>angY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>angZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//P2=mx*my*mz*P1</span>
  <span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//用欧拉实现顶点绕单轴多次逆时针旋转</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> euler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Euler</span><span class="token punctuation">(</span>angX<span class="token punctuation">,</span> angY<span class="token punctuation">,</span> angZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m<span class="token punctuation">.</span><span class="token function">makeRotationFromEuler</span><span class="token punctuation">(</span>euler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>上面 P2 的两个输出结果都是一样的。</p><h4 id="_2-4-讲个故事理解欧拉" tabindex="-1"><a class="header-anchor" href="#_2-4-讲个故事理解欧拉" aria-hidden="true">#</a> 2-4-讲个故事理解欧拉</h4><p>通过之前的代码，可以发现欧拉旋转和咱们之前说过的世界坐标系、本地坐标系的呼应规律。</p><p>可以即此编一个关于王者荣耀故事：</p><ul><li>宇宙，宇宙的本地坐标系是万物的世界坐标系，此坐标系为单位矩阵</li><li>mx：银河系的本地坐标系</li><li>my：太阳系的本地坐标系</li><li>mz：凡间界的本地坐标系</li><li>P1：瑶在欧拉旋转前的世界位 （瑶是王者荣耀里的角色）</li><li>宇宙 ∋ 银河系 ∋ 太阳系 ∋ 凡间界 ∋ 瑶</li></ul><p>求：瑶欧拉旋转(angX,angY,angZ) 后的世界位 P2，旋转顺序为 xyz</p><p>解：</p><ol><li><p>让瑶坠落凡间界。</p><p>当前宇宙万界的本地坐标系都是单位矩阵，所以瑶的世界坐标位 P1，也是瑶在万界中的本地坐标位。</p><p>下面的 P1 也就可以理解为瑶在凡间界的本地坐标位。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>const P1 = new Vector3(1, 1, 1)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>将银河系、太阳系、凡间界分别沿 x 轴、y 轴、z 轴旋转 angX、angY、angZ 度。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>const mx = new Matrix4().makeRotationX(angX)
const my = new Matrix4().makeRotationY(angY)
const mz = new Matrix4().makeRotationZ(angZ)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>让瑶跳出三界之外，求其世界位</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//P2=mx*my*mz*P1</span>
<span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol><h3 id="_3-四元数" tabindex="-1"><a class="header-anchor" href="#_3-四元数" aria-hidden="true">#</a> 3-四元数</h3><p>四元数 Quaternion：让物体绕任意轴旋转 a°。</p><p>我们对四元数的深度理解，也可以让我们脑海中的三维空间意识更加牢固。</p><p>我们通过一个例子来说明四元数旋转的实现过程。</p><p><img src="/visual/webgl/54.png" alt=""></p><p>已知：</p><ul><li>轴 OC2</li><li>弧度 ang</li><li>点 P1(x,y,z)</li></ul><div class="language-j ext-j line-numbers-mode"><pre class="language-j"><code>const OC2 <span class="token verb keyword">=</span> new Vector3<span class="token punctuation">(</span><span class="token number">3</span><span class="token verb keyword">,</span> <span class="token number">2</span><span class="token verb keyword">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token conjunction variable">.</span>normalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
const ang <span class="token verb keyword">=</span> <span class="token number">2</span>
const P1 <span class="token verb keyword">=</span> new Vector3<span class="token punctuation">(</span><span class="token number">1</span><span class="token verb keyword">,</span> <span class="token number">2</span><span class="token verb keyword">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>求：点 P1 绕 OC2 逆时针旋转 ang 度后的位置 P2</p><p>解：</p><p>我接下来要把 OC2 转得与 z 轴同向。</p><ol><li>计算绕 x 轴把 OC2 旋转到平面 Ozx 上的旋转矩阵 mx1。</li></ol><p>旋转的度数是 OC2 在平面 Oyz 上的正射影 OB2 与 z 轴的夹角，即 ∠B2OB1。</p><p><img src="/visual/webgl/55.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">B2OB1</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span><span class="token constant">OC2</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token constant">OC2</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mx1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span><span class="token constant">B2OB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>顺便再求出绕 x 轴反向旋转 ∠B2OB1 的矩阵 mx2，以备后用。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mx2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">B2OB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="3"><li>基于矩阵 mx1 旋转 OC2，旋转到 OC3 的位置。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//OC3 = m1*OC2</span>
<span class="token keyword">const</span> <span class="token constant">OC3</span> <span class="token operator">=</span> <span class="token constant">OC2</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">OC3</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="4"><li>计算绕 y 轴把 OC3 旋转到 z 轴上的旋转矩阵 my1。</li></ol><p>旋转的度数是 OC3 与 z 轴的夹角，即 ∠C3OB1。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>const C3OB1 = Math.atan2(OC3.x, OC3.z)
const my1 = new Matrix4().makeRotationY(-C3OB1)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​ 至于旋转后 OC3 在哪里，就不重要了，我们只要知道了其旋转了多少度，以及其最后会和 z 轴同向就够了。</p><ol start="5"><li>顺便再求出绕 y 轴反向旋转 ∠C3OB1 的矩阵 my2，以备后用。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> my2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span><span class="token constant">C3OB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="6"><li>在 OC2 转到 z 轴上的时候，也让点 P1 做等量的旋转，得 P2 点</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//P2 =my1*mx1*P1</span>
<span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>my1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="7"><li>计算绕 z 轴旋转 ang 度的矩阵 mz</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>const mz = new Matrix4().makeRotationZ(ang)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="8"><li>让点 P2 绕 z 轴旋转 ang 度</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="9"><li>让点 P2 按照之前 OC2 的旋转量再逆向转回去。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>my2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>也可以把所有的矩阵合一下，再乘以 P2</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> mx2
  <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my2<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my1<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mx1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="10"><li>验证</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> quaternion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
quaternion<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span><span class="token constant">OC2</span><span class="token punctuation">,</span> ang<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m<span class="token punctuation">.</span><span class="token function">makeRotationFromQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>总结一下四元数旋转的实现原理：</p><ol><li><p>将旋转轴带着顶点一起旋转，让旋转轴与 xyz 中的某一个轴同向，比如 z 轴。</p></li><li><p>让顶点绕 z 轴旋转相应的度数。</p></li><li><p>让顶点按照之前旋转轴的旋转量逆向转回去。</p></li></ol><h2 id="十一、正交投影矩阵" tabindex="-1"><a class="header-anchor" href="#十一、正交投影矩阵" aria-hidden="true">#</a> 十一、正交投影矩阵</h2><p>WebGL 是一个光栅引擎，其本身并不会实现三维效果，那要在其中实现三维效果的关键就在于算法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>顶点在裁剪空间中的位置 <span class="token operator">=</span> 投影矩阵 <span class="token operator">*</span> 视图矩阵 <span class="token operator">*</span> 模型矩阵 <span class="token operator">*</span> 顶点的初始点位<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>正交投影矩阵是投影矩阵的一种，先从它说起。</p><p>在说正交投影矩阵之前，还需要对裁剪空间有一个清晰的认知。</p><h3 id="_1-裁剪空间" tabindex="-1"><a class="header-anchor" href="#_1-裁剪空间" aria-hidden="true">#</a> 1-裁剪空间</h3><p>裁剪空间是用于显示 webgl 图形的空间，此空间是一个宽、高、深皆为 2 的盒子。其坐标系的原点在 canvas 画布的中心，如下图：</p><p><img src="/visual/webgl/56.png" alt=""></p><p>裁剪空间中：</p><ul><li>x 轴上-1 的位置对应 canvas 画布的左边界，1 的位置对应 canvas 画布的右边界</li><li>y 轴上-1 的位置对应 canvas 画布的下边界，1 的位置对应 canvas 画布的上边界</li><li>y 轴上-1 的位置朝向屏幕外部，1 的位置朝向屏幕内部，如下图：</li></ul><p><img src="/visual/webgl/57.png" alt=""></p><h3 id="_2-正交投影矩阵的实现原理" tabindex="-1"><a class="header-anchor" href="#_2-正交投影矩阵的实现原理" aria-hidden="true">#</a> 2-正交投影矩阵的实现原理</h3><p><img src="/visual/webgl/58.png" alt=""></p><p>正交投影矩阵 orthographic projection：将世界坐标系中的一块矩形区域(正交相机的可视区域)投射到裁剪空间中，不同深度的物体不具备近大远小的透视规则。</p><p><img src="/visual/webgl/59.png" alt=""></p><p>请问：要将一个任意尺寸的长方体塞进裁剪空间里，分几步？</p><p>答：先位移，再缩放</p><p><img src="/visual/webgl/60.png" alt=""></p><p>设：正交相机可视区域的上、下、左、右、前、后的边界分别是 t、b、l、r、n、f</p><p>1.位移矩阵</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1,0,0,-(r+l)/2,
	0,1,0,-(t+b)/2,
	0,0,1,-(f+n)/2,
	0,0,0,1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.缩放矩阵</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	2/(r-l), 0,       0,        0,
	0,       2/(t-b), 0,        0,
	0,       0,       2/(f-n), 0,
	0,       0,       0,        1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>正交投影矩阵=缩放矩阵*位移矩阵</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	2/(r-l), 0,       0,        -(r+l)/(r-l),
	0,       2/(t-b), 0,        -(t+b)/(t-b),
	0,       0,       2/(f-n),  -(f+n)/(f-n),
	0,       0,       0,        1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>若 n、f 是一个距离量，而不是在 z 轴上的刻度值，正交投影矩阵在 z 轴上的缩放因子需要取反：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	2/(r-l), 0,       0,         -(r+l)/(r-l),
	0,       2/(t-b), 0,         -(t+b)/(t-b),
	0,       0,       -2/(f-n),  -(f+n)/(f-n),
	0,       0,       0,         1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-正交投影矩阵的代码实现" tabindex="-1"><a class="header-anchor" href="#_3-正交投影矩阵的代码实现" aria-hidden="true">#</a> 3-正交投影矩阵的代码实现</h3><p>正交投影矩阵的代码实现很简单，我们可以直接从 three.js 的 Matrix4 对象的 makeOrthographic() 方法中找到：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">makeOrthographic</span><span class="token punctuation">(</span> <span class="token parameter">left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> te <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>elements<span class="token punctuation">;</span>
    <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span> right <span class="token operator">-</span> left <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> h <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span> top <span class="token operator">-</span> bottom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span> far <span class="token operator">-</span> near <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token punctuation">(</span> right <span class="token operator">+</span> left <span class="token punctuation">)</span> <span class="token operator">*</span> w<span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token punctuation">(</span> top <span class="token operator">+</span> bottom <span class="token punctuation">)</span> <span class="token operator">*</span> h<span class="token punctuation">;</span>
    <span class="token keyword">const</span> z <span class="token operator">=</span> <span class="token punctuation">(</span> far <span class="token operator">+</span> near <span class="token punctuation">)</span> <span class="token operator">*</span> p<span class="token punctuation">;</span>

    te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> w<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> x<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> h<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> y<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> z<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>以前在绘制 webgl 图形的时候，它们会随 canvas 画布的大小发生拉伸，对于这个问题，我们便可以用投影矩阵来解决。</p><h3 id="_4-使用正交投影矩阵解决-webgl-图形拉伸问题" tabindex="-1"><a class="header-anchor" href="#_4-使用正交投影矩阵解决-webgl-图形拉伸问题" aria-hidden="true">#</a> 4-使用正交投影矩阵解决 webgl 图形拉伸问题</h3><p>先准备一个三角形。</p><p>1.顶点着色器</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_ProjectionMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_ProjectionMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p>u_ProjectionMatrix 正交投影矩阵</p><p>2.片元着色器。</p></li></ul><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span>u_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>3.绘制 1 个三角形</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    Vector3<span class="token punctuation">,</span>
    Quaternion<span class="token punctuation">,</span>
    Object3D<span class="token punctuation">,</span>
    OrthographicCamera<span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&quot;./jsm/Poly.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> projectionMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> triangle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ProjectionMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> projectionMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>默认情况下，webgl 图形会被 canvas 画布所拉伸。</p><p>可以通过对相机上下左右边界的设置，使其不被 canvas 画布所拉伸。</p><p>4.定义相机世界高度尺寸的一半</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>5.计算画布的宽高比</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>6.基于 halfH 和画布宽高比计算相机世界宽度尺寸的一半</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>7.定义相机世界的 6 个边界</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">-</span>halfW<span class="token punctuation">,</span>
  halfW<span class="token punctuation">,</span>
  halfH<span class="token punctuation">,</span>
  <span class="token operator">-</span>halfH<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>8.获取正交投影矩阵</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>projectionMatrix<span class="token punctuation">.</span><span class="token function">makeOrthographic</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>利用投影矩阵将现实世界投射到裁剪空间中后，往往还会对裁剪空间中视图进行位移或旋转，这时候就需要视图矩阵了。</p><h2 id="十二、视图矩阵" tabindex="-1"><a class="header-anchor" href="#十二、视图矩阵" aria-hidden="true">#</a> 十二、视图矩阵</h2><p>之前在说视图变换的时候说过视图矩阵，这里就通过 three.js 里的正交相机对象，更加形象的认识一下视图矩阵。</p><h3 id="_1-视图位移" tabindex="-1"><a class="header-anchor" href="#_1-视图位移" aria-hidden="true">#</a> 1-视图位移</h3><p>1.基于之前的代码，再绘制一个三角形</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const triangle1 = crtTriangle(
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">-0.2</span><span class="token punctuation">,</span>
        - <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">-0.3</span><span class="token punctuation">,</span> <span class="token number">-0.2</span><span class="token punctuation">,</span>
        <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">-0.3</span><span class="token punctuation">,</span> <span class="token number">-0.2</span>
    <span class="token punctuation">]</span>
)

const triangle2 = crtTriangle(
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
        <span class="token number">-0.3</span><span class="token punctuation">,</span> <span class="token number">-0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
        <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">-0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
)

render()

function render() <span class="token punctuation">{</span>
    gl.clear(gl.COLOR_BUFFER_BIT);

    triangle1.init()
    triangle1.draw()

    triangle2.init()
    triangle2.draw()
<span class="token punctuation">}</span>

function crtTriangle(color<span class="token punctuation">,</span> source) <span class="token punctuation">{</span>
    return new Poly(<span class="token punctuation">{</span>
        gl<span class="token punctuation">,</span>
        source<span class="token operator">:</span> new Float32Array(source)<span class="token punctuation">,</span>
        type<span class="token operator">:</span> &#39;TRIANGLES&#39;<span class="token punctuation">,</span>
        attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
            a_Position<span class="token operator">:</span> <span class="token punctuation">{</span>
                size<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                index<span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        uniforms<span class="token operator">:</span> <span class="token punctuation">{</span>
            u_Color<span class="token operator">:</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> &#39;uniform4fv&#39;<span class="token punctuation">,</span>
                value<span class="token operator">:</span> color
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            u_ProjectionMatrix<span class="token operator">:</span> <span class="token punctuation">{</span>
              type<span class="token operator">:</span> &#39;uniformMatrix4fv&#39;<span class="token punctuation">,</span>
              value<span class="token operator">:</span> projectionMatrix.elements
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>)
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>这是一前一后两个三角形。</p><p>前面的是黄色三角形，深度为 0.2；</p><p>后面的是红色三角形，深度为-0.2，被前面的三角形挡住了，所以看不见。</p><p>效果如下：</p><p><img src="/visual/webgl/61.png" alt=""></p><p>2.从 three.js 里引入正交相机对象 OrthographicCamera</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  OrthographicCamera<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>3.建立正交相机对象</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>const camera = new OrthographicCamera(left, right, top, bottom, near, far)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>4.设置相机位置 position</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>设置完相机位置后，要使用 updateWorldMatrix() 方法更新相机的世界坐标系。</p><p>updateWorldMatrix() 方法主要是考虑到了相机存在父级的情况。</p><p>updateWorldMatrix() 方法会把更新后的世界坐标系写进写进相机的 matrixWorld 属性里。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>console.log(camera.matrixWorld.elements);
<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>5.将相机的投影矩阵和相机的世界坐标系的逆矩阵合一下，合一个投影视图矩阵。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>a.multiplyMatrices(b,c) 相当于：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>a <span class="token operator">=</span> b <span class="token operator">*</span> c<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li><p>camera.projectionMatrix 可以直接获取相机的投影矩阵</p></li><li><p>matrixWorldInverse 是 matrixWorld 的逆矩阵，这是因为相机的移动方向和现实中的物体相反。</p></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>console.log(camera.matrixWorldInverse);
 <span class="token number">1</span>   <span class="token number">0</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>   <span class="token number">1</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">0</span>
<span class="token number">-1</span>  <span class="token number">-1</span> <span class="token number">-3</span>  <span class="token number">1</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>7.把之前的 projectionMatrix 改成 pvMatrix</p><ul><li>顶点着色器</li></ul><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>js 代码</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="扩展-matrixworld-详解" tabindex="-1"><a class="header-anchor" href="#扩展-matrixworld-详解" aria-hidden="true">#</a> 扩展-matrixWorld 详解</h3><p>例子已知：</p><ul><li><p>宇宙 universe</p><ul><li>本地坐标系是 m1</li><li>m1 也是宇宙万界的世界坐标系</li></ul></li><li><p>银河系 galaxy</p><ul><li>本地坐标系是 m2</li></ul></li><li><p>太阳系 solar</p><ul><li>本地坐标系是 m3</li></ul></li><li><p>太阳系 ∈ 银河系 ∈ 宇宙</p></li></ul><p>求：太阳系的世界坐标系 matrixWorld</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>matrixWorld <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>答案就这么简单，拿代码测一下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//宇宙(世界坐标系是宇宙的本地坐标系)</span>
<span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//银河系</span>
<span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//太阳系</span>
<span class="token keyword">const</span> solar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
solar<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//地球</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
earth<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//包含关系</span>
solar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>earth<span class="token punctuation">)</span><span class="token punctuation">;</span>
galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>solar<span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更新太阳系的世界坐标系</span>
solar<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//太阳系的世界坐标系</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>solar<span class="token punctuation">.</span>matrixWorld<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//手动计算太阳系的世界坐标系</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>m1<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="扩展-逆矩阵" tabindex="-1"><a class="header-anchor" href="#扩展-逆矩阵" aria-hidden="true">#</a> 扩展-逆矩阵</h3><p>之前在说 matrixWorldInverse 的时候说过，它是 matrixWorld 的逆矩阵。</p><p>逆矩阵在图形项目的应用很广，所以接下来就系统说一下逆矩阵的概念。</p><h4 id="_1-逆矩阵的概念" tabindex="-1"><a class="header-anchor" href="#_1-逆矩阵的概念" aria-hidden="true">#</a> 1.逆矩阵的概念</h4><p>逆矩阵就好比学习除法的时候，一个实数的倒数。</p><p>如：</p><p>2 的倒数是 1/2。</p><p>那么，矩阵 m 的倒数就是 1/m。</p><p>只不过，1/m 不叫做矩阵 m 的倒数，而是叫做矩阵 m 的逆矩阵。</p><p>由上，可以推导出的一些特性。</p><p>已知：</p><ul><li>矩阵 m</li><li>矩阵 n</li></ul><p>可得：</p><p>1.矩阵与其逆矩阵的相乘结果为单位矩阵</p><p>因为：</p><p>2*1/2=1</p><p>所以：</p><p>m*1/m=单位矩阵</p><p>2.矩阵 m 除以矩阵 n 就等于矩阵 m 乘以矩阵 n 的逆矩阵</p><p>因为：</p><p>3/2=3*1/2</p><p>所以：</p><p>m/n=m*1/n</p><h4 id="_2-矩阵转逆矩阵" tabindex="-1"><a class="header-anchor" href="#_2-矩阵转逆矩阵" aria-hidden="true">#</a> 2.矩阵转逆矩阵</h4><ol><li>位移矩阵的逆矩阵是取位移因子的相反数</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const m=new Matrix4()
m.elements=<span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
console.log(m.invert().elements);
<span class="token comment">//打印结果</span>
<span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">-4</span><span class="token punctuation">,</span><span class="token number">-5</span><span class="token punctuation">,</span><span class="token number">-6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="2"><li>缩放矩阵的逆矩阵是取缩放因子的倒数</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  const m=new Matrix4()
  m.elements=<span class="token punctuation">[</span>
    <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  console.log(m.invert().elements);
<span class="token punctuation">}</span>
<span class="token comment">//打印结果</span>
<span class="token punctuation">[</span>
  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.125</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>3.旋转矩阵的逆矩阵是基于旋转弧度反向旋转</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  const ang=<span class="token number">30</span>*Math.PI/<span class="token number">180</span>
  const c=Math.cos(ang)
  const s=Math.sin(ang)
  const m=new Matrix4()
  m.elements=<span class="token punctuation">[</span>
    c<span class="token punctuation">,</span>s<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    -s<span class="token punctuation">,</span>c<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  console.log(m.invert().elements);
<span class="token punctuation">}</span>
<span class="token comment">//打印结果</span>
<span class="token punctuation">[</span>
  <span class="token number">0.866</span><span class="token punctuation">,</span> <span class="token number">-0.45</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token number">0.866</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>关于即旋转又缩放还位移的复合矩阵，也是按照类似的原理转逆矩阵的，只不过过程要更复杂一些。</p><p>three.js 的 Matrix4 对象的 invert() 方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// based on http://www.euclideanspace.com/maths/algebra/matrix/functions/inverse/fourD/index.htm</span>
  <span class="token keyword">const</span> te <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>

        n11 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n21 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n31 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n41 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        n12 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n22 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n32 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n42 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        n13 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n23 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n33 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n43 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        n14 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n24 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n34 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n44 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>

        t11 <span class="token operator">=</span> n23 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">-</span> n24 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">+</span> n24 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token operator">-</span> n22 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">-</span> n23 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token operator">+</span> n22 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44<span class="token punctuation">,</span>
        t12 <span class="token operator">=</span> n14 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">-</span> n13 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">-</span> n14 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token operator">+</span> n12 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">+</span> n13 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token operator">-</span> n12 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44<span class="token punctuation">,</span>
        t13 <span class="token operator">=</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n42 <span class="token operator">-</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n42 <span class="token operator">+</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n43 <span class="token operator">-</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n43 <span class="token operator">-</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n44 <span class="token operator">+</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n44<span class="token punctuation">,</span>
        t14 <span class="token operator">=</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n32 <span class="token operator">-</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n32 <span class="token operator">-</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n33 <span class="token operator">+</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n33 <span class="token operator">+</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n34 <span class="token operator">-</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n34<span class="token punctuation">;</span>

  <span class="token keyword">const</span> det <span class="token operator">=</span> n11 <span class="token operator">*</span> t11 <span class="token operator">+</span> n21 <span class="token operator">*</span> t12 <span class="token operator">+</span> n31 <span class="token operator">*</span> t13 <span class="token operator">+</span> n41 <span class="token operator">*</span> t14<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> det <span class="token operator">===</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> detInv <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> det<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t11 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n24 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">-</span> n23 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n24 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">+</span> n21 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">+</span> n23 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">-</span> n21 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n22 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n24 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">+</span> n24 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">-</span> n21 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">-</span> n22 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">+</span> n21 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n23 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">-</span> n22 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">-</span> n23 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">+</span> n21 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">+</span> n22 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">-</span> n21 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t12 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n13 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">+</span> n14 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">-</span> n11 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">-</span> n13 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">+</span> n11 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n14 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">-</span> n12 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">+</span> n11 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">+</span> n12 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">-</span> n11 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n12 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">-</span> n13 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">+</span> n13 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">-</span> n11 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">-</span> n12 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">+</span> n11 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t13 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n41 <span class="token operator">-</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n43 <span class="token operator">+</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n43 <span class="token operator">+</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n44 <span class="token operator">-</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n41 <span class="token operator">+</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n42 <span class="token operator">-</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n42 <span class="token operator">-</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n44 <span class="token operator">+</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n41 <span class="token operator">-</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n41 <span class="token operator">-</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n42 <span class="token operator">+</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n42 <span class="token operator">+</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n43 <span class="token operator">-</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n43 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t14 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n31 <span class="token operator">-</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n31 <span class="token operator">+</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n33 <span class="token operator">-</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n33 <span class="token operator">-</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n34 <span class="token operator">+</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n34 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n31 <span class="token operator">-</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n31 <span class="token operator">-</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n32 <span class="token operator">+</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n32 <span class="token operator">+</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n34 <span class="token operator">-</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n34 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n31 <span class="token operator">-</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n31 <span class="token operator">+</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n32 <span class="token operator">-</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n32 <span class="token operator">-</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n33 <span class="token operator">+</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n33 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="_2-视图旋转" tabindex="-1"><a class="header-anchor" href="#_2-视图旋转" aria-hidden="true">#</a> 2-视图旋转</h3><p>之前实现了视图的移动效果，然而有时候当遇到一个好玩的物体时，需要在不移动相机的前提下看向它。</p><p>这个时候，就需要旋转视图了。</p><h4 id="_2-1-用-lookat-实现视图旋转" tabindex="-1"><a class="header-anchor" href="#_2-1-用-lookat-实现视图旋转" aria-hidden="true">#</a> 2-1-用 lookAt()实现视图旋转</h4><p>接下来， 用 three.js 的 lookAt()方法实现视图旋转。</p><p>已知：</p><ul><li>正交相机的边界 left, right, top, bottom, near, far</li><li>正交相机的视点位置 eye</li><li>正交相机的目标点 target</li><li>正交相机从 eye 看向 target 时的上方向 up</li></ul><p>求：从视点看向目标点时的投影视图矩阵 pvMatrix</p><p>解：</p><p>1.声明已知条件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
<span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">-</span>halfW<span class="token punctuation">,</span>
  halfW<span class="token punctuation">,</span>
  halfH<span class="token punctuation">,</span>
  <span class="token operator">-</span>halfH<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>2.建立正交相机</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>3.设置相机的位置</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>4.使用 lookAt()方法，让相机看向目标点，并更新一下相机的世界坐标系。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面的 lookAt() 方法实际上就是在让相机世界进行旋转。</p><p>之后，现实世界在裁剪空间中显示的时候，便会基于此旋转量逆向旋转。</p><p>5.通过相机计算投影视图矩阵 pvMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl/62.png" alt=""></p><p>接下来，对 lookAt 功能进行一下深度剖析。</p><h4 id="_2-2-深度剖析-lookat-功能" tabindex="-1"><a class="header-anchor" href="#_2-2-深度剖析-lookat-功能" aria-hidden="true">#</a> 2-2-深度剖析 lookAt 功能</h4><p>先不考虑相机存在父级情况。</p><p>可以从之前的正交相机里分解出以下矩阵：</p><ul><li>视图矩阵 viewMatrix：相机位移矩阵乘以旋转矩阵后的逆矩阵，即相机的世界矩阵的逆矩阵 <ul><li>位移矩阵 positionMatrix：由视点位置得出</li><li>旋转矩阵 rotationMatrix：由视点、目标点、上方向得出</li></ul></li><li>投影矩阵 projectionMatrix：由正交相机的 6 个边界得出</li><li>投影视图矩阵：投影矩阵乘以视图矩阵</li></ul><p>接下来就基于之前的代码做一下分解：</p><p>1.由视点位置得出位移矩阵 positionMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> positionMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>2.由视点、目标点、上方向得出旋转矩阵 rotationMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rotationMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>3.基于位移矩阵和旋转矩阵计算视图矩阵 viewMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>positionMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>4.由正交相机对象提取投影矩阵 projectionMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> projectionMatrix <span class="token operator">=</span> camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>5.由投影矩阵和视图矩阵的相乘得到投影视图矩阵 pvMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>6.最后在顶点着色器里让 pvMatrix 乘以顶点点位即可</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>attribute vec4 a_Position<span class="token punctuation">;</span>
uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>注：若相机对象存在父级，就需要基于相机的世界坐标系做相应运算了。</p><h2 id="十三、透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#十三、透视投影矩阵" aria-hidden="true">#</a> 十三、透视投影矩阵</h2><p>透视投影矩阵可以将现实世界更真实的投射到裁剪空间中。</p><h3 id="_1-基础知识" tabindex="-1"><a class="header-anchor" href="#_1-基础知识" aria-hidden="true">#</a> 1-基础知识</h3><p>强调两个知识点。</p><h4 id="_1-1-齐次坐标系" tabindex="-1"><a class="header-anchor" href="#_1-1-齐次坐标系" aria-hidden="true">#</a> 1-1-齐次坐标系</h4><p>在齐次坐标系中以下等式是成立的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token operator">=</span><span class="token punctuation">(</span>kx<span class="token punctuation">,</span>ky<span class="token punctuation">,</span>kz<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token function">k≠0</span>
<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>z<span class="token operator">=</span><span class="token punctuation">(</span>zx<span class="token punctuation">,</span>zy<span class="token punctuation">,</span>z²<span class="token punctuation">,</span>z<span class="token punctuation">)</span> z≠<span class="token number">0</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>比如：</p><p>(1,0,0,1)和(2,0,0,2) 都代表同一个三维点位(1,0,0)</p><h4 id="_1-2-线性补间运算" tabindex="-1"><a class="header-anchor" href="#_1-2-线性补间运算" aria-hidden="true">#</a> 1-2-线性补间运算</h4><p>之前说过点斜式 y=kx+b，它就是线性补间运算的公式。</p><p>除了点斜式，两种数据间的线性映射关系还可以用其它方法来表示。</p><p><img src="/visual/webgl/63.png" alt=""></p><p>已知：</p><ul><li><p>N 类型的数据极值是[minN,maxN]</p></li><li><p>M 类型的数据极值是[minM,maxM]</p></li><li><p>x 属于 N</p></li><li><p>将 x 映射到 M 的中的值为 y</p></li></ul><p>则 x,y 的关系可以用两个等式表示：</p><ol><li>比例式：</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>x <span class="token operator">-</span> minN<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxN <span class="token operator">-</span> minN<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> minM<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxM <span class="token operator">-</span> minM<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="2"><li>点斜式</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>k <span class="token operator">=</span> <span class="token punctuation">(</span>maxM <span class="token operator">-</span> minM<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxN <span class="token operator">-</span> minN<span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> minM <span class="token operator">-</span> minN <span class="token operator">*</span> k<span class="token punctuation">;</span>
y <span class="token operator">=</span> kx <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过线性插值的特性，我们可以知道：</p><p>[minN,maxN]中的每个点都与[minM,maxM]中的唯一点相对应，由一个 x 便可以求出唯一一个 y。</p><p>基础知识咱们就先说到这，接下来认识一下透视投影矩阵。</p><h3 id="_2-认识透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#_2-认识透视投影矩阵" aria-hidden="true">#</a> 2-认识透视投影矩阵</h3><p>透视投影矩阵 perspective projection：将世界坐标系中的一块四棱台形的区域投射到裁剪空间中，不同深度的物体具备近大远小的透视规则。</p><p><img src="/visual/webgl/64.png" alt=""></p><p><img src="/visual/webgl/65.png" alt=""></p><p>透视相机的建立需要以下已知条件：</p><ul><li>fov：摄像机视锥体垂直视野角度</li><li>aspect：摄像机视锥体宽高比(近裁剪面)</li><li>near：摄像机近裁剪面到视点的距离</li><li>far：摄像机远裁剪面到视点的距离</li></ul><p><img src="/visual/webgl/66.png" alt=""></p><p>请问：要将一个任意尺寸的正四棱台塞进裁剪空间里，分几步？</p><p>答：从透视到正交。</p><p>1.收缩远裁剪面，将原来的正四棱台变成长方体。</p><p>2.像之前的正交投影矩阵一样，将长方体先位移，再缩放。</p><p>接下来就去计算一下透视投影矩阵。</p><h3 id="_3-计算透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#_3-计算透视投影矩阵" aria-hidden="true">#</a> 3-计算透视投影矩阵</h3><p>1.基于 fov、aspect、n(near)、f(far)计算近裁剪面边界。</p><p><img src="/visual/webgl/65.png" alt=""></p><p>上下左右四个边界：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>t=n*tan(fov/2)
b=-t
r=t*aspect
l=-r
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2.设：可视区域中一顶点为 P1(x1,y1,z1)</p><p>​ 求：求 P1 在近裁剪面上的投影 P2(x2,y2,z2)</p><p><img src="/visual/webgl/67.png" alt=""></p><p>由相似三角形性质得：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>x1/x2=y1/y2=z1/z2
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>因为：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>z2=-n
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>所以：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>x2=nx1/-z1
y2=ny1/-z1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>若把 P1 点的 x1,y1 替换成 x2,y2，就可以理解为把相机可视区域塞进了一个长方体里。</p><p><img src="/visual/webgl/68.png" alt=""></p><p>3.把长方体里的顶点塞进裁剪空间中。</p><p><img src="/visual/webgl/69.png" alt=""></p><p>设：P2 映射到裁剪空间中的点为 P3(x3,y3,z3) 点</p><p>则：P2 点和 P3 点满足以下关系式：</p><ul><li>x 方向</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>(x3-(-1))/(1-(-1))=(x2-l)/(r-l)
(x3+1)/2=(x2-l)/(r-l)
(x3+1)=2(x2-l)/(r-l)
x3=2(x2-l)/(r-l)-1
x3=2(x2-l)/(r-l)-(r-l)/(r-l)
x3=(2(x2-l)-(r-l))/(r-l)
x3=(2x2-(r+l))/(r-l)
x3=2x2/(r-l)-(r+l)/(r-l)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>因为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x2 <span class="token operator">=</span> nx1 <span class="token operator">/</span> <span class="token operator">-</span>z1<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>所以：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>x3=2(nx1/-z1)/(r-l)-(r+l)/(r-l)
x3=(2n/(r-l))x1/-z1-(r+l)/(r-l)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>y 方向</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>(y3-(-1))/(1-(-1))=(y2-b)/(t-b)
y3=(2n/(t-b))y1/-z1-(t+b)/(t-b)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>观察一下当前求出的 x3,y3：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>x3=(2n/(r-l))x1/-z1-(r+l)/(r-l)
y3=(2n/(t-b))y1/-z1-(t+b)/(t-b)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>只要让 x3,y3 乘以-z1，便可以得到一个齐次坐标 P4(x4,y4,z4,w4)：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>x4=(2n/(r-l))x1+((r+l)/(r-l))z1
y4=(2n/(t-b))y1+((t+b)/(t-b))z1
z4=?
w4=-z1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当前把顶点的 z 分量投射到裁剪空间中的方法，还不知道，所以 z4=?</p><p>我们可以先从已知条件中提取投影矩阵(行主序)的矩阵因子：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
  2n/(r-l)       0         (r+l)/(r-l)   0,
  0              2n/(t-b)  (t+b)/(t-b)   0,
  ?              ?          ?            ?,
  0              0          -1           0
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接下来，就剩下 z 轴相关的矩阵因子了。</p><p>因为整个投影矩阵始终是在做线性变换的，投影点的 z 值与投影矩阵的 z 轴向的 x,y 分量无关。</p><p>所以投影矩阵的 z 轴向的 x,y 分量可以写做 0，z 和 w 分量可以设为 k,b，如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
  2n/(r-l)       0         (r+l)/(r-l)   0,
  0              2n/(t-b)  (t+b)/(t-b)   0,
  0              0          k            b
  0              0          -1           0
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>之前说了，整个投影矩阵始终是在做线性变换，所以可以用 k,b 组合一个点斜式：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>z4=k*z1+b
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>当然，可以认为是点积的结果：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>z4=(0,0,k,b)·(x1,y1,z1,1)
z4=k*z1+b
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接下来，只要求出上面的 k,b,就可以得到透视投影矩阵。</p><p>可以用当前的已知条件，构建一个二元一次方程组，求出 k,b：</p><p><img src="/visual/webgl/66.png" alt=""></p><ul><li>当 z1=-n 时，z3=-1，z4=-1*-z1 ，即：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>z4 <span class="token operator">=</span> k <span class="token operator">*</span> z1 <span class="token operator">+</span> b <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">*</span> n <span class="token operator">=</span> k <span class="token operator">*</span> <span class="token operator">-</span>n <span class="token operator">+</span> b <span class="token operator">-</span> n <span class="token operator">=</span> <span class="token operator">-</span>kn <span class="token operator">+</span> b<span class="token punctuation">;</span>
b <span class="token operator">=</span> kn <span class="token operator">-</span> n<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>当 z1=-f 时，z3=1，z4=1*-z1，即：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>z4 <span class="token operator">=</span> k <span class="token operator">*</span> z1 <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token number">1</span> <span class="token operator">*</span> f <span class="token operator">=</span> k <span class="token operator">*</span> <span class="token operator">-</span>f <span class="token operator">+</span> b<span class="token punctuation">;</span>
f <span class="token operator">=</span> <span class="token operator">-</span>kf <span class="token operator">+</span> b<span class="token punctuation">;</span>
kf <span class="token operator">=</span> b <span class="token operator">-</span> f<span class="token punctuation">;</span>
k <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">/</span> f<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>用消元法求 b：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>b<span class="token operator">=</span>kn<span class="token operator">-</span>n
b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span><span class="token operator">/</span>f<span class="token punctuation">)</span>n<span class="token operator">-</span>n
b<span class="token operator">=</span><span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span>n<span class="token operator">/</span>f<span class="token operator">-</span>n
fb<span class="token operator">=</span><span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span>n<span class="token operator">-</span>fn
fb<span class="token operator">=</span>bn<span class="token operator">-</span>fn<span class="token operator">-</span>fn
fb<span class="token operator">-</span>bn<span class="token operator">=</span><span class="token operator">-</span>2fn
<span class="token function">b</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">-</span>2fn
b<span class="token operator">=</span><span class="token operator">-</span>2fn<span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>再求 k：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>k<span class="token operator">=</span><span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span><span class="token operator">/</span>f
k<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span>2fn<span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token operator">-</span>f<span class="token punctuation">)</span><span class="token operator">/</span>f
k<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
k<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2n</span><span class="token operator">-</span>f<span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
k<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
k<span class="token operator">=</span><span class="token operator">-</span><span class="token punctuation">(</span>f<span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>最终的透视投影矩阵如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
  2n/(r-l)       0         (r+l)/(r-l)   0,
  0              2n/(t-b)  (t+b)/(t-b)   0,
  0              0         -(f+n)/(f-n)  -2fn/(f-n),
  0              0         -1            0
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>透视投影的建立方法，可以在 three.js 的源码里找到。</p><h3 id="_4-three-js-里的透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#_4-three-js-里的透视投影矩阵" aria-hidden="true">#</a> 4-three.js 里的透视投影矩阵</h3><p>three.js 的 PerspectiveCamera 对象的 updateProjectionMatrix() 方法，便是透视相机建立透视投影矩阵的方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> near <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>near<span class="token punctuation">;</span>
	  <span class="token comment">//近裁剪面上边界</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> near <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span> MathUtils<span class="token punctuation">.</span><span class="token constant">DEG2RAD</span> <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fov <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom<span class="token punctuation">;</span>
    <span class="token comment">//近裁剪面高度</span>
    <span class="token keyword">let</span> height <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> top<span class="token punctuation">;</span>
    <span class="token comment">//近裁剪面宽度</span>
    <span class="token keyword">let</span> width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspect <span class="token operator">*</span> height<span class="token punctuation">;</span>
    <span class="token comment">//近裁剪面左边界</span>
    <span class="token keyword">let</span> left <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> width<span class="token punctuation">;</span>
    <span class="token comment">//默认为null</span>
    <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">;</span>

    <span class="token comment">//多视图</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>view <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>enabled <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fullWidth <span class="token operator">=</span> view<span class="token punctuation">.</span>fullWidth<span class="token punctuation">,</span>
              fullHeight <span class="token operator">=</span> view<span class="token punctuation">.</span>fullHeight<span class="token punctuation">;</span>
        left <span class="token operator">+=</span> view<span class="token punctuation">.</span>offsetX <span class="token operator">*</span> width <span class="token operator">/</span> fullWidth<span class="token punctuation">;</span>
        top <span class="token operator">-=</span> view<span class="token punctuation">.</span>offsetY <span class="token operator">*</span> height <span class="token operator">/</span> fullHeight<span class="token punctuation">;</span>
        width <span class="token operator">*=</span> view<span class="token punctuation">.</span>width <span class="token operator">/</span> fullWidth<span class="token punctuation">;</span>
        height <span class="token operator">*=</span> view<span class="token punctuation">.</span>height <span class="token operator">/</span> fullHeight<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token comment">//偏离值，默认0</span>
    <span class="token keyword">const</span> skew <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filmOffset<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> skew <span class="token operator">!==</span> <span class="token number">0</span> <span class="token punctuation">)</span> left <span class="token operator">+=</span> near <span class="token operator">*</span> skew <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFilmWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//基于近裁剪面边界、近裁剪面和远裁剪面到相机视点的距离设置投影矩阵</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span><span class="token function">makePerspective</span><span class="token punctuation">(</span> left<span class="token punctuation">,</span> left <span class="token operator">+</span> width<span class="token punctuation">,</span> top<span class="token punctuation">,</span> top <span class="token operator">-</span> height<span class="token punctuation">,</span> near<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>far <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//投影矩阵的逆矩阵</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>projectionMatrixInverse<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectionMatrix <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>makePerspective() 是 Matrix4 对象里的方法，会基于投影空间建立透视投影矩阵</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">makePerspective</span><span class="token punctuation">(</span> <span class="token parameter">left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> te <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>elements<span class="token punctuation">;</span>

    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> near <span class="token operator">/</span> <span class="token punctuation">(</span> right <span class="token operator">-</span> left <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> near <span class="token operator">/</span> <span class="token punctuation">(</span> top <span class="token operator">-</span> bottom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">(</span> right <span class="token operator">+</span> left <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> right <span class="token operator">-</span> left <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">(</span> top <span class="token operator">+</span> bottom <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> top <span class="token operator">-</span> bottom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> far <span class="token operator">+</span> near <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> far <span class="token operator">-</span> near <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> far <span class="token operator">*</span> near <span class="token operator">/</span> <span class="token punctuation">(</span> far <span class="token operator">-</span> near <span class="token punctuation">)</span><span class="token punctuation">;</span>

    te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_5-透视投影矩阵牛刀小试" tabindex="-1"><a class="header-anchor" href="#_5-透视投影矩阵牛刀小试" aria-hidden="true">#</a> 5-透视投影矩阵牛刀小试</h3><p>用透视投影矩阵展示几个可以近大远小的三角形。</p><p><img src="/visual/webgl/70.png" alt=""></p><p>1.着色器</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_ProjectionMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	gl_Position <span class="token operator">=</span> u_ProjectionMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	gl_FragColor<span class="token operator">=</span>u_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>2.初始化着色器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  PerspectiveCamera<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  Quaternion<span class="token punctuation">,</span>
  Object3D<span class="token punctuation">,</span>
  OrthographicCamera<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&quot;./jsm/Poly.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>3.建立透视相机</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4.基于相机的透视投影矩阵，绘制 4 个三角形。</p><p>前面是两个黄色三角形，后面是两个红色三角形。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> triangle3 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> triangle4 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> <span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ProjectionMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle1<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle2<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle3<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle3<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle4<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle4<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>实际项目中，只有投影矩阵是不够的，还要有视图矩阵和模型矩阵。</p><h2 id="十四、投影矩阵、视图矩阵、模型矩阵共冶一炉" tabindex="-1"><a class="header-anchor" href="#十四、投影矩阵、视图矩阵、模型矩阵共冶一炉" aria-hidden="true">#</a> 十四、投影矩阵、视图矩阵、模型矩阵共冶一炉</h2><p>投影矩阵、视图矩阵、模型矩阵的结合方式：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>最终的顶点坐标 <span class="token operator">=</span> 投影矩阵 <span class="token operator">*</span> 视图矩阵 <span class="token operator">*</span> 模型矩阵 <span class="token operator">*</span> 初始顶点坐标<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>投影矩阵：
  <span class="token operator">-</span> <span class="token function">正交投影矩阵：将世界坐标系中的一块矩形区域</span><span class="token punctuation">(</span>正交相机的可视区域<span class="token punctuation">)</span>投射到裁剪空间中，不同深度物体不具备近大远小的透视规则
    正交投影矩阵 <span class="token operator">=</span> 缩放矩阵<span class="token operator">*</span>位移矩阵
  <span class="token operator">-</span> 透视投影矩阵：将世界坐标系中的一块四棱台形的区域投射到裁剪空间中，不同深度的物体具备近大远小的透视规则

视图矩阵：相机位移矩阵乘以旋转矩阵后的逆矩阵，即相机的世界矩阵的逆矩阵
  <span class="token operator">-</span> 位移矩阵：由视点位置得出
  <span class="token operator">-</span> 旋转矩阵：由视点、目标点、上方向得出

投影视图矩阵：投影矩阵乘以视图矩阵

模型矩阵：模型矩阵可以对物体进行位移、旋转、缩放变换，比如我们想让物体沿 z 旋转
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_1-投影视图矩阵" tabindex="-1"><a class="header-anchor" href="#_1-投影视图矩阵" aria-hidden="true">#</a> 1-投影视图矩阵</h3><p>1.在顶点着色器里把投影矩阵变成投影视图矩阵。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>2.设置相机位置，并让其看向一点</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>3.计算投影视图矩阵，即让相机的投影矩阵乘以视图矩阵</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4.修改一下建立三角形方法里的 uniform 变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl/71.png" alt=""></p><p>接下来，再把模型矩阵加进去。</p><h3 id="_2-投影视图矩阵乘以模型矩阵" tabindex="-1"><a class="header-anchor" href="#_2-投影视图矩阵乘以模型矩阵" aria-hidden="true">#</a> 2-投影视图矩阵乘以模型矩阵</h3><p>之前设置三角形位置的时候，是直接对顶点的原始数据进行的修改。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    x<span class="token punctuation">,</span> <span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
    <span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其实，可以将位移数据写进模型矩阵里的，当然旋转和缩放数据也可以写进去，然后用模型矩阵乘以原始顶点，从而实现对模型的变换。</p><p>1.顶点着色器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>attribute vec4 a_Position<span class="token punctuation">;</span>
uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.在 crtTriangle()方法里，把三角形的数据源写死，在 uniforms 里添加一个模型矩阵。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> modelMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    modelMatrix<span class="token punctuation">,</span>
    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> modelMatrix<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>2.建立四个三角形</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const triangle1 = crtTriangle(
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">-0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">-3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
)

const triangle2 = crtTriangle(
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">-3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
)

const triangle3 = crtTriangle(
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">-0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">-2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
)

const triangle4 = crtTriangle(
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">-2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl/70.png" alt=""></p><h2 id="十五、正交相机轨道控制器" tabindex="-1"><a class="header-anchor" href="#十五、正交相机轨道控制器" aria-hidden="true">#</a> 十五、正交相机轨道控制器</h2><p>相机轨道控制器可以变换相机，从而灵活观察物体。</p><p>three.js 中的相机轨道控制器是通过以下事件变换相机的：（<a href="https://threejs.org/examples/?q=orbi#misc_controls_orbit" target="_blank" rel="noopener noreferrer">orbitControls<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）</p><ul><li><p>旋转</p><ul><li>鼠标左键拖拽</li><li>单手指移动</li></ul></li><li><p>缩放</p><ul><li>鼠标滚轮滚动</li><li>两个手指展开或挤压</li></ul></li><li><p>平移</p><ul><li>鼠标右键拖拽</li><li>鼠标左键+ctrl/meta/shiftKey 拖拽</li><li>箭头键</li><li>两个手指移动</li></ul></li></ul><p>在实际项目开发中，不能对 three.js 里的相机轨道控制器太过依赖。</p><p>因为其不能满足图形项目里的所有需求，这是经验之谈，若不能充分理解相机轨道控制器的实现原理，整个项目都会被卡住。</p><p>所以，接下来要从最底层实现相机轨道控制器。</p><p>我们先使用相机轨道控制器变换正交相机。</p><h3 id="_1-正交相机的位移轨道" tabindex="-1"><a class="header-anchor" href="#_1-正交相机的位移轨道" aria-hidden="true">#</a> 1-正交相机的位移轨道</h3><h4 id="_1-1-搭建场景" tabindex="-1"><a class="header-anchor" href="#_1-1-搭建场景" aria-hidden="true">#</a> 1-1-搭建场景</h4><p>准备 4 个三角形+1 个相机</p><ul><li>着色器</li></ul><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span>u_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>初始化着色器</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  PerspectiveCamera<span class="token punctuation">,</span>
  Vector2<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  Quaternion<span class="token punctuation">,</span>
  Object3D<span class="token punctuation">,</span>
  OrthographicCamera<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&quot;./jsm/Poly.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>正交相机</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
<span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">-</span>halfW<span class="token punctuation">,</span>
  halfW<span class="token punctuation">,</span>
  halfH<span class="token punctuation">,</span>
  <span class="token operator">-</span>halfH<span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>4 个三角形</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> triangle3 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> triangle4 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle1<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle2<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle3<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle3<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  triangle4<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  triangle4<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="_1-2-声明基础数据" tabindex="-1"><a class="header-anchor" href="#_1-2-声明基础数据" aria-hidden="true">#</a> 1-2-声明基础数据</h4><ul><li>鼠标事件集合</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mouseButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;pan&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ​	2：鼠标右键按下时的event.button值</span>
<span class="token comment">// ​	pan：平移</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>轨道控制器状态，表示控制器正在对相机进行哪种变换。比如 state 等于 pan 时，代表位移</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>let state = &#39;none&#39;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>鼠标在屏幕上拖拽时的起始位和结束位，以像素为单位</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> dragStart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dragEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>鼠标每次移动时的位移量，webgl 坐标量</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> panOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>鼠标在屏幕上垂直拖拽时，是基于相机本地坐标系的 y 方向还是 z 方向移动相机</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> screenSpacePanning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">// true：y向移动</span>
<span class="token comment">// false：z向移动</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_1-3-在-canvas-上绑定鼠标事件" tabindex="-1"><a class="header-anchor" href="#_1-3-在-canvas-上绑定鼠标事件" aria-hidden="true">#</a> 1-3-在 canvas 上绑定鼠标事件</h4><ul><li>取消右击菜单的显示</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;contextmenu&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>指针按下时，设置拖拽起始位，获取轨道控制器状态。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointerdown&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  dragStart<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state <span class="token operator">=</span> mouseButtons<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>注：指针事件支持多种方式的指针顶点输入，如鼠标、触控笔、触摸屏等。</p><ul><li>指针移动时，若控制器处于平移状态，平移相机。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointermove&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;pan&quot;</span><span class="token operator">:</span>
      <span class="token function">handleMouseMovePan</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>指针抬起时，清除控制器状态。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointerup&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来我们重点看一下相机平移方法 handleMouseMovePan()。</p><h4 id="_1-4-相机平移方法" tabindex="-1"><a class="header-anchor" href="#_1-4-相机平移方法" aria-hidden="true">#</a> 1-4-相机平移方法</h4><p>相机平移方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handleMouseMovePan</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//指针拖拽的结束位(像素单位)</span>
  dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//基于拖拽距离(像素单位)移动相机</span>
  <span class="token function">pan</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//重置拖拽起始位</span>
  dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>基于拖拽距离(像素单位)移动相机</li></ul><p><img src="/visual/webgl/72.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">pan</span><span class="token punctuation">(</span><span class="token parameter">delta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//相机近裁剪面尺寸</span>
  <span class="token keyword">const</span> cameraW <span class="token operator">=</span> camera<span class="token punctuation">.</span>right <span class="token operator">-</span> camera<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cameraH <span class="token operator">=</span> camera<span class="token punctuation">.</span>top <span class="token operator">-</span> camera<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
  <span class="token comment">//指针拖拽量在画布中的比值</span>
  <span class="token keyword">const</span> ratioX <span class="token operator">=</span> delta<span class="token punctuation">.</span>x <span class="token operator">/</span> canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ratioY <span class="token operator">=</span> delta<span class="token punctuation">.</span>y <span class="token operator">/</span> canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//将像素单位的位移量转换为相机近裁剪面上的位移量</span>
  <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW<span class="token punctuation">;</span>
  <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH<span class="token punctuation">;</span>
  <span class="token comment">//相机本地坐标系里的x轴(第一列)</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//相机x轴平移量</span>
  <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//相机z|y轴平移量</span>
  <span class="token keyword">const</span> vy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//y向(第二列)</span>
    vy<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//-z向</span>
    vy<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//相机y向或-z向的平移量</span>
  vy<span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//整合平移量</span>
  panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//更新</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ul><li>基于平移量，位移相机，更新投影视图矩阵</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_2-正交相机的缩放轨道" tabindex="-1"><a class="header-anchor" href="#_2-正交相机的缩放轨道" aria-hidden="true">#</a> 2-正交相机的缩放轨道</h3><h4 id="_2-1-正交相机的缩放原理" tabindex="-1"><a class="header-anchor" href="#_2-1-正交相机的缩放原理" aria-hidden="true">#</a> 2-1-正交相机的缩放原理</h4><p>相机的缩放就是让我们在裁剪空间中看到的同一深度上的东西更多或者更少。</p><p>通常大家很容易结合实际生活来考虑，比如我们正对着一面墙壁，墙壁上铺满瓷砖。</p><p>当我们把镜头拉近时，看到的瓷砖数量就变少了，每块瓷砖的尺寸也变大了；</p><p>反之，当我们把镜头拉远时，看到的瓷砖数量就变多了，每块瓷砖的尺寸也变小了。</p><p>然而这种方式只适用于透视相机，并不适用于正交相机，因为正交相机不具备近大远小规则。</p><p>正交相机的缩放，是直接缩放的投影面，这个投影面在 three.js 里就是近裁剪面。</p><p>当投影面变大了，那么能投影的顶点数量也就变多了；</p><p>反之，当投影面变小了，那么能投影的顶点数量也就变少了。</p><p><img src="/visual/webgl/58.png" alt=""></p><p>接下来，分析一下相机的具体缩放方法。</p><h4 id="_2-2-正交相机缩放方法" tabindex="-1"><a class="header-anchor" href="#_2-2-正交相机缩放方法" aria-hidden="true">#</a> 2-2-正交相机缩放方法</h4><p>在 three.js 里的正交相机对象 OrthographicCamera 的 updateProjectionMatrix() 方法里可以找到正交相机的缩放方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">updateProjectionMatrix</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dx <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dy <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bottom <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cx <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cy <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bottom <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> left <span class="token operator">=</span> cx <span class="token operator">-</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">let</span> right <span class="token operator">=</span> cx <span class="token operator">+</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> cy <span class="token operator">+</span> dy<span class="token punctuation">;</span>
    <span class="token keyword">let</span> bottom <span class="token operator">=</span> cy <span class="token operator">-</span> dy<span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以将上面的 dx、dy 分解一下：</p><ul><li>近裁剪面宽度的一半 width：( this.right - this.left ) / 2</li><li>近裁剪面高度的一半 height：( this.top - this.bottom ) / 2</li><li>dx=width/zoom</li><li>dy=height/zoom</li></ul><p>在 three.js 里，zoom 的默认值是 1，即不做缩放。</p><p>由上可以得到正交相机缩放的性质：</p><ul><li>zoom 值和近裁剪面的尺寸成反比</li><li>近裁剪面的尺寸和我们在同一深度所看物体的数量成正比</li><li>近裁剪面的尺寸和我们所看的同一物体的尺寸成反比</li></ul><h4 id="_2-4-正交相机缩放轨道的实现" tabindex="-1"><a class="header-anchor" href="#_2-4-正交相机缩放轨道的实现" aria-hidden="true">#</a> 2-4-正交相机缩放轨道的实现</h4><p>基于之前的相机位移轨道继续写代码。</p><p>1.定义滚轮在每次滚动时的缩放系数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> zoomScale <span class="token operator">=</span> <span class="token number">0.95</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>2.为 canvas 添加滚轮事件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;wheel&quot;</span><span class="token punctuation">,</span> handleMouseWheel<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">handleMouseWheel</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> deltaY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deltaY <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> zoomScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>deltaY <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dolly</span><span class="token punctuation">(</span>zoomScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当 deltaY&lt;0 时，是向上滑动滚轮，会缩小裁剪面；</p><p>当 deltaY&gt;0 时，是向下滑动滚轮，会放大裁剪面。</p><p>3.通过 dolly()方法缩放相机</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  camera<span class="token punctuation">.</span>zoom <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3-正交相机的旋转轨道" tabindex="-1"><a class="header-anchor" href="#_3-正交相机的旋转轨道" aria-hidden="true">#</a> 3-正交相机的旋转轨道</h3><h4 id="_3-1-正交相机的旋转轨道的概念" tabindex="-1"><a class="header-anchor" href="#_3-1-正交相机的旋转轨道的概念" aria-hidden="true">#</a> 3-1-正交相机的旋转轨道的概念</h4><p>相机的旋转轨道的实现原理就是让相机绕物体旋转。</p><p>相机旋转轨迹的集合是一个球体。</p><p>相机旋转轨道的实现方式是有许多种的，至于具体用哪种，还要看我们具体的项目需求。</p><p>这里就先说一种基于球坐标系旋转的相机旋转轨道，至于其它的旋转方式，后面再说。</p><p><img src="/visual/webgl/73.png" alt=""></p><p>已知：</p><ul><li>三维坐标系[O;x,y,z]</li><li>正交相机 <ul><li>视点位：点 P</li><li>目标位：点 O</li></ul></li><li>正交相机旋转轨的旋转轴是 y 轴</li></ul><p>则：</p><p>正交相机在球坐标系中的旋转轨道有两种：</p><ul><li>点 P 绕旋转轴 y 轴的旋转轨道，即上图的蓝色轨道。</li><li>点 P 在平面 OPy 中的旋转轨道，即上图的绿色轨迹。</li></ul><p>接下来，结合正交相机的实际情况，说一下如何计算正交相机旋转后的视点位。</p><h4 id="_3-2-正交相机旋转后的视点位" tabindex="-1"><a class="header-anchor" href="#_3-2-正交相机旋转后的视点位" aria-hidden="true">#</a> 3-2-正交相机旋转后的视点位</h4><p><img src="/visual/webgl/73.png" alt=""></p><p>已知：</p><ul><li>三维坐标系[O;x,y,z]</li><li>正交相机 <ul><li>视点位：三维坐标点 P(x,y,z)</li><li>目标位：点 O</li></ul></li><li>正交相机旋转轨的旋转轴是 y 轴</li></ul><p>求：相机在平面 OPy 中旋转 a 度，绕 y 轴旋转 b 度后，相机视点的三维空间位 P&#39;(x&#39;,y&#39;,z&#39;)</p><p>解：</p><p>1.将点 P(x,y,z)的三维坐标位换算为球坐标位，即 P(r,φ,θ)</p><p>2.计算点 P 在平面 OPy 中旋转 a 度，绕 y 轴旋转 b 度后的球坐标位，即 P(r,φ+a,θ+b)</p><p>3.将点 P 的球坐标位转换为三维坐标位</p><p>求解的思路就这么简单，那具体怎么实现呢？咱们先把上面的球坐标解释一下。</p><h4 id="_3-3-球坐标系" tabindex="-1"><a class="header-anchor" href="#_3-3-球坐标系" aria-hidden="true">#</a> 3-3-球坐标系</h4><p>Ⅰ 球坐标系的概念</p><p><img src="/visual/webgl/73.png" alt=""></p><p>球坐标系（spherical coordinate system）是用球坐标表示空间点位的坐标系。</p><p>球坐标由以下分量构成：</p><ul><li>半径(radial distance) r：OP 长度( 0 ≤ r ) 。</li><li>极角(polar angle) φ：OP 与 y 轴的夹角(0 ≤ φ ≤ π)</li><li>方位角(azimuth angle) θ：OP 在平面 Oxz 上的投影与正 x 轴的夹角( 0 ≤ θ &lt; 2π )。</li></ul><p>注：</p><ul><li>球坐标系可视极坐标系的三维推广。</li><li>当 r=0 时，φ 和 θ 无意义。</li><li>当 φ =0 或 φ =π 时，θ 无意义。</li></ul><p>接下来咱们说一下球坐标与三维坐标的转换。</p><p>Ⅱ 三维坐标转球坐标</p><p><img src="/visual/webgl/73.png" alt=""></p><p>已知：点 P 的三维坐标位(x,y,z)</p><p>求：点 P 的球坐标位(r,φ,θ)</p><p>解：</p><p>求半径 r：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>r<span class="token operator">=</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x²<span class="token operator">+</span>y²<span class="token operator">+</span>z²<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>求极角 φ 的方法有三种：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>φ=acos(y/r)
φ=asin(sqrt(x²+z²)/r)
φ=atan(sqrt(x²+z²)/y)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>求方位角 θ 的方法有三种：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>θ=acos(x/(r*sinφ))
θ=asin(z/(r*sinφ))
θ=atan(z/x)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注：</p><p>在用反正切求角度时，需要注意点问题。</p><p>atan()返回的值域是[-PI/2,PI/2]，这是个半圆，这会导致其返回的弧度失真。</p><p>如：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>atan(z/x)==atan(-z/-x)
atan(-z/x)==atan(z/-x)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所以，在 js 里用反正切计算弧度时，要使用 atan2() 方法，即：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>φ=Math.atan2(sqrt(x²+z²),y)
θ=Math.atan2(z,x)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>atan2()返回的值域是[-PI,PI]，这是一个整圆。</p><p>atan2()方法是将 z,x 分开写入的，其保留了其最原始的正负符号，所以其返回的弧度不会失真。</p><p>Ⅲ 球坐标转三维坐标</p><p>已知：点 P 的球坐标位(r,φ,θ)</p><p>求：点 P 的三维坐标位(x,y,z)</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x <span class="token operator">=</span> r <span class="token operator">*</span> sinφ <span class="token operator">*</span> cosθ<span class="token punctuation">;</span>
y <span class="token operator">=</span> r <span class="token operator">*</span> cosφ<span class="token punctuation">;</span>
z <span class="token operator">=</span> r <span class="token operator">*</span> sinφ <span class="token operator">*</span> sinθ<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>关于球坐标系就说到这，接下来我们就可以说一下正交相机旋转轨道的具体代码实现啦。</p><h4 id="_3-4-正交相机旋转轨道的代码实现" tabindex="-1"><a class="header-anchor" href="#_3-4-正交相机旋转轨道的代码实现" aria-hidden="true">#</a> 3-4-正交相机旋转轨道的代码实现</h4><p>在这里，把之前的位移轨道和缩放轨道合着现在的旋转轨道一起来说。</p><p>场景还是之前的场景，直接说轨道。</p><p>1.声明基础数据</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//鼠标事件集合</span>
<span class="token keyword">const</span> mouseButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;rotate&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;pan&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//轨道状态</span>
<span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//2PI</span>
<span class="token keyword">const</span> pi2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">//鼠标拖拽的起始位和结束位，无论是左键按下还是右键按下</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>dragStart<span class="token punctuation">,</span> dragEnd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>2.声明轨道相关的基础数据</p><ul><li>平移轨道</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//平移量</span>
<span class="token keyword">const</span> panOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//是否沿相机y轴平移相机</span>
<span class="token keyword">const</span> screenSpacePanning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>缩放轨道</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//缩放系数</span>
<span class="token keyword">const</span> zoomScale <span class="token operator">=</span> <span class="token number">0.95</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>旋转轨道</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//相机视点相对于目标的球坐标</span>
<span class="token keyword">const</span> spherical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>3.取消右击菜单的显示</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;contextmenu&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>4.指针按下时，设置拖拽起始位，获取轨道控制器状态。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointerdown&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  dragStart<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state <span class="token operator">=</span> mouseButtons<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>5.指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointermove&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;pan&quot;</span><span class="token operator">:</span>
      <span class="token function">pan</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;rotate&quot;</span><span class="token operator">:</span>
      <span class="token function">rotate</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>平移方法</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">pan</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cameraW <span class="token operator">=</span> camera<span class="token punctuation">.</span>right <span class="token operator">-</span> camera<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cameraH <span class="token operator">=</span> camera<span class="token punctuation">.</span>top <span class="token operator">-</span> camera<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ratioY <span class="token operator">=</span> y <span class="token operator">/</span> canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW<span class="token punctuation">;</span>
  <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH<span class="token punctuation">;</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vy<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    vy<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  vy<span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ul><li>旋转方法</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
  spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span> <span class="token comment">// yes, height</span>
  spherical<span class="token punctuation">.</span>phi <span class="token operator">-=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>6.滚轮滚动时，缩放相机</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;wheel&quot;</span><span class="token punctuation">,</span> handleMouseWheel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">handleMouseWheel</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> deltaY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deltaY <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> zoomScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">dolly</span><span class="token punctuation">(</span>zoomScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  camera<span class="token punctuation">.</span>zoom <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>7.更新相机，并渲染</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//基于平移量平移相机</span>
  target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于旋转量旋转相机</span>
  <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//更新投影视图矩阵</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//重置旋转量和平移量</span>
  spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渲染</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>正交相机旋转轨道的基本实现原理就是这样，接下来我们再对其做一下补充与扩展。</p><h4 id="_3-5-限制旋转轴" tabindex="-1"><a class="header-anchor" href="#_3-5-限制旋转轴" aria-hidden="true">#</a> 3-5-限制旋转轴</h4><p>在 three.js 的轨道控制器里，无法限制旋转轴，比如只想横向旋转相机，或者竖向旋转相机。</p><p>这样的需求，是在实战项目中，遇到的比较卡人的需求之一。</p><p>一旦我们不理解其底层原理，那就很难实现这个看似简单的需求。</p><p>不过，现在既然已经知道了其底层原理，那实现起来也就简单了。</p><p>1.声明一个控制旋转方向的属性</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rotateDir <span class="token operator">=</span> <span class="token string">&quot;xy&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li><p>x：可以在 x 方向旋转相机</p></li><li><p>y：可以在 y 方向旋转相机</p></li><li><p>xy：可以在 x,y 方向旋转相机</p><p>2.旋转方法，基于 rotateDir 属性约束旋转方向</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
  <span class="token keyword">const</span> deltaT <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span> <span class="token comment">// yes, height</span>
  <span class="token keyword">const</span> deltaP <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> deltaT<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spherical<span class="token punctuation">.</span>phi <span class="token operator">-=</span> deltaP<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_3-6-限制极角" tabindex="-1"><a class="header-anchor" href="#_3-6-限制极角" aria-hidden="true">#</a> 3-6-限制极角</h4><p>之前说球坐标系的时候说过，其极角的定义域是[0,180°]，所以在代码里也要对其做一下限制。</p><p>在 rotate() 方法里做下调整即可。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//旋转</span>
<span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ……
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;y&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> phi <span class="token operator">=</span> spherical<span class="token punctuation">.</span>phi <span class="token operator">-</span> deltaP
        spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
            Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span>
            Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>然而，因为当球坐标里的极角等于 0 或 180 度的时候，方位角会失去意义，所以还不能在代码真的给极角 0 或 180 度，不然方位角会默认归零。</p><p>所以，需要分别给极角里的 0 和 180 度一个近似值。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.99999999</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.00000001</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>基于球坐标系的相机旋转轨道我们就说到这，其具体代码可以参考 three.js 里的 OrbitControls 对象的源码。</p><p>接下来，再说一个另一种形式的正交相机旋转轨道。</p><h3 id="_4-轨迹球旋转" tabindex="-1"><a class="header-anchor" href="#_4-轨迹球旋转" aria-hidden="true">#</a> 4-轨迹球旋转</h3><p>轨迹球这个名字，来自 three.js 的 TrackballControls 对象，其具体的代码实现便可以在这里找到。</p><p>轨迹球不像基于球坐标系的旋转轨道那样具有恒定的上方向。</p><p>轨迹球的上方向是一个垂直于鼠标拖拽方向和视线的轴，相机视点会基于此轴旋转。</p><p>轨迹球的上方向会随鼠标拖拽方向的改变而改变。</p><p>如下图：</p><p><img src="/visual/webgl/74.png" alt=""></p><p>接下来，说一下具体的代码实现。</p><p>在 three.js 中，TrackballControls 和 OrbitControls 对象里的代码，不太像一个人写的。</p><p>因为完全可以沿用 OrbitControls 里的一部分代码去写 TrackballControls，比如鼠标在相机世界里的偏移量，而 TrackballControls 完全用一套风格迥异的代码从头写了一遍。</p><p>当然，这里并不是说 TrackballControls 不好，其原理和功能的实现方法依旧是很值得学习。</p><p>只是在写轨迹球的时候，完全可以基于 TrackballControls 的实现原理，把 OrbitControls 给改一下，这样可以少写许多代码。</p><p>1.定义用于沿某个轴旋转相机视点的四元数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> quaternion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>2.把之前的 rotate()旋转方法改一下</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> right<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> position <span class="token punctuation">}</span> <span class="token operator">=</span> camera<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>

  <span class="token comment">// 相机宽高</span>
  <span class="token keyword">const</span> cameraW <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cameraH <span class="token operator">=</span> top <span class="token operator">-</span> bottom<span class="token punctuation">;</span>

  <span class="token comment">// 鼠标位移距离在画布中的占比</span>
  <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> clientWidth<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ratioY <span class="token operator">=</span> <span class="token operator">-</span>y <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>

  <span class="token comment">//基于高度的x位置比-用于旋转量的计算</span>
  <span class="token keyword">const</span> ratioXBaseHeight <span class="token operator">=</span> x <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//位移量</span>
  <span class="token keyword">const</span> ratioLen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>ratioXBaseHeight<span class="token punctuation">,</span> ratioY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//旋转量</span>
  <span class="token keyword">const</span> angle <span class="token operator">=</span> ratioLen <span class="token operator">*</span> pi2<span class="token punctuation">;</span>

  <span class="token comment">// 在相机世界中的位移距离</span>
  <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW<span class="token punctuation">;</span>
  <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH<span class="token punctuation">;</span>

  <span class="token comment">// 相机本地坐标系的x,y轴</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将鼠标在相机世界的x,y轴向的位移量转换为世界坐标位</span>
  <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vy <span class="token operator">=</span> my<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//鼠标在s&#39;j&#39;z中的位移方向-x轴</span>
  <span class="token keyword">const</span> moveDir <span class="token operator">=</span> vx
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//目标点到视点的单位向量-z轴</span>
  <span class="token keyword">const</span> eyeDir <span class="token operator">=</span> camera<span class="token punctuation">.</span>position
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于位移方向和视线获取旋转轴-上方向y轴</span>
  <span class="token keyword">const</span> axis <span class="token operator">=</span> moveDir<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>eyeDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于旋转轴和旋转量建立四元数</span>
  quaternion<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span>axis<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>3.在 update()更新方法中，基于四元数设置相机视点位置，并更新相机上方向</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 更新相机，并渲染 */</span>
<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ……

    <span class="token comment">//旋转视线</span>
    <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> camera<span class="token punctuation">.</span>position
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span>

    <span class="token comment">//基于最新视线设置相机位置</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
        target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token comment">//旋转相机上方向</span>
    camera<span class="token punctuation">.</span>up<span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span>

    ……

    <span class="token comment">//重置旋转量和平移量</span>
    panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    quaternion<span class="token punctuation">.</span><span class="token function">setFromRotationMatrix</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>修改完相机的视点位和上方后，要记得重置四元数，以避免在拖拽和缩放时，造成相机旋转。</p><p>注：</p><p>轨迹球的操控难度是要比球坐标系轨道大的，它常常让不熟练其特性的操作者找不到北，所以在实际项目中还是球坐标系轨道用得比较多。</p><h2 id="十六、透视相机轨道控制器" tabindex="-1"><a class="header-anchor" href="#十六、透视相机轨道控制器" aria-hidden="true">#</a> 十六、透视相机轨道控制器</h2><p>之前说过了正交相机的轨道控制器，接下来再看透视相机的轨道控制器，就会方便很多。</p><h3 id="_1-透视相机的位移轨道" tabindex="-1"><a class="header-anchor" href="#_1-透视相机的位移轨道" aria-hidden="true">#</a> 1-透视相机的位移轨道</h3><p>透视相机的位移轨道和正交相机的位移轨道是相同原理的，都是对相机视点和目标点的平移。</p><p>直接说一下代码实现。</p><p>1.建透视交相机</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>2.在正交相机的位移轨道的基础上改一下 pan 方法</p><p><img src="/visual/webgl/75.png" alt=""></p><ul><li>将鼠标在画布中的位移量转目标平面位移量</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> up <span class="token punctuation">}</span> <span class="token operator">=</span> camera<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>

<span class="token comment">//视线长度：相机视点到目标点的距离</span>
<span class="token keyword">const</span> sightLen <span class="token operator">=</span> position
  <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//视椎体垂直夹角的一半(弧度)</span>
<span class="token keyword">const</span> halfFov <span class="token operator">=</span> <span class="token punctuation">(</span>fov <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">360</span><span class="token punctuation">;</span>
<span class="token comment">//目标平面的高度</span>
<span class="token keyword">const</span> targetHeight <span class="token operator">=</span> sightLen <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span>halfFov<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">//目标平面与画布的高度比</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> targetHeight <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
<span class="token comment">//画布位移量转目标平面位移量</span>
<span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> x <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
<span class="token keyword">const</span> distanceUp <span class="token operator">=</span> y <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>注：目标平面是过视点，平行于裁剪面的平面</p><ul><li>将鼠标在目标平面中的位移量转世界坐标</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//相机平移方向</span>
<span class="token comment">//鼠标水平运动时，按照相机本地坐标的x轴平移相机</span>
<span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//鼠标水平运动时，按照相机本地坐标的y轴，或者-z轴平移相机</span>
<span class="token keyword">const</span> myOrz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//y轴，正交相机中默认</span>
  myOrz<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">//-z轴，透视相机中默认</span>
  myOrz<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//目标平面位移量转世界坐标</span>
<span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vy <span class="token operator">=</span> myOrz<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_2-透视相机的缩放轨道" tabindex="-1"><a class="header-anchor" href="#_2-透视相机的缩放轨道" aria-hidden="true">#</a> 2-透视相机的缩放轨道</h3><p>透视相机缩放是通过视点按照视线的方向，接近或者远离目标点来实现的。</p><p><img src="/visual/webgl/76.png" alt=""></p><h4 id="_2-1-举个例子" tabindex="-1"><a class="header-anchor" href="#_2-1-举个例子" aria-hidden="true">#</a> 2-1-举个例子</h4><p>已知：</p><ul><li>视点 e=5</li><li>目标点 t=15</li><li>（视点即将位移的距离）/（位移前，视点与与目标点的距离）= 0.4</li></ul><p>求：视点移动 2 次后的位置</p><p>解：</p><p>视点第 1 次移动后的位置：5+(15-5)*0.4=9</p><p>视点第 2 次移动后的位置：9+(15-9)*0.4= 11.4</p><p>基本原理就是这样，视点移动 n 此后的位置都可以按照上面的逻辑来计算。</p><p>接下来，看一下代码实现。</p><h4 id="_2-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-2-代码实现" aria-hidden="true">#</a> 2-2-代码实现</h4><p>可以直接在正交相机缩放轨道的基础上做一下修改。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> dollyScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><p>lerp ( v : Vector3, alpha : Float ) 按比例去两点之间的插值</p><p>其源码如下：</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">lerp</span><span class="token punctuation">(</span> <span class="token parameter">v<span class="token punctuation">,</span> alpha</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">+=</span> <span class="token punctuation">(</span> v<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token punctuation">)</span> <span class="token operator">*</span> alpha<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token punctuation">(</span> v<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token punctuation">)</span> <span class="token operator">*</span> alpha<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">+=</span> <span class="token punctuation">(</span> v<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token punctuation">)</span> <span class="token operator">*</span> alpha<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><p>dollyScale：（位移之后视点与目标点的距离）/（位移前，视点与与目标点的距离）</p></li><li><p>1-dollyScale：（视点即将位移的距离）/（位移前，视点于与目标点的距离）</p></li></ul><p>正交相机缩放轨道的基本实现原理就是这么简单。</p><p>然而，后面还得用球坐标对相机进行旋转，球坐标是已经涵盖了相机视点位的。</p><p>因此，还可以直接把相机视点位写进球坐标里。</p><h4 id="_2-3-球坐标缩放" tabindex="-1"><a class="header-anchor" href="#_2-3-球坐标缩放" aria-hidden="true">#</a> 2-3-球坐标缩放</h4><p>1.像正交相机的旋转轨道那样，定义球坐标对象。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> spherical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>2.修改旋转方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  spherical<span class="token punctuation">.</span>radius <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>3.更新方法也和正交相机的旋转轨道一样</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//基于平移量平移相机</span>
  target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于球坐标缩放和旋转相机</span>
  <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//更新投影视图矩阵</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//重置球坐标和平移量</span>
  spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渲染</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_3-透视相机的旋转轨道" tabindex="-1"><a class="header-anchor" href="#_3-透视相机的旋转轨道" aria-hidden="true">#</a> 3-透视相机的旋转轨道</h3><p>透视相机的旋转轨道和正交相机的实现原理都是一样的，可以用球坐标系实现，也可以用轨迹球实现。</p><ul><li>基于球坐标系的旋转轨道，可直接参考正交相机基于球坐标系的旋转轨道来写。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 旋转轨道 */</span>
<span class="token keyword">const</span> spherical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token comment">//&#39;xy&#39;,&#39;x&#39;,&#39;y&#39;</span>
<span class="token keyword">const</span> rotateDir <span class="token operator">=</span> <span class="token string">&#39;xy&#39;</span>

……

<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&#39;pan&#39;</span><span class="token operator">:</span>
            <span class="token function">pan</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token string">&#39;rotate&#39;</span><span class="token operator">:</span>
            <span class="token function">rotate</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
……

<span class="token comment">// 旋转方法</span>
<span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas
    <span class="token keyword">const</span> deltaT <span class="token operator">=</span> pi2 <span class="token operator">*</span> x <span class="token operator">/</span> clientHeight
    <span class="token keyword">const</span> deltaP <span class="token operator">=</span> pi2 <span class="token operator">*</span> y <span class="token operator">/</span> clientHeight
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> deltaT
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;y&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> phi <span class="token operator">=</span> spherical<span class="token punctuation">.</span>phi <span class="token operator">-</span> deltaP
        spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
            Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.99999999</span><span class="token punctuation">,</span>
            Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.00000001</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//基于平移量平移相机</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>

    <span class="token comment">//基于球坐标缩放相机</span>
    <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
        target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//更新投影视图矩阵</span>
    camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
        camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
        camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//重置旋转量和平移量</span>
    spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
        camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 渲染</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><ul><li>对于轨迹球的旋转轨道，基于正交相机轨迹球旋转的代码略作调整即可。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 旋转轨道 */</span>
<span class="token keyword">const</span> quaternion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> fov <span class="token punctuation">}</span> <span class="token operator">=</span> camera<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>

  <span class="token comment">/* 1.基于鼠标拖拽距离计算旋转量 */</span>
  <span class="token comment">// 鼠标位移距离在画布中的占比</span>
  <span class="token keyword">const</span> ratioY <span class="token operator">=</span> <span class="token operator">-</span>y <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//基于高度的x位置比-用于旋转量的计算</span>
  <span class="token keyword">const</span> ratioBaseHeight <span class="token operator">=</span> x <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//位移量</span>
  <span class="token keyword">const</span> ratioLen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>ratioBaseHeight<span class="token punctuation">,</span> ratioY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//旋转量</span>
  <span class="token keyword">const</span> angle <span class="token operator">=</span> ratioLen <span class="token operator">*</span> pi2<span class="token punctuation">;</span>

  <span class="token comment">/* 2.将鼠标在画布中的位移量转目标平面位移量 */</span>
  <span class="token comment">//视线长度：相机视点到目标点的距离</span>
  <span class="token keyword">const</span> sightLen <span class="token operator">=</span> position
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//视椎体垂直夹角的一半(弧度)</span>
  <span class="token keyword">const</span> halfFov <span class="token operator">=</span> <span class="token punctuation">(</span>fov <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">360</span><span class="token punctuation">;</span>
  <span class="token comment">//目标平面的高度</span>
  <span class="token keyword">const</span> targetHeight <span class="token operator">=</span> sightLen <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span>halfFov<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">//目标平面与画布的高度比</span>
  <span class="token keyword">const</span> ratio <span class="token operator">=</span> targetHeight <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//画布位移量转目标平面位移量</span>
  <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> x <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
  <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> <span class="token operator">-</span>y <span class="token operator">*</span> ratio<span class="token punctuation">;</span>

  <span class="token comment">/* 3.将鼠标在目标平面中的位移量转世界坐标，并从中提取鼠标在世界坐标系中的位移方向 */</span>
  <span class="token comment">// 相机本地坐标系的x,y轴</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将鼠标在相机世界的x,y轴向的位移量转换为世界坐标位</span>
  <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vy <span class="token operator">=</span> my<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//鼠标在世界坐标系中的位移方向-x轴</span>
  <span class="token keyword">const</span> moveDir <span class="token operator">=</span> vx
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 4.基于位移方向和视线获取旋转轴 */</span>
  <span class="token comment">//目标点到视点的单位向量-z轴</span>
  <span class="token keyword">const</span> eyeDir <span class="token operator">=</span> position
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//基于位移方向和视线获取旋转轴-上方向y轴</span>
  <span class="token keyword">const</span> axis <span class="token operator">=</span> moveDir<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>eyeDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 5.基于旋转轴和旋转量更新四元数 */</span>
  quaternion<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span>axis<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//基于平移量平移相机</span>
  target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于旋转量旋转相机</span>
  <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> camera<span class="token punctuation">.</span>position
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span><span class="token punctuation">;</span>

  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>up<span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//更新投影视图矩阵</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//重置旋转量和平移量</span>
  quaternion<span class="token punctuation">.</span><span class="token function">setFromRotationMatrix</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渲染</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><h2 id="十七、封装相机轨道对象" tabindex="-1"><a class="header-anchor" href="#十七、封装相机轨道对象" aria-hidden="true">#</a> 十七、封装相机轨道对象</h2><p>参考 three.js 里的 OrbitControls 对象，封装一个轨道控制器出来。</p><p>至于轨迹球的封装，可以参考着 TrackballControls 来实现。</p><p>正交相机轨道和透视相机轨道差异对比：</p><ul><li>旋转轨道 <ul><li>正交相机和透视相机的旋转轨道都是一样的，都是使用球坐标，让相机视点围绕目标点做的旋转。</li></ul></li><li>位移轨道 <ul><li>正交相机的位移轨道是鼠标从 canvas 画布到近裁剪面，再到世界坐标系的位移量的转换，最后这个位移量会同时作用于相机的目标点和视点。</li><li>透视相机的位移轨道是鼠标从 canvas 画布到目标平面，再到世界坐标系的位移量的转换，最后这个位移量会同时作用于相机的目标点和视点。</li></ul></li><li>缩放轨道 <ul><li>正交相机的缩放轨道是通过对其可视区域的宽高尺寸的缩放实现的。</li><li>透视相机的缩放轨道是通过相机视点在视线上的位移实现的。</li></ul></li></ul><p>整体的原理就是这样，接下来封装轨道控制器。</p><h3 id="_1-轨道控制器的封装" tabindex="-1"><a class="header-anchor" href="#_1-轨道控制器的封装" aria-hidden="true">#</a> 1-轨道控制器的封装</h3><p>整体代码如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  Vector2<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  Spherical<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pi2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mouseButtons</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;rotate&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;pan&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dragStart</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dragEnd</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">panOffset</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">screenSpacePanning</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">zoomScale</span><span class="token operator">:</span> <span class="token number">0.95</span><span class="token punctuation">,</span>
  <span class="token literal-property property">spherical</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">rotateDir</span><span class="token operator">:</span> <span class="token string">&quot;xy&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">OrbitControls</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> spherical<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> target <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pointerdown</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dragStart<span class="token punctuation">,</span> mouseButtons <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    dragStart<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> mouseButtons<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pointermove</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      dragStart<span class="token punctuation">,</span>
      dragEnd<span class="token punctuation">,</span>
      state<span class="token punctuation">,</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&quot;pan&quot;</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pan</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">&quot;rotate&quot;</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pointerup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">wheel</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> deltaY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      zoomScale<span class="token punctuation">,</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> scale <span class="token operator">=</span> deltaY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> zoomScale <span class="token operator">:</span> <span class="token number">1</span> <span class="token operator">/</span> zoomScale<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dolly</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dollyPerspectiveCamera</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>spherical<span class="token punctuation">.</span>radius <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dollyOrthographicCamera</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> camera <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span>zoom <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">panPerspectiveCamera</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> fov<span class="token punctuation">,</span> up <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">,</span>
      panOffset<span class="token punctuation">,</span>
      screenSpacePanning<span class="token punctuation">,</span>
      target<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">//视线长度：相机视点到目标点的距离</span>
    <span class="token keyword">const</span> sightLen <span class="token operator">=</span> position
      <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//视椎体垂直夹角的一半(弧度)</span>
    <span class="token keyword">const</span> halfFov <span class="token operator">=</span> <span class="token punctuation">(</span>fov <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">360</span><span class="token punctuation">;</span>
    <span class="token comment">//目标平面的高度</span>
    <span class="token keyword">const</span> targetHeight <span class="token operator">=</span> sightLen <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span>halfFov<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">//目标平面与画布的高度比</span>
    <span class="token keyword">const</span> ratio <span class="token operator">=</span> targetHeight <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token comment">//画布位移量转目标平面位移量</span>
    <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> x <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
    <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> y <span class="token operator">*</span> ratio<span class="token punctuation">;</span>

    <span class="token comment">//相机平移方向</span>
    <span class="token comment">//鼠标水平运动时，按照相机本地坐标的x轴平移相机</span>
    <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//鼠标水平运动时，按照相机本地坐标的y轴，或者-z轴平移相机</span>
    <span class="token keyword">const</span> myOrz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//y轴，正交相机中默认</span>
      myOrz<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//-z轴，透视相机中默认</span>
      myOrz<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//目标平面位移量转世界坐标</span>
    <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vy <span class="token operator">=</span> myOrz<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">panOrthographicCamera</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> right<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> up <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">,</span>
      panOffset<span class="token punctuation">,</span>
      screenSpacePanning<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> cameraW <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
    <span class="token keyword">const</span> cameraH <span class="token operator">=</span> top <span class="token operator">-</span> bottom<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> clientWidth<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ratioY <span class="token operator">=</span> y <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW<span class="token punctuation">;</span>
    <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH<span class="token punctuation">;</span>
    <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vy<span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">,</span>
      spherical<span class="token punctuation">,</span>
      rotateDir<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> deltaT <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> deltaP <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> deltaT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> phi <span class="token operator">=</span> spherical<span class="token punctuation">.</span>phi <span class="token operator">-</span> deltaP<span class="token punctuation">;</span>
      spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.99999999</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.00000001</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> spherical<span class="token punctuation">,</span> panOffset <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//基于平移量平移相机</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//基于球坐标缩放相机</span>
    <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//更新投影视图矩阵</span>
    camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//重置旋转量和平移量</span>
    spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> projectionMatrix<span class="token punctuation">,</span> matrixWorldInverse <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br></div></div><h3 id="_2-轨道控制器的实例化" tabindex="-1"><a class="header-anchor" href="#_2-轨道控制器的实例化" aria-hidden="true">#</a> 2-轨道控制器的实例化</h3><p>OrbitControls 对象就像 three.js 里的样，可以自动根据相机类型去做相应的轨道变换。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 透视相机 */</span>
<span class="token comment">/*
	const eye = new Vector3(0, 0.5, 1)
    const target = new Vector3(0, 0, -2.5)
    const up = new Vector3(0, 1, 0)
    const [fov, aspect, near, far] = [
      45,
      canvas.width / canvas.height,
      1,
      20
    ]
    const camera = new PerspectiveCamera(fov, aspect, near, far)
    camera.position.copy(eye)
*/</span>

<span class="token comment">/* 正交相机 */</span>
<span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height
<span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio
<span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">-</span>halfW<span class="token punctuation">,</span> halfW<span class="token punctuation">,</span> halfH<span class="token punctuation">,</span> <span class="token operator">-</span>halfH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>
    left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far
<span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>

<span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

……

<span class="token comment">/* 实例化轨道控制器 */</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    camera<span class="token punctuation">,</span>
    target<span class="token punctuation">,</span>
    <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/* 取消右击菜单的显示 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//滚轮事件</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h2 id="十八、顶点索引" tabindex="-1"><a class="header-anchor" href="#十八、顶点索引" aria-hidden="true">#</a> 十八、顶点索引</h2><h3 id="_1-顶点索引概念" tabindex="-1"><a class="header-anchor" href="#_1-顶点索引概念" aria-hidden="true">#</a> 1-顶点索引概念</h3><p>对于顶点索引的概念，其实在说复合变换里的模型矩阵的时候提过。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const verticeLib = <span class="token punctuation">[</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>;

const indices = <span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>

    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">]</span>;

const arr = <span class="token punctuation">[</span><span class="token punctuation">]</span>;
indices.forEach(n =&gt; <span class="token punctuation">{</span>
    const i = n * <span class="token number">3</span>
    arr.push(
        verticeLib<span class="token punctuation">[</span>i<span class="token punctuation">]</span> / <span class="token number">5</span><span class="token punctuation">,</span>
        verticeLib<span class="token punctuation">[</span>i + <span class="token number">1</span><span class="token punctuation">]</span> / <span class="token number">5</span><span class="token punctuation">,</span>
        verticeLib<span class="token punctuation">[</span>i + <span class="token number">2</span><span class="token punctuation">]</span> / <span class="token number">5</span><span class="token punctuation">,</span>
    )
<span class="token punctuation">}</span>)
const vertices = new Float32Array(arr)
……
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>下过如下：</p><p><img src="/visual/webgl/77.png" alt=""></p><p>上面是用 js 实现的顶点索引功能，其实这种功能可以直接通过 webgl api 来实现，不需要我们自己去算。</p><p>要做的就是建立一个顶点库，然后使用顶点在顶点库中的索引拼图形。</p><p>1.顶点数据 verticeLib 和顶点索引数据 indices 和之前一样</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const verticeLib = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
    <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span> <span class="token number">-1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>)

const indices = new Uint8Array(<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>

    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">]</span>)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>2.顶点数据在 webgl 缓冲区写入和之前都是一样的。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> verticeLib<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>3.视图矩阵和模型矩阵和设置和之前也是一样的</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ModelMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
modelMatrix<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>接下来是不一样的地方。</p><p>4.把顶点索引写入 webgl 缓冲区</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//建立缓冲对象</span>
<span class="token keyword">const</span> indicesBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在ELEMENT_ARRAY_BUFFER上绑定缓冲对象</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indicesBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将顶点索引数据写入缓冲对象</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>5.绘图</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// gl.drawArrays(gl.LINES, 0, indices.length);</span>
gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>drawElements(mode, count, type, offset) 是使用顶点索引绘图的方法。</p><ul><li>mode 绘图方式</li><li>count 元素数量</li><li>type 缓冲区数据的类型</li><li>offset 当前系列的字节索引位</li></ul><p>我们上面用顶点索引画了一个线框，重点就是说一个原理，接下来咱们再画一个好看些的彩色立方体。</p><h3 id="_2-彩色立方体" tabindex="-1"><a class="header-anchor" href="#_2-彩色立方体" aria-hidden="true">#</a> 2-彩色立方体</h3><p>彩色立方体的效果如下：</p><p><img src="/visual/webgl/78.png" alt=""></p><p>现在先不考虑灯光，只给顶点赋个颜色。</p><p>1.着色器</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec4 a_Color<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    v_Color<span class="token operator">=</span>a_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span>v_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>上面的 a_Color 是和 a_Position 一一对应的，一个顶点，一个颜色，所以我是用 attribute 声明的 a_Color。</p><p>如果整个立方体都是一个颜色，那我直接在片元着色器里用 uniform 声明就好了。</p><p>2.正常初始化着色器，打开深度测试。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  PerspectiveCamera<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  Quaternion<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&quot;./jsm/OrbitControls.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>深度测试可以解决物体的遮挡问题，不然后面的物体可能挡住前面的物体。</p><p>3.建立透视相机和轨道控制器。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 透视相机 */</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 实例化轨道控制器 */</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  camera<span class="token punctuation">,</span>
  target<span class="token punctuation">,</span>
  <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 取消右击菜单的显示 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;contextmenu&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointerdown&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointermove&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 指针抬起 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pointerup&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 滚轮事件 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;wheel&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>4.声明顶点数据 vertices 和顶点索引 indexes。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">//    v6----- v5</span>
<span class="token comment">//   /|      /|</span>
<span class="token comment">//  v1------v0|</span>
<span class="token comment">//  | |     | |</span>
<span class="token comment">//  | |v7---|-|v4</span>
<span class="token comment">//  |/      |/</span>
<span class="token comment">//  v2------v3</span>
const vertices = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// v0</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// v1</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v2</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// v3</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v4</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v5</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v6</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>   <span class="token comment">// v7</span>
<span class="token punctuation">]</span>)

const indexes = new Uint8Array(<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token comment">// front</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>    <span class="token comment">// right</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// up</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// left</span>
    <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// down</span>
    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span>     <span class="token comment">// back</span>
<span class="token punctuation">]</span>)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>顶点数据 vertices 是多 attribute 数据的合一，这个咱们之前讲过。</p><p>顶点数据中有两个系列，分别是顶点位置数据和顶点颜色数据。</p><p>5.将顶点数据写入缓冲区，并将其中的点位和颜色数据分别分配给 a_Position 和 a_Color</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//元素字节数</span>
<span class="token keyword">const</span> elementBytes <span class="token operator">=</span> vertices<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FSIZE</span> <span class="token operator">=</span> vertices<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
<span class="token comment">//系列尺寸</span>
<span class="token keyword">const</span> verticeSize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> colorSize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">//类目尺寸</span>
<span class="token keyword">const</span> categorySize <span class="token operator">=</span> verticeSize <span class="token operator">+</span> colorSize<span class="token punctuation">;</span>
<span class="token comment">//类目字节数</span>
<span class="token keyword">const</span> categoryBytes <span class="token operator">=</span> categorySize <span class="token operator">*</span> elementBytes<span class="token punctuation">;</span>
<span class="token comment">//系列字节索引位置</span>
<span class="token keyword">const</span> verticeByteIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> colorByteIndex <span class="token operator">=</span> verticeSize <span class="token operator">*</span> elementBytes<span class="token punctuation">;</span>

<span class="token comment">/* 顶点缓冲区 */</span>
<span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将顶点缓冲区里的点位数据分配给a_Position</span>
<span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
  a_Position<span class="token punctuation">,</span>
  verticeSize<span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>
  categoryBytes<span class="token punctuation">,</span>
  verticeByteIndex
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将顶点缓冲区里的颜色数据分配给a_Color</span>
<span class="token keyword">const</span> a_Color <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
  a_Color<span class="token punctuation">,</span>
  colorSize<span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>
  categoryBytes<span class="token punctuation">,</span>
  colorByteIndex
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Color<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>6.将顶点索引写入缓冲区。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 建立缓冲区对象</span>
<span class="token keyword">const</span> indexesBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//把缓冲区绑定到webgl 上下文对象上</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexesBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 往缓冲区写数据</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexes<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>7.建立模型矩阵，并传递给片元着色器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ModelMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
modelMatrix<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>8.建立投影视图矩阵，并传递给片元着色器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_PvMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_PvMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_PvMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>9.用连续渲染的方法绘图。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> indexes<span class="token punctuation">.</span>length<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="十九、多着色器" tabindex="-1"><a class="header-anchor" href="#十九、多着色器" aria-hidden="true">#</a> 十九、多着色器</h2><p>到目前为止都是用了一套着色器做的例子，这一套着色器包含了顶点着色器和片元着色器。</p><p>在实际开发中，不可能只用一套着色器做项目的，就比如场景里有两个三角形，一个三角形需要着纯色，一个三角形需要着纹理。</p><p><img src="/visual/webgl/79.png" alt=""></p><p>接下来就拿这两个三角形来说一下多着色器的实现方法。</p><h3 id="_1-多着色器绘图" tabindex="-1"><a class="header-anchor" href="#_1-多着色器绘图" aria-hidden="true">#</a> 1-多着色器绘图</h3><h4 id="_1-1-准备两套着色器" tabindex="-1"><a class="header-anchor" href="#_1-1-准备两套着色器" aria-hidden="true">#</a> 1-1-准备两套着色器</h4><p>两套着色器，一套着纯色，一套着纹理。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 着纯色 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidVertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 着纹理 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>textureVertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    v_Pin<span class="token operator">=</span>a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>textureFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h4 id="_1-2-绘制纯色三角形" tabindex="-1"><a class="header-anchor" href="#_1-2-绘制纯色三角形" aria-hidden="true">#</a> 1-2-绘制纯色三角形</h4><p>1.建立程序对象，并应用</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> solidVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> solidFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidFragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> solidProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> solidVsSource<span class="token punctuation">,</span> solidFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面的 createProgram() 方法是基于一套着色器建立程序对象的方法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//创建程序对象</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//建立着色对象</span>
  <span class="token keyword">const</span> vertexShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fragmentShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//把顶点着色对象装进程序对象中</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//把片元着色对象装进程序对象中</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//连接webgl上下文对象和程序对象</span>
  gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> program<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>关于程序对象的概念之前已经说过。</p><p>之前初始化着色器方法 initShaders() 只是比上面的方法多了一个应用程序对象的步骤：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这里之所以把启用程序的步骤提取出来，是因为一套着色器对应着一个程序对象。</p><p>而一个 webgl 上下文对象，是可以依次应用多个程序对象的。</p><p>通过不同程序对象，可以绘制不同材质的图形。</p><p>2.用当前的程序对象绘制图形</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> solidVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> solidVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> solidPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>因为后面还需要绘制一个纹理图形，纹理图形是需要等纹理加载成功才能绘制的。</p><p>这会造成两个三角形的异步绘制，这不是我们想要的，因为一异步，就会把之前三角形的缓冲数据给清理掉。</p><p>因此，需要同步绘制两个三角形。</p><p>先把上面的绘图方法封装到一个函数里，等纹理三角形的图片加载成功了，再执行。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">drawSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象，并应用 */</span>
  <span class="token keyword">const</span> solidVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidFragmentShader&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> solidVsSource<span class="token punctuation">,</span> solidFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token keyword">const</span> solidVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_1-3-绘制纹理三角形" tabindex="-1"><a class="header-anchor" href="#_1-3-绘制纹理三角形" aria-hidden="true">#</a> 1-3-绘制纹理三角形</h4><p>纹理三角形的绘制原理和纯色三角形一样，要用一套新的着色器建立一个新的程序对象，然后用这个新的程序对象进行绘图。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">drawTexture</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象，并应用 */</span>
  <span class="token keyword">const</span> textureVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;textureVertexShader&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;textureFragmentShader&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureVsSource<span class="token punctuation">,</span> textureFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token comment">// 顶点</span>
  <span class="token keyword">const</span> textureVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> texturePosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 图钉</span>
  <span class="token keyword">const</span> pins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pinBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pinBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pins<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Pin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 纹理</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="_1-4-同步绘图" tabindex="-1"><a class="header-anchor" href="#_1-4-同步绘图" aria-hidden="true">#</a> 1-4-同步绘图</h4><p>当纹理图形加载成功后，进行同步绘图。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha.jpg&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">drawSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">drawTexture</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>想给场景中的图形添加一个动画，比如想让纯色三角形不断的变换颜色。</p><p>首先要给纯色三角形的片元着色器开一个 uniform 变量。</p><p>然后接下来是不是就要不断修改这个 uniform 变量，然后执行上面的 drawSolid()和 drawTexture(image) 方法呢？</p><h3 id="_2-多着色器动画" tabindex="-1"><a class="header-anchor" href="#_2-多着色器动画" aria-hidden="true">#</a> 2-多着色器动画</h3><p>在上面的绘图方法中，很多操作都是不需要重复执行的，比如程序对象在建立之后，就不需要再建立了，后面在绘图的时候再接着用。</p><h4 id="_2-1-给纯色三角形添加一个代表时间的-uniform-变量" tabindex="-1"><a class="header-anchor" href="#_2-1-给纯色三角形添加一个代表时间的-uniform-变量" aria-hidden="true">#</a> 2-1-给纯色三角形添加一个代表时间的 uniform 变量</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
     uniform float u_Time<span class="token punctuation">;</span>
     <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       float r<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>u_Time<span class="token operator">/</span><span class="token number">200.0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
       gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_2-2-声明不需要重复获取变量" tabindex="-1"><a class="header-anchor" href="#_2-2-声明不需要重复获取变量" aria-hidden="true">#</a> 2-2-声明不需要重复获取变量</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> solidProgram<span class="token punctuation">,</span>
  solidVertexBuffer<span class="token punctuation">,</span>
  solidPosition<span class="token punctuation">,</span>
  solidTime <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> textureProgram<span class="token punctuation">,</span>
  textureVertexBuffer<span class="token punctuation">,</span>
  texturePosition <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pinBuffer<span class="token punctuation">,</span>
  pin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>程序对象、缓冲对象、从着色器中获取的 attribute 变量和 uniform 变量都是不需要重复获取的。</p><h4 id="_2-3-初始化方法" tabindex="-1"><a class="header-anchor" href="#_2-3-初始化方法" aria-hidden="true">#</a> 2-3-初始化方法</h4><ul><li>把绘制纯色三角形的方法变成初始化方法</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象*/</span>
  <span class="token keyword">const</span> solidVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidFragmentShader&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  solidProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> solidVsSource<span class="token punctuation">,</span> solidFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token keyword">const</span> solidVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  solidVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  solidPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>

  solidTime <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;u_Time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* gl.clear(gl.COLOR_BUFFER_BIT)
       gl.drawArrays(gl.TRIANGLES, 0, 3) */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>把绘制纹理三角形的方法变成初始化方法</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initTexture</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象，并应用 */</span>
  <span class="token keyword">const</span> textureVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;textureVertexShader&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;textureFragmentShader&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  textureProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureVsSource<span class="token punctuation">,</span> textureFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token comment">// 顶点</span>
  <span class="token keyword">const</span> textureVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  textureVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  texturePosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 图钉</span>
  <span class="token keyword">const</span> pins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pinBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pinBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pins<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Pin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 纹理</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// gl.drawArrays(gl.TRIANGLES, 0, 3)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>上面已经注释掉的是需要在绘图时重复执行的。</p><h4 id="_2-4-把需要重复执行的方法收集一下-用于连续渲染" tabindex="-1"><a class="header-anchor" href="#_2-4-把需要重复执行的方法收集一下-用于连续渲染" aria-hidden="true">#</a> 2-4-把需要重复执行的方法收集一下，用于连续渲染</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>solidTime<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pinBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>由上可知，在连续渲染时，必须要有的操作：</p><ul><li>clear() 清理画布</li><li>useProgram() 应用程序对象</li><li>bindBuffer() 绑定缓冲区对象</li><li>vertexAttribPointer() 告诉显卡从当前绑定的缓冲区（bindBuffer()指定的缓冲区）中读取顶点数据</li><li>drawArrays() 绘图方法</li></ul><p>若 attribute 变量、uniform 变量或者图片发生了变化，那就需要对其进行更新。</p><h4 id="_2-4-当纹理图像加载成功后-初始化绘图方法-连续绘图" tabindex="-1"><a class="header-anchor" href="#_2-4-当纹理图像加载成功后-初始化绘图方法-连续绘图" aria-hidden="true">#</a> 2-4-当纹理图像加载成功后，初始化绘图方法，连续绘图</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha.jpg&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">initSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initTexture</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/visual/assets/app.1a1d05a4.js" defer></script>
  </body>
</html>
